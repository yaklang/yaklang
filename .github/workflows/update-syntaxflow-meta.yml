name: Update Syntaxflow meta

on:
  workflow_call:
    inputs:
      update_version:
        description: "Version to update (e.g. 1.3.0-beta1)"
        required: true
        type: string
      update_last:
        description: "Update last syntaxflow meta or not"
        required: false
        type: boolean
  workflow_dispatch:
    inputs:
      update_version:
        description: "Version to update (e.g. 1.3.0-beta1)"
        type: string
        required: true
      update_last:
        description: "Update last syntaxflow meta or not"
        type: boolean
        default: false
  pull_request:
    branches: [ main ]
    types: [ opened, synchronize, reopened ]
    paths:
      - ".github/workflows/update-syntaxflow-meta.yml"
jobs:
  update-syntaxflow-meta:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repo
        uses: actions/checkout@v2

      - name: Get Yak binary Latest
        run: |
          echo "::group::Finding and downloading Yak binary"
          BIN_VERSION="${{ inputs.update_version}}"
          if [ -z "$BIN_VERSION" ]; then
            BIN_VERSION="latest"
          fi
          
          echo "Input version: $BIN_VERSION"
          
          # 检查 BIN_VERSION 是否以 yak_ 开头（全量版本）
          SELECTED_VERSION=""
          
          if echo "$BIN_VERSION" | grep -qE '^yak_'; then
            # 如果已经是以 yak_ 开头，直接使用
            SELECTED_VERSION="$BIN_VERSION"
            echo "✅ Input version is full version (starts with yak_): $SELECTED_VERSION"
          else
            # 如果不是以 yak_ 开头，从版本列表中查找以 yak_ 开头的版本，直接拿取最新版本
            echo "⚠️  Input version is not full version, searching for latest yak_* version..."
            
            VERSIONS_URL="https://aliyun-oss.yaklang.com/yak/version-info/active_versions.txt"
            if ! VERSIONS=$(curl -sS -L "$VERSIONS_URL" 2>/dev/null | grep -v '^$'); then
              echo "::error::Failed to fetch version list"
              exit 1
            fi
            
            echo "Debug: First 20 lines of version list:"
            echo "$VERSIONS" | head -n 20
            
            # 从最新到最旧挨个匹配第一个非 -yakit- 和 -irify- 的标签
            SELECTED_VERSION=""
            while IFS= read -r version; do
              # 检查是否包含 -yakit- 或 -irify-
              if ! echo "$version" | grep -qE -- '-yakit-|-irify-'; then
                SELECTED_VERSION="$version"
                echo "✅ Found latest full version: $SELECTED_VERSION"
                break
              fi
            done <<< "$VERSIONS"
            
            if [ -z "$SELECTED_VERSION" ]; then
              echo "::error::No full version found (all versions contain -yakit- or -irify-)"
              exit 1
            fi
          fi
          
          BINARY_NAME="yak_linux_amd64"
          DOWNLOAD_URL="https://aliyun-oss.yaklang.com/yak/${SELECTED_VERSION}/${BINARY_NAME}"
          echo "Downloading from: $DOWNLOAD_URL"
          
          if ! wget -q "$DOWNLOAD_URL" -O "$BINARY_NAME"; then
            echo "::error::Failed to download Yak binary from: $DOWNLOAD_URL"
            exit 1
          fi
          
          chmod +x "./$BINARY_NAME"
          echo "✅ Successfully downloaded: $BINARY_NAME"
          echo "::endgroup::"
          
          echo "::group::Verifying Yak binary"
          pwd && ls -lh yak_linux_amd64
          ./yak_linux_amd64 version
          echo "::endgroup::"

      - name: Get Repo tags
        run: |
          VERSION_INPUT="${{ inputs.update_version}}"
          if [ -z "$VERSION_INPUT" ]; then
            VERSION_INPUT="dev"
          fi 
          echo "YAK_TAG=$VERSION_INPUT" >> $GITHUB_ENV 

      - name: Checkout Tags Version
        run: echo ${{ env.YAK_TAG }}

      - name: Initialize Builtin SyntaxFlow Rules
        run: |
          echo "::group::Initialize Builtin SyntaxFlow Rules"
          echo "Syncing embedded rules to database..."
          ./yak_linux_amd64 sync-rule
          echo "Builtin rules initialized successfully"
          echo "::endgroup::"
          
      - name: Generate SyntaxFlow Meta Info
        run: |
          echo "::group::Generate SyntaxFlow Meta Info"
          
          echo "Current working directory: $(pwd)"
          echo "YAK_TAG version: ${{ env.YAK_TAG }}"


          echo "Downloading latest syntaxflow rule info..."
          wget -O syntaxflow-meta.json https://aliyun-oss.yaklang.com/yak/latest/syntaxflow-meta.json
          if [ $? -ne 0 ]; then
            echo "::error::Failed to download syntaxflow meta info, empty file will create it "
          fi
          
          if [ -f "scripts/summary-syntaxflow-meta.yak" ]; then
            echo "Using local syntaxflow meta info generator"
            cp scripts/summary-syntaxflow-meta.yak summary-syntaxflow-meta.yak
          else
            echo "Downloading syntaxflow meta info generator..."
            wget -O summary-syntaxflow-meta.yak https://aliyun-oss.yaklang.com/syntaxflow/summary-syntaxflow-meta.yak
            if [ $? -ne 0 ]; then
              echo "::error::Failed to download syntaxflow meta info generator"
              exit 1
            fi
          fi

          echo "Checking downloaded file..."
          ls -l  | grep syntaxflow
          
          echo "Generating meta info with yak script..."
          ./yak_linux_amd64 ./scripts/summary-syntaxflow-meta.yak \
            --output syntaxflow-meta.json \
            --version ${{ env.YAK_TAG }} \
            --custom-ai \
            --ai-type chatglm \
            --apikey ${{ secrets.CHATGLM_APIKEY }} \
            --ai-model glm-4-long \
            --concurrent 5 
          
          echo "Checking generated files..."
          ls -l | grep syntaxflow
          
          echo "Uploading to versioned OSS path..."
          ./yak_linux_amd64 upload-oss \
           -f "syntaxflow-meta.json:/yak/${{ env.YAK_TAG }}/syntaxflow-meta.json" \
           -ak ${{ secrets.OSS_KEY_ID }} \
           -sk ${{ secrets.OSS_KEY_SECRET }} \
           -t 5
          if [ $? -ne 0 ]; then
           echo "::warning::Failed to upload versioned meta info"
          fi
          
          if [ ${{ inputs.update_last }} == true ]; then
              echo "Uploading to latest OSS path..."
              ./yak_linux_amd64 upload-oss \
               -f "syntaxflow-meta.json:/yak/latest/syntaxflow-meta.json" \
               -ak ${{ secrets.OSS_KEY_ID }} \
               -sk ${{ secrets.OSS_KEY_SECRET }} \
               -t 5
              if [ $? -ne 0 ]; then
               echo "::warning::Failed to upload latest meta info"
              fi
          fi
          
          echo "::endgroup::"
        continue-on-error: true
      
      - name: Upload meta json 
        uses: actions/upload-artifact@v4
        with:
          name: grpc.log
          path: ${{github.workspace}}/syntaxflow-meta.json