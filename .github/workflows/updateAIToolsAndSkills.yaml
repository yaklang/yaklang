name: updateAIToolsAndSkills

on:
  workflow_dispatch:
  push:
    branches:
      - "aitool/*"
      - "feature/aitool*"
  schedule:
    # 定时任务，在每周三0点更新（与CVE周一、CWE周二错开）
    - cron: '0 0 * * 3'

jobs:

  update-ai-tools-skills:
    name: Update AI Tools and Skills
    runs-on: ubuntu-22.04

    steps:
      - name: Check out code into the Go module directory
        uses: actions/checkout@v2

      - name: Set up Go 1.x
        uses: actions/setup-go@v5
        with:
          go-version-file: "./go.mod"
          cache: false
        id: go

      - name: Init Module
        run: |
          go mod tidy

      - name: Build yak
        run: |
          go build -o ./yak ./common/yak/cmd/yak.go
          chmod +x ./yak

      - name: Create output directory
        run: mkdir -p $HOME/yakit-projects

      # =============================================================================
      # 版本号生成
      # =============================================================================

      - name: Get Yak Version and Generate Version Number
        run: |
          # 尝试获取 Yak 引擎版本号
          YAK_VERSION=$(./yak version 2>/dev/null | head -1 | grep -oE 'v[0-9]+\.[0-9]+\.[0-9]+[a-zA-Z0-9_-]*' | head -1 || echo "")
          
          if [ -n "$YAK_VERSION" ]; then
            # 移除 v 前缀
            VERSION="${YAK_VERSION#v}"
            echo "Using Yak engine version: $VERSION"
          else
            # 如果没有版本号，使用 日期-编译次数 格式
            DATE_STR=$(date +%Y%m%d)
            INDEX=1
            while true; do
              VERSION="${DATE_STR}-${INDEX}"
              CHECK_URL="https://yaklang.oss-accelerate.aliyuncs.com/rag/memfit-caps/${VERSION}/memfit-caps.rag.gz"
              HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" -I "$CHECK_URL" || echo "000")
              if [ "$HTTP_STATUS" = "404" ] || [ "$HTTP_STATUS" = "000" ]; then
                echo "Version $VERSION is available"
                break
              fi
              echo "Version $VERSION already exists, trying next index..."
              INDEX=$((INDEX + 1))
              if [ $INDEX -gt 100 ]; then
                echo "ERROR: Too many versions for today!"
                exit 1
              fi
            done
            echo "Using date-based version: $VERSION"
          fi
          
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Final version: $VERSION"
          
          # 准备上传目录
          RAG_OSS_DIR="/rag/memfit-caps/${VERSION}"
          echo "RAG_OSS_DIR=$RAG_OSS_DIR" >> $GITHUB_ENV

      # =============================================================================
      # 下载现有 RAG 文件用于增量更新
      # =============================================================================

      - name: Download existing RAG file (for incremental update)
        continue-on-error: true
        run: |
          # 尝试下载最新的 rags-latest.json 获取现有版本
          wget -q -O $HOME/yakit-projects/rags-latest.json https://yaklang.oss-accelerate.aliyuncs.com/rag/rags-latest.json || {
            echo "No existing rags-latest.json found, creating empty array"
            echo "[]" > $HOME/yakit-projects/rags-latest.json
          }
          
          # 验证 JSON 文件内容有效
          if ! jq empty $HOME/yakit-projects/rags-latest.json 2>/dev/null; then
            echo "Invalid JSON in rags-latest.json, creating empty array"
            echo "[]" > $HOME/yakit-projects/rags-latest.json
          fi
          
          # 如果存在有效内容，解析并下载现有的 AI Tools and Skills RAG
          if [ -f $HOME/yakit-projects/rags-latest.json ]; then
            # 提取 AI Tools and Skills 的文件路径
            CAPS_RAG_PATH=$(cat $HOME/yakit-projects/rags-latest.json | jq -r '.[] | select(.name == "AI Tools and Skills") | .file' 2>/dev/null || echo "")
            if [ -n "$CAPS_RAG_PATH" ] && [ "$CAPS_RAG_PATH" != "null" ]; then
              echo "Found existing AI Tools and Skills RAG at: $CAPS_RAG_PATH"
              wget -q -O $HOME/yakit-projects/memfit-caps-existing.rag.gz "https://yaklang.oss-accelerate.aliyuncs.com${CAPS_RAG_PATH}" || echo "Failed to download existing RAG"
              if [ -f $HOME/yakit-projects/memfit-caps-existing.rag.gz ]; then
                ./yak gzip -d -f $HOME/yakit-projects/memfit-caps-existing.rag.gz -o $HOME/yakit-projects/memfit-caps.rag || echo "Failed to decompress existing RAG"
              fi
            fi
          fi

      # =============================================================================
      # 构建 RAG 索引
      # =============================================================================

      - name: Build AI Tools and Skills RAG Index
        run: |
          echo "Building AI Tools and Skills RAG search index..."
          
          # 设置输出路径
          RAG_OUTPUT=$HOME/yakit-projects/memfit-caps.rag
          
          # 如果存在现有的 RAG 文件，使用增量更新模式
          if [ -f $HOME/yakit-projects/memfit-caps.rag ]; then
            echo "Using incremental update mode with existing RAG file"
          fi
          
          # 构建 RAG 索引（并发设置为 20）
          # 注意：不显式指定 AI 类型，使用默认的免费 AI 服务（与 cwe-rag.yak 一致）
          ./yak scripts/ci-works/rag/build-aitool-n-aiforge-search-index.yak \
            --output $RAG_OUTPUT \
            --concurrency 20
          
          # 验证 RAG 文件生成
          if [ ! -f $RAG_OUTPUT ]; then
            echo "ERROR: RAG file not created!"
            exit 1
          fi
          
          echo "RAG file created successfully"
          ls -la $RAG_OUTPUT

      # =============================================================================
      # 压缩并上传 RAG 文件
      # =============================================================================

      - name: Compress and Upload RAG files
        run: |
          RAG_FILE=$HOME/yakit-projects/memfit-caps.rag
          RAG_GZ_FILE=$HOME/yakit-projects/memfit-caps.rag.gz
          SHA256_FILE=$HOME/yakit-projects/memfit-caps.rag.gz.sha256.txt
          
          # 压缩 RAG 文件（yak gzip 生成 .gzip，需要重命名）
          echo "Compressing RAG file..."
          ./yak gzip -f $RAG_FILE
          mv ${RAG_FILE}.gzip $RAG_GZ_FILE
          
          # 验证压缩文件
          FILE_SIZE=$(stat -c%s "$RAG_GZ_FILE")
          echo "RAG file size: $FILE_SIZE bytes ($(echo "scale=2; $FILE_SIZE/1024/1024" | bc) MB)"
          
          # RAG 文件应该至少有 10KB（AI Tools/Forges 数据量可能比 CWE 小）
          SIZE_LIMIT=$((10 * 1024))
          if [ $FILE_SIZE -lt $SIZE_LIMIT ]; then
            echo "RAG file size is less than 10KB. Something might be wrong. Aborting."
            exit 1
          fi
          
          # 生成 SHA256 校验和
          echo "Generating SHA256 checksum..."
          SHA256_HASH=$(sha256sum $RAG_GZ_FILE | awk '{print $1}')
          echo "$SHA256_HASH" > $SHA256_FILE
          echo "SHA256: $SHA256_HASH"
          
          # 立即上传 RAG 文件
          echo "Uploading RAG files to OSS..."
          echo "Version: $VERSION"
          echo "OSS Directory: $RAG_OSS_DIR"
          
          # 上传 RAG 压缩文件
          echo "Uploading memfit-caps.rag.gz..."
          ./yak upload-oss \
            -b yaklang \
            --endpoint oss-accelerate.aliyuncs.com \
            -ak ${{ secrets.OSS_KEY_ID }} \
            -sk ${{ secrets.OSS_KEY_SECRET }} \
            -t 5 \
            -f "$RAG_GZ_FILE:${RAG_OSS_DIR}/memfit-caps.rag.gz"
          
          # 上传 SHA256 校验文件
          echo "Uploading memfit-caps.rag.gz.sha256.txt..."
          ./yak upload-oss \
            -b yaklang \
            --endpoint oss-accelerate.aliyuncs.com \
            -ak ${{ secrets.OSS_KEY_ID }} \
            -sk ${{ secrets.OSS_KEY_SECRET }} \
            -t 5 \
            -f "$SHA256_FILE:${RAG_OSS_DIR}/memfit-caps.rag.gz.sha256.txt"
          
          # 保存 SHA256 hash 供后续使用
          echo "SHA256_HASH=$SHA256_HASH" >> $GITHUB_ENV

      # =============================================================================
      # 更新 rags-latest.json
      # =============================================================================

      - name: Update rags-latest.json
        run: |
          echo "Updating rags-latest.json..."
          
          SHA256_VALUE=$(cat $HOME/yakit-projects/memfit-caps.rag.gz.sha256.txt)
          
          # 确保 rags-latest.json 存在
          if [ ! -f $HOME/yakit-projects/rags-latest.json ]; then
            echo "Creating empty rags-latest.json"
            echo "[]" > $HOME/yakit-projects/rags-latest.json
          fi
          
          # 使用 yak rag-metainfo 命令维护 rags-latest.json
          # 如果存在旧文件则更新，不存在则创建
          ./yak rag-metainfo \
            -f $HOME/yakit-projects/rags-latest.json \
            -o $HOME/yakit-projects/rags-latest.json \
            --register-name "AI Tools and Skills" \
            --register-name-zh "AI 工具与技能库" \
            --version "$VERSION" \
            --rag-file "/rag/memfit-caps/${VERSION}/memfit-caps.rag.gz" \
            --hash-file "/rag/memfit-caps/${VERSION}/memfit-caps.rag.gz.sha256.txt" \
            --hash "$SHA256_VALUE"
          
          echo "New rags-latest.json content:"
          cat $HOME/yakit-projects/rags-latest.json

      - name: Upload rags-latest.json to OSS
        run: |
          echo "Uploading rags-latest.json..."
          ./yak upload-oss \
            -b yaklang \
            --endpoint oss-accelerate.aliyuncs.com \
            -ak ${{ secrets.OSS_KEY_ID }} \
            -sk ${{ secrets.OSS_KEY_SECRET }} \
            -t 5 \
            -f "$HOME/yakit-projects/rags-latest.json:/rag/rags-latest.json"

      # =============================================================================
      # 验证上传
      # =============================================================================

      - name: Verify uploads
        run: |
          echo "Verifying uploads..."
          echo ""
          echo "=== RAG File ==="
          curl -I "https://yaklang.oss-accelerate.aliyuncs.com${RAG_OSS_DIR}/memfit-caps.rag.gz" | head -10
          echo ""
          echo "=== SHA256 File ==="
          curl -I "https://yaklang.oss-accelerate.aliyuncs.com${RAG_OSS_DIR}/memfit-caps.rag.gz.sha256.txt" | head -10
          echo ""
          echo "=== rags-latest.json ==="
          curl -s "https://yaklang.oss-accelerate.aliyuncs.com/rag/rags-latest.json" | jq .
          echo ""
          echo "=== Upload Summary ==="
          echo "Version: $VERSION"
          echo "RAG File: https://yaklang.oss-accelerate.aliyuncs.com${RAG_OSS_DIR}/memfit-caps.rag.gz"
          echo "SHA256 File: https://yaklang.oss-accelerate.aliyuncs.com${RAG_OSS_DIR}/memfit-caps.rag.gz.sha256.txt"
          echo "Index File: https://yaklang.oss-accelerate.aliyuncs.com/rag/rags-latest.json"

