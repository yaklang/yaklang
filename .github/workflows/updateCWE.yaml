name: updateCWE

on:
  workflow_dispatch:
  push:
    branches:
      - "cwe/*"
      - "feature/cwe*"
  schedule:
    # 定时任务，在每周二0点更新（与CVE周一更新错开）
    - cron: '0 0 * * 2'

jobs:

  update-cwe:
    name: Update CWE Database
    runs-on: ubuntu-22.04

    steps:
      - name: Check out code into the Go module directory
        uses: actions/checkout@v2

      - name: Set up Go 1.x
        uses: actions/setup-go@v5
        with:
          go-version-file: "./go.mod"
          cache: false
        id: go

      - name: Init Module
        run: |
          go mod tidy

      - name: Build yak
        run: |
          go build -o ./yak ./common/yak/cmd/yak.go
          chmod +x ./yak

      - name: Create output directory
        run: mkdir -p $HOME/yakit-projects

      - name: Download existing CWE data (if exists)
        continue-on-error: true
        run: |
          # 下载现有的 CWE 数据用于增量更新（路径与上传路径一致）
          wget -O $HOME/yakit-projects/cwe-data.jsonl.gz https://yaklang.oss-accelerate.aliyuncs.com/rag/cwe.jsonl.gz || echo "No existing CWE data found, will create new"
          if [ -f $HOME/yakit-projects/cwe-data.jsonl.gz ]; then
            gunzip -f $HOME/yakit-projects/cwe-data.jsonl.gz || echo "Failed to decompress, will create new"
          fi

      - name: Update CWE Database
        run: |
          # 使用 aibalance 类型和 memfit-standard-free 模型
          AI_OPTS="--ai-type aibalance --ai-model memfit-standard-free --ai-concurrent 20"
          
          if [ -f $HOME/yakit-projects/cwe-data.jsonl ]; then
            echo "Importing existing CWE data and updating..."
            ./yak scripts/ci-works/rag/cwe.yak \
              --input $HOME/yakit-projects/cwe-data.jsonl \
              --output $HOME/yakit-projects/cwe-data-new.jsonl \
              $AI_OPTS
          else
            echo "Creating new CWE database..."
            ./yak scripts/ci-works/rag/cwe.yak \
              --output $HOME/yakit-projects/cwe-data-new.jsonl \
              $AI_OPTS
          fi

      - name: Compress CWE data with gzip
        run: |
          mv $HOME/yakit-projects/cwe-data-new.jsonl $HOME/yakit-projects/cwe-data.jsonl
          # 使用 yak gzip 压缩（生成 .gzip 文件）
          ./yak gzip -f $HOME/yakit-projects/cwe-data.jsonl
          # 重命名为 .gz 扩展名
          mv $HOME/yakit-projects/cwe-data.jsonl.gzip $HOME/yakit-projects/cwe-data.jsonl.gz
          # 验证压缩结果
          ls -la $HOME/yakit-projects/cwe-data.jsonl*

      - name: Check CWE data file size and Upload
        run: |
          FILE_PATH=$HOME/yakit-projects/cwe-data.jsonl.gz
          FILE_SIZE=$(stat -c%s "$FILE_PATH")
          echo "CWE data file size: $FILE_SIZE bytes"
          
          SIZE_LIMIT=$((100 * 1024)) # 100KB size limit (CWE data is smaller than CVE)
          if [ $FILE_SIZE -lt $SIZE_LIMIT ]; then
            echo "File size is less than 100KB. Something might be wrong. Aborting."
            exit 1
          fi
          
          # 立即上传 JSONL 文件
          echo "Uploading CWE JSONL data to OSS..."
          ./yak upload-oss \
            -b yaklang \
            --endpoint oss-accelerate.aliyuncs.com \
            -ak ${{ secrets.OSS_KEY_ID }} \
            -sk ${{ secrets.OSS_KEY_SECRET }} \
            -t 5 \
            -f "$FILE_PATH:/rag/cwe.jsonl.gz"
          echo "CWE JSONL uploaded to /rag/cwe.jsonl.gz"

      # =============================================================================
      # RAG 构建部分
      # =============================================================================

      # 第一步：生成版本号
      - name: Generate Version
        run: |
          # 生成版本号: 日期-index
          DATE_STR=$(date +%Y%m%d)
          
          # 检查当天是否已有版本，确定 index
          INDEX=1
          while true; do
            VERSION="${DATE_STR}-${INDEX}"
            CHECK_URL="https://yaklang.oss-accelerate.aliyuncs.com/rag/cwe/${VERSION}/cwe.rag.gz"
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" -I "$CHECK_URL" || echo "000")
            if [ "$HTTP_STATUS" = "404" ] || [ "$HTTP_STATUS" = "000" ]; then
              echo "Version $VERSION is available"
              break
            fi
            echo "Version $VERSION already exists, trying next index..."
            INDEX=$((INDEX + 1))
            if [ $INDEX -gt 100 ]; then
              echo "ERROR: Too many versions for today!"
              exit 1
            fi
          done
          
          echo "Using version: $VERSION"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          
          # 准备上传目录
          RAG_OSS_DIR="/rag/cwe/${VERSION}"
          echo "RAG_OSS_DIR=$RAG_OSS_DIR" >> $GITHUB_ENV

      # 第二步：下载现有 RAG 文件用于增量更新
      - name: Download existing CWE RAG file (for incremental update)
        continue-on-error: true
        run: |
          # 尝试下载最新的 rags-latest.json 获取现有版本
          wget -q -O $HOME/yakit-projects/rags-latest.json https://yaklang.oss-accelerate.aliyuncs.com/rag/rags-latest.json || {
            echo "No existing rags-latest.json found, creating empty array"
            echo "[]" > $HOME/yakit-projects/rags-latest.json
          }
          
          # 验证 JSON 文件内容有效
          if ! jq empty $HOME/yakit-projects/rags-latest.json 2>/dev/null; then
            echo "Invalid JSON in rags-latest.json, creating empty array"
            echo "[]" > $HOME/yakit-projects/rags-latest.json
          fi
          
          # 如果存在有效内容，解析并下载现有的 CWE RAG
          if [ -f $HOME/yakit-projects/rags-latest.json ]; then
            # 提取 CWE 的文件路径
            CWE_RAG_PATH=$(cat $HOME/yakit-projects/rags-latest.json | jq -r '.[] | select(.name == "CWE KnowledgeBase") | .file' 2>/dev/null || echo "")
            if [ -n "$CWE_RAG_PATH" ] && [ "$CWE_RAG_PATH" != "null" ]; then
              echo "Found existing CWE RAG at: $CWE_RAG_PATH"
              wget -q -O $HOME/yakit-projects/cwe-existing.rag.gz "https://yaklang.oss-accelerate.aliyuncs.com${CWE_RAG_PATH}" || echo "Failed to download existing RAG"
              if [ -f $HOME/yakit-projects/cwe-existing.rag.gz ]; then
                ./yak gzip -d -f $HOME/yakit-projects/cwe-existing.rag.gz -o $HOME/yakit-projects/cwe-existing.rag || echo "Failed to decompress existing RAG"
              fi
            fi
          fi

      # 第三步：构建 RAG 索引
      - name: Build CWE RAG Index
        run: |
          echo "Building CWE RAG search index..."
          
          # 设置输出路径
          RAG_OUTPUT=$HOME/yakit-projects/cwe.rag
          
          # 如果存在现有的 RAG 文件，使用增量更新模式
          if [ -f $HOME/yakit-projects/cwe-existing.rag ]; then
            echo "Using incremental update mode with existing RAG file"
            cp $HOME/yakit-projects/cwe-existing.rag $RAG_OUTPUT
          fi
          
          # 构建 RAG 索引（并发设置为 20）
          ./yak scripts/ci-works/rag/cwe-rag.yak \
            --output $RAG_OUTPUT \
            --concurrency 20
          
          # 验证 RAG 文件生成
          if [ ! -f $RAG_OUTPUT ]; then
            echo "ERROR: RAG file not created!"
            exit 1
          fi
          
          echo "RAG file created successfully"
          ls -la $RAG_OUTPUT

      # 第四步：压缩 RAG 并生成 SHA256，然后立即上传
      - name: Compress and Upload RAG files
        run: |
          RAG_FILE=$HOME/yakit-projects/cwe.rag
          RAG_GZ_FILE=$HOME/yakit-projects/cwe.rag.gz
          SHA256_FILE=$HOME/yakit-projects/cwe.rag.gz.sha256.txt
          
          # 压缩 RAG 文件（yak gzip 生成 .gzip，需要重命名）
          echo "Compressing RAG file..."
          ./yak gzip -f $RAG_FILE
          mv ${RAG_FILE}.gzip $RAG_GZ_FILE
          
          # 验证压缩文件
          FILE_SIZE=$(stat -c%s "$RAG_GZ_FILE")
          echo "RAG file size: $FILE_SIZE bytes ($(echo "scale=2; $FILE_SIZE/1024/1024" | bc) MB)"
          
          # RAG 文件应该至少有 50KB
          SIZE_LIMIT=$((50 * 1024))
          if [ $FILE_SIZE -lt $SIZE_LIMIT ]; then
            echo "RAG file size is less than 50KB. Something might be wrong. Aborting."
            exit 1
          fi
          echo "RAG_FILE_SIZE=$FILE_SIZE" >> $GITHUB_ENV
          
          # 生成 SHA256 校验和
          echo "Generating SHA256 checksum..."
          SHA256_HASH=$(sha256sum $RAG_GZ_FILE | awk '{print $1}')
          echo "$SHA256_HASH" > $SHA256_FILE
          echo "SHA256: $SHA256_HASH"
          
          # 立即上传 RAG 文件
          echo "Uploading RAG files to OSS..."
          echo "Version: $VERSION"
          echo "OSS Directory: $RAG_OSS_DIR"
          
          # 上传 RAG 压缩文件
          echo "Uploading cwe.rag.gz..."
          ./yak upload-oss \
            -b yaklang \
            --endpoint oss-accelerate.aliyuncs.com \
            -ak ${{ secrets.OSS_KEY_ID }} \
            -sk ${{ secrets.OSS_KEY_SECRET }} \
            -t 5 \
            -f "$RAG_GZ_FILE:${RAG_OSS_DIR}/cwe.rag.gz"
          
          # 上传 SHA256 校验文件
          echo "Uploading cwe.rag.gz.sha256.txt..."
          ./yak upload-oss \
            -b yaklang \
            --endpoint oss-accelerate.aliyuncs.com \
            -ak ${{ secrets.OSS_KEY_ID }} \
            -sk ${{ secrets.OSS_KEY_SECRET }} \
            -t 5 \
            -f "$SHA256_FILE:${RAG_OSS_DIR}/cwe.rag.gz.sha256.txt"
          
          # 保存 SHA256 hash 供后续使用
          echo "SHA256_HASH=$SHA256_HASH" >> $GITHUB_ENV

      # =============================================================================
      # 更新 rags-latest.json
      # =============================================================================

      - name: Update rags-latest.json
        run: |
          echo "Updating rags-latest.json..."
          
          SHA256_VALUE=$(cat $HOME/yakit-projects/cwe.rag.gz.sha256.txt)
          
          # 确保 rags-latest.json 存在
          if [ ! -f $HOME/yakit-projects/rags-latest.json ]; then
            echo "Creating empty rags-latest.json"
            echo "[]" > $HOME/yakit-projects/rags-latest.json
          fi
          
          # 使用 yak rag-metainfo 命令维护 rags-latest.json
          # 如果存在旧文件则更新，不存在则创建
          ./yak rag-metainfo \
            -f $HOME/yakit-projects/rags-latest.json \
            -o $HOME/yakit-projects/rags-latest.json \
            --register-name "CWE KnowledgeBase" \
            --register-name-zh "CWE 知识库" \
            --version "$VERSION" \
            --rag-file "/rag/cwe/${VERSION}/cwe.rag.gz" \
            --hash-file "/rag/cwe/${VERSION}/cwe.rag.gz.sha256.txt" \
            --hash "$SHA256_VALUE" \
            --file-size "$RAG_FILE_SIZE"
          
          echo "New rags-latest.json content:"
          cat $HOME/yakit-projects/rags-latest.json

      - name: Upload rags-latest.json to OSS
        run: |
          echo "Uploading rags-latest.json..."
          ./yak upload-oss \
            -b yaklang \
            --endpoint oss-accelerate.aliyuncs.com \
            -ak ${{ secrets.OSS_KEY_ID }} \
            -sk ${{ secrets.OSS_KEY_SECRET }} \
            -t 5 \
            -f "$HOME/yakit-projects/rags-latest.json:/rag/rags-latest.json"

      - name: Verify uploads
        run: |
          echo "Verifying uploads..."
          echo ""
          echo "=== CWE JSONL File ==="
          curl -I "https://yaklang.oss-accelerate.aliyuncs.com/rag/cwe.jsonl.gz" | head -10
          echo ""
          echo "=== RAG File ==="
          curl -I "https://yaklang.oss-accelerate.aliyuncs.com${RAG_OSS_DIR}/cwe.rag.gz" | head -10
          echo ""
          echo "=== SHA256 File ==="
          curl -I "https://yaklang.oss-accelerate.aliyuncs.com${RAG_OSS_DIR}/cwe.rag.gz.sha256.txt" | head -10
          echo ""
          echo "=== rags-latest.json ==="
          curl -s "https://yaklang.oss-accelerate.aliyuncs.com/rag/rags-latest.json" | jq .
          echo ""
          echo "=== Upload Summary ==="
          echo "Version: $VERSION"
          echo "CWE JSONL: https://yaklang.oss-accelerate.aliyuncs.com/rag/cwe.jsonl.gz"
          echo "RAG File: https://yaklang.oss-accelerate.aliyuncs.com${RAG_OSS_DIR}/cwe.rag.gz"
          echo "SHA256 File: https://yaklang.oss-accelerate.aliyuncs.com${RAG_OSS_DIR}/cwe.rag.gz.sha256.txt"
          echo "Index File: https://yaklang.oss-accelerate.aliyuncs.com/rag/rags-latest.json"
