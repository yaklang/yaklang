name: updateCWE

on:
  workflow_dispatch:
  push:
    branches:
      - "cwe/*"
  schedule:
    # 定时任务，在每周二0点更新（与CVE周一更新错开）
    - cron: '0 0 * * 2'

jobs:

  update-cwe:
    name: Update CWE Database
    runs-on: ubuntu-22.04

    steps:
      - name: Check out code into the Go module directory
        uses: actions/checkout@v2

      - name: Set up Go 1.x
        uses: actions/setup-go@v5
        with:
          go-version-file: "./go.mod"
          cache: false
        id: go

      - name: Init Module
        run: |
          go mod tidy

      - name: Build yak
        run: |
          go build -o ./yak ./common/yak/cmd/yak.go
          chmod +x ./yak

      - name: Create output directory
        run: mkdir -p ~/yakit-projects

      - name: Download existing CWE data (if exists)
        continue-on-error: true
        run: |
          wget -O ~/yakit-projects/cwe-data.jsonl.gz https://yaklang.oss-accelerate.aliyuncs.com/cwe/cwe-data.jsonl.gz || echo "No existing CWE data found, will create new"
          if [ -f ~/yakit-projects/cwe-data.jsonl.gz ]; then
            gunzip -f ~/yakit-projects/cwe-data.jsonl.gz || echo "Failed to decompress, will create new"
          fi

      - name: Update CWE Database
        run: |
          if [ -f ~/yakit-projects/cwe-data.jsonl ]; then
            echo "Importing existing CWE data and updating..."
            ./yak scripts/ci-works/rag/cwe.yak \
              --input ~/yakit-projects/cwe-data.jsonl \
              --output ~/yakit-projects/cwe-data-new.jsonl \
              --ai-concurrent 10
          else
            echo "Creating new CWE database..."
            ./yak scripts/ci-works/rag/cwe.yak \
              --output ~/yakit-projects/cwe-data-new.jsonl \
              --ai-concurrent 10
          fi

      - name: Compress CWE data with gzip
        run: |
          mv ~/yakit-projects/cwe-data-new.jsonl ~/yakit-projects/cwe-data.jsonl
          ./yak gzip -f ~/yakit-projects/cwe-data.jsonl -o ~/yakit-projects/cwe-data.jsonl.gz

      - name: Check CWE data file size
        run: |
          FILE_PATH=~/yakit-projects/cwe-data.jsonl.gz
          FILE_SIZE=$(stat -c%s "$FILE_PATH")
          echo "CWE data file size: $FILE_SIZE bytes"
          
          SIZE_LIMIT=$((100 * 1024)) # 100KB size limit (CWE data is smaller than CVE)
          if [ $FILE_SIZE -lt $SIZE_LIMIT ]; then
            echo "File size is less than 100KB. Something might be wrong. Aborting."
            exit 1
          fi

      # =============================================================================
      # RAG 构建部分
      # =============================================================================

      - name: Download existing CWE RAG file (for incremental update)
        continue-on-error: true
        run: |
          # 尝试下载最新的 rags-latest.json 获取现有版本
          wget -q -O ~/yakit-projects/rags-latest.json https://yaklang.oss-accelerate.aliyuncs.com/rag/rags-latest.json || echo "No existing rags-latest.json found"
          
          # 如果存在，解析并下载现有的 CWE RAG
          if [ -f ~/yakit-projects/rags-latest.json ]; then
            # 提取 CWE 的文件路径
            CWE_RAG_PATH=$(cat ~/yakit-projects/rags-latest.json | jq -r '.[] | select(.name == "CWE KnowledgeBase") | .file' 2>/dev/null || echo "")
            if [ -n "$CWE_RAG_PATH" ] && [ "$CWE_RAG_PATH" != "null" ]; then
              echo "Found existing CWE RAG at: $CWE_RAG_PATH"
              wget -q -O ~/yakit-projects/cwe-existing.rag.gz "https://yaklang.oss-accelerate.aliyuncs.com${CWE_RAG_PATH}" || echo "Failed to download existing RAG"
              if [ -f ~/yakit-projects/cwe-existing.rag.gz ]; then
                gunzip -c ~/yakit-projects/cwe-existing.rag.gz > ~/yakit-projects/cwe-existing.rag || echo "Failed to decompress existing RAG"
              fi
            fi
          fi

      - name: Build CWE RAG Index
        run: |
          echo "Building CWE RAG search index..."
          
          # 设置输出路径
          RAG_OUTPUT=~/yakit-projects/cwe.rag
          
          # 如果存在现有的 RAG 文件，使用增量更新模式
          if [ -f ~/yakit-projects/cwe-existing.rag ]; then
            echo "Using incremental update mode with existing RAG file"
            cp ~/yakit-projects/cwe-existing.rag $RAG_OUTPUT
          fi
          
          # 构建 RAG 索引
          ./yak scripts/ci-works/rag/cwe-rag.yak \
            --output $RAG_OUTPUT \
            --concurrency 5
          
          # 验证 RAG 文件生成
          if [ ! -f $RAG_OUTPUT ]; then
            echo "ERROR: RAG file not created!"
            exit 1
          fi
          
          echo "RAG file created successfully"
          ls -la $RAG_OUTPUT

      - name: Compress RAG and Generate SHA256
        run: |
          RAG_FILE=~/yakit-projects/cwe.rag
          RAG_GZ_FILE=~/yakit-projects/cwe.rag.gz
          SHA256_FILE=~/yakit-projects/cwe.rag.gz.sha256.txt
          
          # 压缩 RAG 文件
          echo "Compressing RAG file..."
          ./yak gzip -f $RAG_FILE -o $RAG_GZ_FILE
          
          # 生成 SHA256 校验和
          echo "Generating SHA256 checksum..."
          sha256sum $RAG_GZ_FILE | awk '{print $1}' > $SHA256_FILE
          
          echo "RAG compressed file: $(ls -la $RAG_GZ_FILE)"
          echo "SHA256: $(cat $SHA256_FILE)"

      - name: Check RAG file size
        run: |
          FILE_PATH=~/yakit-projects/cwe.rag.gz
          FILE_SIZE=$(stat -c%s "$FILE_PATH")
          echo "RAG file size: $FILE_SIZE bytes ($(echo "scale=2; $FILE_SIZE/1024/1024" | bc) MB)"
          
          # RAG 文件应该至少有 50KB
          SIZE_LIMIT=$((50 * 1024))
          if [ $FILE_SIZE -lt $SIZE_LIMIT ]; then
            echo "RAG file size is less than 50KB. Something might be wrong. Aborting."
            exit 1
          fi

      - name: Generate Version
        run: |
          # 生成版本号: 日期-index
          DATE_STR=$(date +%Y%m%d)
          
          # 检查当天是否已有版本，确定 index
          INDEX=1
          while true; do
            VERSION="${DATE_STR}-${INDEX}"
            CHECK_URL="https://yaklang.oss-accelerate.aliyuncs.com/rag/cwe/${VERSION}/cwe.rag.gz"
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" -I "$CHECK_URL" || echo "000")
            if [ "$HTTP_STATUS" = "404" ] || [ "$HTTP_STATUS" = "000" ]; then
              echo "Version $VERSION is available"
              break
            fi
            echo "Version $VERSION already exists, trying next index..."
            INDEX=$((INDEX + 1))
            if [ $INDEX -gt 100 ]; then
              echo "ERROR: Too many versions for today!"
              exit 1
            fi
          done
          
          echo "Using version: $VERSION"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          
          # 准备上传目录
          RAG_OSS_DIR="/rag/cwe/${VERSION}"
          echo "RAG_OSS_DIR=$RAG_OSS_DIR" >> $GITHUB_ENV

      # =============================================================================
      # 统一上传到 yaklang bucket (oss-accelerate.aliyuncs.com)
      # =============================================================================

      - name: Upload CWE data to yaklang OSS
        run: |
          echo "Uploading CWE data to yaklang OSS..."
          ./yak upload-oss \
            -b yaklang \
            --endpoint oss-accelerate.aliyuncs.com \
            -ak ${{ secrets.OSS_KEY_ID }} \
            -sk ${{ secrets.OSS_KEY_SECRET }} \
            -t 5 \
            -f "~/yakit-projects/cwe-data.jsonl.gz:/cwe/cwe-data.jsonl.gz"

      - name: Upload RAG files to yaklang OSS
        run: |
          echo "Uploading RAG files to yaklang OSS..."
          echo "Version: $VERSION"
          echo "OSS Directory: $RAG_OSS_DIR"
          
          # 上传 RAG 压缩文件
          echo "Uploading cwe.rag.gz..."
          ./yak upload-oss \
            -b yaklang \
            --endpoint oss-accelerate.aliyuncs.com \
            -ak ${{ secrets.OSS_KEY_ID }} \
            -sk ${{ secrets.OSS_KEY_SECRET }} \
            -t 5 \
            -f "~/yakit-projects/cwe.rag.gz:${RAG_OSS_DIR}/cwe.rag.gz"
          
          # 上传 SHA256 校验文件
          echo "Uploading cwe.rag.gz.sha256.txt..."
          ./yak upload-oss \
            -b yaklang \
            --endpoint oss-accelerate.aliyuncs.com \
            -ak ${{ secrets.OSS_KEY_ID }} \
            -sk ${{ secrets.OSS_KEY_SECRET }} \
            -t 5 \
            -f "~/yakit-projects/cwe.rag.gz.sha256.txt:${RAG_OSS_DIR}/cwe.rag.gz.sha256.txt"

      - name: Update rags-latest.json
        run: |
          echo "Updating rags-latest.json..."
          
          SHA256_VALUE=$(cat ~/yakit-projects/cwe.rag.gz.sha256.txt)
          
          # 如果存在旧的 rags-latest.json，更新它；否则创建新的
          if [ -f ~/yakit-projects/rags-latest.json ]; then
            # 读取现有的 JSON，移除旧的 CWE 条目，添加新的
            cat ~/yakit-projects/rags-latest.json | jq --arg version "$VERSION" --arg sha256 "$SHA256_VALUE" '
              [.[] | select(.name != "CWE KnowledgeBase")] + 
              [{
                "name": "CWE KnowledgeBase",
                "name_zh": "CWE 知识库",
                "version": $version,
                "file": "/rag/cwe/\($version)/cwe.rag.gz",
                "hashfile": "/rag/cwe/\($version)/cwe.rag.gz.sha256.txt",
                "hashtype": "sha256",
                "hash": $sha256
              }]
            ' > ~/yakit-projects/rags-latest-new.json
          else
            # 创建新的 JSON
            cat > ~/yakit-projects/rags-latest-new.json << EOF
          [
            {
              "name": "CWE KnowledgeBase",
              "name_zh": "CWE 知识库",
              "version": "$VERSION",
              "file": "/rag/cwe/$VERSION/cwe.rag.gz",
              "hashfile": "/rag/cwe/$VERSION/cwe.rag.gz.sha256.txt",
              "hashtype": "sha256",
              "hash": "$SHA256_VALUE"
            }
          ]
          EOF
          fi
          
          mv ~/yakit-projects/rags-latest-new.json ~/yakit-projects/rags-latest.json
          
          echo "New rags-latest.json content:"
          cat ~/yakit-projects/rags-latest.json | jq .

      - name: Upload rags-latest.json to OSS
        run: |
          echo "Uploading rags-latest.json..."
          ./yak upload-oss \
            -b yaklang \
            --endpoint oss-accelerate.aliyuncs.com \
            -ak ${{ secrets.OSS_KEY_ID }} \
            -sk ${{ secrets.OSS_KEY_SECRET }} \
            -t 5 \
            -f "~/yakit-projects/rags-latest.json:/rag/rags-latest.json"

      - name: Verify uploads
        run: |
          echo "Verifying uploads..."
          echo ""
          echo "=== CWE Data File ==="
          curl -I "https://yaklang.oss-accelerate.aliyuncs.com/cwe/cwe-data.jsonl.gz" | head -10
          echo ""
          echo "=== RAG File ==="
          curl -I "https://yaklang.oss-accelerate.aliyuncs.com${RAG_OSS_DIR}/cwe.rag.gz" | head -10
          echo ""
          echo "=== SHA256 File ==="
          curl -I "https://yaklang.oss-accelerate.aliyuncs.com${RAG_OSS_DIR}/cwe.rag.gz.sha256.txt" | head -10
          echo ""
          echo "=== rags-latest.json ==="
          curl -s "https://yaklang.oss-accelerate.aliyuncs.com/rag/rags-latest.json" | jq .
          echo ""
          echo "=== Upload Summary ==="
          echo "Version: $VERSION"
          echo "CWE Data: https://yaklang.oss-accelerate.aliyuncs.com/cwe/cwe-data.jsonl.gz"
          echo "RAG File: https://yaklang.oss-accelerate.aliyuncs.com${RAG_OSS_DIR}/cwe.rag.gz"
          echo "SHA256 File: https://yaklang.oss-accelerate.aliyuncs.com${RAG_OSS_DIR}/cwe.rag.gz.sha256.txt"
          echo "Index File: https://yaklang.oss-accelerate.aliyuncs.com/rag/rags-latest.json"
