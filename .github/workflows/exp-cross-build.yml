name: Cross-Build

on:
  pull_request:
    paths:
      - '.github/workflows/exp-cross-build.yml'
  push:
    tags:
      - "v*"

jobs:
  build:
    strategy:
      matrix:
        os:
          - windows
          - macos-amd64 
          - macos-arm64
          - linux-amd64
          - linux-arm64
    uses: ./.github/workflows/reuse-build.yml
    with:
      os: ${{ matrix.os }}
      ee: true
    secrets: inherit
  release:
    needs: build
    if: ${{ startsWith(github.ref, 'refs/tags/v') }}
    runs-on: ubuntu-20.04
    steps:
      - name: Upload To aliyun-oss(MacOS)
        uses: tvrcgo/upload-to-oss@master
        if: runner.os == 'macOS'
        with:
          key-id: ${{ secrets.OSS_KEY_ID }}
          key-secret: ${{ secrets.OSS_KEY_SECRET }}
          region: oss-accelerate
          bucket: yaklang
          assets: |
            yak_darwin_amd64:/yak/_/${{ steps.fetchtag_release.outputs.value }}/yak_darwin_amd64
            yak_darwin_arm64:/yak/_/${{ steps.fetchtag_release.outputs.value }}/yak_darwin_arm64
            yak_linux_arm64:/yak/_/${{ steps.fetchtag_release.outputs.value }}/yak_linux_arm64
            yak_linux_amd64:/yak/_/${{ steps.fetchtag_release.outputs.value }}/yak_linux_amd64

      - name: Upload To aliyun-oss(Windows)
        uses: tvrcgo/upload-to-oss@master
        if: runner.os == 'Windows'
        with:
          key-id: ${{ secrets.OSS_KEY_ID }}
          key-secret: ${{ secrets.OSS_KEY_SECRET }}
          region: oss-accelerate
          bucket: yaklang
          assets: |
            yak_windows_amd64.exe:/yak/_/${{ steps.fetchtag_release.outputs.value }}/yak_windows_amd64.exe