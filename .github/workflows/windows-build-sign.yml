name: Windows Build (Optional Sign)

on:
  workflow_dispatch:
    inputs:
      os:
        description: "Windows build target"
        required: true
        type: choice
        default: windows
        options:
          - windows
          - windows7
      sign:
        description: "Sign the built .exe with Azure Key Vault"
        required: true
        type: boolean
        default: false

permissions:
  contents: read

jobs:
  build:
    uses: ./.github/workflows/reuse-build.yml
    with:
      os: ${{ inputs.os }}
      ee: false
    secrets: inherit

  sign:
    needs: build
    if: ${{ inputs.sign }}
    runs-on: windows-latest
    env:
      AZURE_YAK_CODE_SIGN_KEY_VAULT_URI: ${{ secrets.AZURE_YAK_CODE_SIGN_KEY_VAULT_URI }}
      AZURE_YAK_CODE_SIGN_KEY_VAULT_APPLICATION_ID: ${{ secrets.AZURE_YAK_CODE_SIGN_KEY_VAULT_APPLICATION_ID }}
      AZURE_YAK_CODE_SIGN_KEY_VAULT_DIRECTORY_ID: ${{ secrets.AZURE_YAK_CODE_SIGN_KEY_VAULT_DIRECTORY_ID }}
      AZURE_YAK_CODE_SIGN_KEY_VAULT_CLIENT_SECRET: ${{ secrets.AZURE_YAK_CODE_SIGN_KEY_VAULT_CLIENT_SECRET }}
      AZURE_YAK_CODE_SIGN_KEY_VAULT_CERT_NAME: ${{ secrets.AZURE_YAK_CODE_SIGN_KEY_VAULT_CERT_NAME }}
      AZURE_YAK_CODE_SIGN_KEY_VAULT_TIMESTAMP_URL: ${{ secrets.AZURE_YAK_CODE_SIGN_KEY_VAULT_TIMESTAMP_URL }}
    steps:
      - name: Determine artifact name
        id: determine
        shell: pwsh
        run: |
          $exeName = if ("${{ inputs.os }}" -eq "windows7") { "yak_windows_legacy_amd64.exe" } else { "yak_windows_amd64.exe" }
          "exe_name=$exeName" >> $env:GITHUB_OUTPUT

      - name: Download unsigned artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ steps.determine.outputs.exe_name }}
          path: dist

      - name: Locate executable
        id: locate
        shell: pwsh
        run: |
          $exe = Get-ChildItem -Path dist -Recurse -Filter "${{ steps.determine.outputs.exe_name }}" | Select-Object -First 1
          if (-not $exe) { throw "Executable not found under dist: ${{ steps.determine.outputs.exe_name }}" }
          "exe_path=$($exe.FullName)" >> $env:GITHUB_OUTPUT

      - name: Validate signing secrets
        shell: pwsh
        run: |
          $missing = @()
          if (-not $env:AZURE_YAK_CODE_SIGN_KEY_VAULT_URI) { $missing += "AZURE_YAK_CODE_SIGN_KEY_VAULT_URI" }
          if (-not $env:AZURE_YAK_CODE_SIGN_KEY_VAULT_APPLICATION_ID) { $missing += "AZURE_YAK_CODE_SIGN_KEY_VAULT_APPLICATION_ID" }
          if (-not $env:AZURE_YAK_CODE_SIGN_KEY_VAULT_DIRECTORY_ID) { $missing += "AZURE_YAK_CODE_SIGN_KEY_VAULT_DIRECTORY_ID" }
          if (-not $env:AZURE_YAK_CODE_SIGN_KEY_VAULT_CLIENT_SECRET) { $missing += "AZURE_YAK_CODE_SIGN_KEY_VAULT_CLIENT_SECRET" }
          if (-not $env:AZURE_YAK_CODE_SIGN_KEY_VAULT_CERT_NAME) { $missing += "AZURE_YAK_CODE_SIGN_KEY_VAULT_CERT_NAME" }
          if (-not $env:AZURE_YAK_CODE_SIGN_KEY_VAULT_TIMESTAMP_URL) { $missing += "AZURE_YAK_CODE_SIGN_KEY_VAULT_TIMESTAMP_URL" }
          if ($missing.Count -gt 0) {
            throw ("Missing required secrets: " + ($missing -join ", "))
          }

      - name: Set up .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Install AzureSignTool
        shell: pwsh
        run: |
          dotnet tool install --global AzureSignTool
          "$env:USERPROFILE\\.dotnet\\tools" >> $env:GITHUB_PATH
          AzureSignTool --version

      - name: Sign executable with Azure Key Vault
        shell: pwsh
        env:
          EXE_PATH: ${{ steps.locate.outputs.exe_path }}
        run: |
          AzureSignTool sign `
            -kvu "$env:AZURE_YAK_CODE_SIGN_KEY_VAULT_URI" `
            -kvi "$env:AZURE_YAK_CODE_SIGN_KEY_VAULT_APPLICATION_ID" `
            -kvt "$env:AZURE_YAK_CODE_SIGN_KEY_VAULT_DIRECTORY_ID" `
            -kvs "$env:AZURE_YAK_CODE_SIGN_KEY_VAULT_CLIENT_SECRET" `
            -kvc "$env:AZURE_YAK_CODE_SIGN_KEY_VAULT_CERT_NAME" `
            -tr "$env:AZURE_YAK_CODE_SIGN_KEY_VAULT_TIMESTAMP_URL" `
            -td sha256 `
            -v `
            "$env:EXE_PATH"

      - name: Verify signature
        shell: pwsh
        env:
          EXE_PATH: ${{ steps.locate.outputs.exe_path }}
        run: |
          Get-AuthenticodeSignature -FilePath "$env:EXE_PATH" | Format-List

      - name: Generate SHA256
        shell: pwsh
        env:
          EXE_PATH: ${{ steps.locate.outputs.exe_path }}
          EXE_NAME: ${{ steps.determine.outputs.exe_name }}
        run: |
          $hash = (Get-FileHash -Algorithm SHA256 -Path "$env:EXE_PATH").Hash.ToLowerInvariant()
          $line = "$hash  $env:EXE_NAME"
          $out = Join-Path -Path (Split-Path -Parent "$env:EXE_PATH") -ChildPath "$env:EXE_NAME.sha256.txt"
          $line | Out-File -FilePath $out -Encoding ascii
          "SHA256_PATH=$out" >> $env:GITHUB_ENV

      - name: Upload signed executable
        uses: actions/upload-artifact@v4
        with:
          name: signed-${{ steps.determine.outputs.exe_name }}
          path: ${{ steps.locate.outputs.exe_path }}
          retention-days: 30

      - name: Upload SHA256
        uses: actions/upload-artifact@v4
        with:
          name: signed-${{ steps.determine.outputs.exe_name }}.sha256.txt
          path: ${{ env.SHA256_PATH }}
          retention-days: 30
