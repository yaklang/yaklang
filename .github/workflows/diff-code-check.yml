name: Diff-Code-Check
on:
  workflow_run:
    workflows: [ "Essential Tests" ]
    types:
      - completed
  pull_request:
    branches: [main]
    types: [ opened, synchronize, reopened ]
    paths:
      - "go.mod"
      - ".github/workflows/diff-code-check.yml"
      - ".github/workflows/security-comment-simple.yml"
      - ".github/actions/security-commenter/action.yml"
      - "common/ssa_bootstrapping/ci_rule/**"
      - "common/syntaxflow/sfbuildin/buildin/golang/**"
      - "scripts/ssa-risk-tools/**"
jobs:
  setup:
    runs-on: ubuntu-22.04
    if: ${{ (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') || (github.event_name == 'pull_request') }}
    permissions:
      contents: read
      pull-requests: write
      issues: write
      checks: write
      actions: read
    steps:
      - name: Debug trigger conditions
        run: |
          echo "=== Debug Information ==="
          echo "Event name: ${{ github.event_name }}"
          echo "Repository: ${{ github.repository }}"
          echo "Ref: ${{ github.ref }}"
          echo "Head ref: ${{ github.head_ref }}"
          echo "Base ref: ${{ github.base_ref }}"
          if [ "${{ github.event_name }}" == "workflow_run" ]; then
            echo "Workflow run conclusion: ${{ github.event.workflow_run.conclusion }}"
            echo "Workflow run head sha: ${{ github.event.workflow_run.head_sha }}"
            echo "Workflow run pull requests: ${{ github.event.workflow_run.pull_requests }}"
          elif [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "Pull request number: ${{ github.event.pull_request.number }}"
            echo "Pull request head sha: ${{ github.event.pull_request.head.sha }}"
            echo "Pull request base sha: ${{ github.event.pull_request.base.sha }}"
          fi
          echo "========================="

      - name: Init HEAD_SHA
        run: | 
          if [ "${{ github.event_name }}" == "workflow_run" ]; then
            echo "HEAD_SHA=${{ github.event.workflow_run.head_sha }}" >> $GITHUB_ENV
          elif [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "HEAD_SHA=${{ github.event.pull_request.head.sha }}" >> $GITHUB_ENV
          else
            echo "Unsupported event: ${{ github.event_name }}"
            exit 1
          fi
          echo "Current head sha is: ${{ env.HEAD_SHA }}"

      - name: Init PR_NUMBER
        run: |
          if [ "${{ github.event_name }}" == "workflow_run" ]; then
            # æ£€æŸ¥æ˜¯å¦æœ‰ pull_requests æ•°æ®
            if [ "${{ github.event.workflow_run.pull_requests }}" != "[]" ] && [ "${{ github.event.workflow_run.pull_requests }}" != "null" ]; then
              echo "PR_NUMBER=${{ github.event.workflow_run.pull_requests[0].number }}" >> $GITHUB_ENV
            else
              echo "PR_NUMBER=0" >> $GITHUB_ENV
              echo "Warning: No pull requests found in workflow_run event"
            fi
          elif [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "PR_NUMBER=${{ github.event.pull_request.number }}" >> $GITHUB_ENV
          else
            echo "PR_NUMBER=0" >> $GITHUB_ENV
          fi
          echo "Current PR number is: ${{ env.PR_NUMBER }}"

      - name: Cache YakLang Project
        uses: actions/cache@v3
        id: cache-project
        with:
          path: |
            ~/yakit-projects
            ${{ github.workspace }}
          key: go-${{ env.HEAD_SHA }}

      - name: Check out code into the Go module directory
        if: steps.cache-project.outputs.cache-hit != 'true'
        uses: actions/checkout@v3
        with:
          ref: ${{ env.HEAD_SHA }}
          fetch-depth: 0

      - name: Fetch Main And Reset Main
        if: steps.cache-project.outputs.cache-hit != 'true'
        run: |
          git fetch --all
          git checkout main
          git reset --hard origin/main
          git checkout ${{ env.HEAD_SHA }}

      - name: Set up Go 1.x
        if: steps.cache-project.outputs.cache-hit != 'true'
        uses: actions/setup-go@v5
        with:
          go-version-file: "./go.mod"
        id: go

      #      - name: Download From oos
      #        run: |
      #          wget https://aliyun-oss.yaklang.com/yak/latest/yak_linux_amd64
      #          chmod +x ./yak_linux_amd64

      - name: Init Module
        if: steps.cache-project.outputs.cache-hit != 'true'
        run: |
          go mod tidy && go work vendor
          ls -la $(go env GOPATH)/pkg/mod/$(go list -m github.com/yaklang/pcap | sed 's/ /@/')/libpcap
          chmod +r $(go env GOPATH)/pkg/mod/$(go list -m github.com/yaklang/pcap | sed 's/ /@/')/libpcap
          cp -r $(go env GOPATH)/pkg/mod/$(go list -m github.com/yaklang/pcap | sed 's/ /@/')/libpcap ./vendor/github.com/yaklang/pcap/
          tree ./vendor

      - name: Init Project
        if: steps.cache-project.outputs.cache-hit != 'true'
        env: 
          SKIP_SYNC_EMBED_RULE_IN_GITHUB: "true"
        run: |
          go build common/yak/cmd/yak.go 
          ./yak --help

      - name: Generate Prog
        run: |
          pwd && ls -al
          ./yak sf-import --file common/ssa_bootstrapping/ci_rule/ --format raw
          MERGE_BASE=$(git merge-base main ${{ env.HEAD_SHA }})
          echo "Merge base is: $MERGE_BASE"
          echo "Head base is: ${{ env.HEAD_SHA }}"
          ./yak gitefs --start $MERGE_BASE --end ${{ env.HEAD_SHA }} --output ./fs.zip 

      - name: Upload fs.zip
        uses: actions/upload-artifact@v4
        with:
          name: fs.zip
          path: fs.zip

      - name: Check With SyntaxFlow
        id: scan
        run: |
          ./yak code-scan -t ./fs.zip -l golang --rule-keyword golang --format irify -o risk --memory --log-level debug --exclude-file **/vendor/**,vendor/**,**/classes/**,**/target/**,**include/**,**caches/**,**cache/**,**tmp/**,**alipay/**,**includes/**,**temp/**,**zh_cn/**,**zh_en/**,**plugins/**,**PHPExcel/**,*.pb.go
          NUM=$(cat risk.json | jq .RiskNums)
          echo "Find risk num is: $NUM"
          echo "risk_count=$NUM" >> $GITHUB_OUTPUT
          if [ $NUM == 0 ]; then
            echo "success" 
            echo "scan_result=success" >> $GITHUB_OUTPUT
          else
            echo "fail"
            echo "scan_result=failure" >> $GITHUB_OUTPUT
          fi
        # Get-Content risk.json -Encoding UTF8 | jq .RiskNums

      - name: Set up Python for commenting
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml requests

      - name: Set GitHub Token
        id: set_token
        run: |
          echo "Using GITHUB_TOKEN"
          echo "token=${{ secrets.GITHUB_TOKEN }}" >> $GITHUB_OUTPUT
          echo "token_type=default" >> $GITHUB_OUTPUT
          echo "Event type: ${{ github.event_name }}"

      # - name: Call Security Scan and Comment (GitHub App)
      #   if: steps.scan.outputs.scan_result == 'failure'
      #   uses: ./.github/workflows/security-scan-comment.yml
      #   with:
      #     head_sha: ${{ env.HEAD_SHA }}
      #     pr_number: ${{ env.PR_NUMBER }}
      #   secrets:
      #     GITHUB_APP_ID: ${{ secrets.GITHUB_APP_ID }}
      #     GITHUB_APP_PRIVATE_KEY: ${{ secrets.GITHUB_APP_PRIVATE_KEY }}

      # - name: Call Security Comment (Community Action)
      #   if: steps.scan.outputs.scan_result == 'failure'
      #   uses: ./.github/workflows/security-comment-community.yml
      #   with:
      #     head_sha: ${{ env.HEAD_SHA }}
      #     pr_number: ${{ env.PR_NUMBER }}
      #   secrets:
      #     GITHUB_TOKEN: ${{ steps.set_token.outputs.token }}

      - name: Test Token Permissions
        id: test_token
        run: |
          echo "Testing token permissions..."
          # æµ‹è¯•ä»“åº“è®¿é—®æƒé™è€Œä¸æ˜¯ç”¨æˆ·æƒé™
          response=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }})
          echo "Repository API HTTP Status: $response"
          
          # æµ‹è¯• PR è®¿é—®æƒé™
          pr_response=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/pulls/${{ env.PR_NUMBER }})
          echo "PR API HTTP Status: $pr_response"
          
          if [ "$response" = "200" ] && [ "$pr_response" = "200" ]; then
            echo "has_permissions=true" >> $GITHUB_OUTPUT
            echo "Token has sufficient permissions for repository and PR access"
          else
            echo "has_permissions=false" >> $GITHUB_OUTPUT
            echo "Token lacks sufficient permissions (Repo: $response, PR: $pr_response)"
          fi

      - name: Debug File Paths
        if: steps.scan.outputs.scan_result == 'failure'
        run: |
          echo "=== Debug File Paths ==="
          echo "Current working directory: $(pwd)"
          echo "GitHub workspace: ${{ github.workspace }}"
          echo "Risk JSON path: ./risk.json"
          echo "Config path: ${{ github.workspace }}/.github/github-commenter.yml"
          echo "Checking if files exist:"
          ls -la ./risk.json || echo "risk.json not found"
          ls -la ${{ github.workspace }}/.github/github-commenter.yml || echo "config file not found"
          echo "========================="

      - name: Skip Security Comment (Insufficient Permissions)
        if: steps.scan.outputs.scan_result == 'failure' && steps.test_token.outputs.has_permissions == 'false'
        run: |
          echo "âš ï¸ Skipping security comment due to insufficient token permissions"
          echo "Consider configuring GitHub App secrets for better permissions in workflow_run events"

      - name: Generate security report
        id: report
        if: steps.scan.outputs.scan_result == 'failure' && steps.test_token.outputs.has_permissions == 'true' && env.PR_NUMBER != '' && env.PR_NUMBER != '0'
        run: |
          if [ ! -f "./risk.json" ]; then
            echo "âŒ Risk file not found: ./risk.json"
            exit 1
          fi
          
          # æ£€æŸ¥ AWK è„šæœ¬æ˜¯å¦å­˜åœ¨
          if [ ! -f "scripts/ssa-risk-tools/extract-risks.awk" ]; then
            echo "âŒ AWK script not found: scripts/ssa-risk-tools/extract-risks.awk"
            exit 1
          fi
          
          # æ¸…ç†æ—§çš„ results ç›®å½•
          rm -rf results
          
          # ä½¿ç”¨ extract-risks.awk ç”ŸæˆæŠ¥å‘Š
          awk -f scripts/ssa-risk-tools/extract-risks.awk ./risk.json
          
          # æ£€æŸ¥ results ç›®å½•æ˜¯å¦å­˜åœ¨
          if [ ! -d "results" ]; then
            echo "âŒ Results directory not found after AWK execution"
            exit 1
          fi
          
          # è§£æé£é™©è¯¦æƒ…æ–‡ä»¶å¹¶ç”Ÿæˆå¸¦ä½ç½®ä¿¡æ¯çš„æŠ¥å‘Š
          REPORT="## ğŸ” ä»£ç å®‰å…¨æ‰«ææŠ¥å‘Š\n\n"
          
          # è¯»å–æ‰«ææ€»ç»“
          if [ -f "results/scan_summary.txt" ]; then
            SCAN_TIME=$(grep "æ‰«ææ—¶é—´:" results/scan_summary.txt | sed 's/æ‰«ææ—¶é—´: //')
            RISK_COUNT=$(grep "æ€»é£é™©æ•°:" results/scan_summary.txt | sed 's/æ€»é£é™©æ•°: //')
            
            REPORT="${REPORT}**æ‰«ææ—¶é—´:** ${SCAN_TIME}\n"
            REPORT="${REPORT}**å‘ç°é£é™©æ•°:** ${RISK_COUNT}\n\n"
          fi
          
          # å¤„ç†æ¯ä¸ªé£é™©è¯¦æƒ…æ–‡ä»¶
          if [ "$RISK_COUNT" -gt 0 ]; then
            REPORT="${REPORT}### ğŸš¨ é£é™©è¯¦æƒ…\n\n"
            
            HIGH_CRITICAL_COUNT=0
            
            for i in $(seq 1 $RISK_COUNT); do
              detail_file="results/risk_details_${i}.txt"
              if [ -f "$detail_file" ]; then
                # æå–é£é™©ä¿¡æ¯
                RISK_ID=$(grep "é£é™©ID:" "$detail_file" | sed 's/é£é™©ID: //')
                FILE_PATH=$(grep "æ–‡ä»¶è·¯å¾„:" "$detail_file" | sed 's/æ–‡ä»¶è·¯å¾„: //')
                LINE_NUM=$(grep "è¡Œå·:" "$detail_file" | sed 's/è¡Œå·: //')
                CODE_RANGE=$(grep "ä»£ç èŒƒå›´:" "$detail_file" | sed 's/ä»£ç èŒƒå›´: //')
                SEVERITY=$(grep "ä¸¥é‡ç¨‹åº¦:" "$detail_file" | sed 's/ä¸¥é‡ç¨‹åº¦: //')
                TITLE=$(grep "æ ‡é¢˜:" "$detail_file" | sed 's/æ ‡é¢˜: //')
                CHINESE_TITLE=$(grep "ä¸­æ–‡æ ‡é¢˜:" "$detail_file" | sed 's/ä¸­æ–‡æ ‡é¢˜: //' || echo "")
                DESCRIPTION=$(grep "æè¿°:" "$detail_file" | sed 's/æè¿°: //' || echo "æ— æè¿°")
                SOLUTION=$(grep "è§£å†³æ–¹æ¡ˆ:" "$detail_file" | sed 's/è§£å†³æ–¹æ¡ˆ: //' || echo "æ— è§£å†³æ–¹æ¡ˆ")
                
                # åªå¤„ç† high æˆ– critical ä¸¥é‡ç¨‹åº¦çš„é£é™©
                if [ "$SEVERITY" = "high" ] || [ "$SEVERITY" = "critical" ]; then
                  HIGH_CRITICAL_COUNT=$((HIGH_CRITICAL_COUNT + 1))
                  # æ„å»ºé£é™©æŠ¥å‘Š
                  REPORT="${REPORT}#### ${CHINESE_TITLE:-$TITLE}\n\n"
                  REPORT="${REPORT}**ä¸¥é‡ç¨‹åº¦:** ${SEVERITY}\n"
                  REPORT="${REPORT}**æ–‡ä»¶:** ${FILE_PATH}\n"
                  REPORT="${REPORT}**ä½ç½®:** ç¬¬${LINE_NUM}è¡Œ"
                  
                  # æ·»åŠ ä»£ç èŒƒå›´ä¿¡æ¯
                  if [ -n "$CODE_RANGE" ] && [ "$CODE_RANGE" != "ç¬¬${LINE_NUM}è¡Œ" ]; then
                    REPORT="${REPORT} (${CODE_RANGE})"
                  fi
                  REPORT="${REPORT}\n"
                  
                  # æ·»åŠ  GitHub ä»£ç å¼•ç”¨é“¾æ¥
                  if [ -n "$FILE_PATH" ] && [ -n "$CODE_RANGE" ]; then
                    # è§£æä»£ç èŒƒå›´
                    if echo "$CODE_RANGE" | grep -q "-"; then
                      # èŒƒå›´æ ¼å¼: 7-12è¡Œ
                      START_LINE=$(echo "$CODE_RANGE" | sed 's/-.*//' | sed 's/è¡Œ//')
                      END_LINE=$(echo "$CODE_RANGE" | sed 's/.*-//' | sed 's/è¡Œ//')
                      REPORT="${REPORT}**ä»£ç å¼•ç”¨:** [${FILE_PATH}:${START_LINE}-${END_LINE}](https://github.com/${{ github.repository }}/blob/${{ env.HEAD_SHA }}/${FILE_PATH}#L${START_LINE}-L${END_LINE})\n"
                    else
                      # å•è¡Œæ ¼å¼: 7è¡Œ
                      LINE=$(echo "$CODE_RANGE" | sed 's/è¡Œ//')
                      REPORT="${REPORT}**ä»£ç å¼•ç”¨:** [${FILE_PATH}:${LINE}](https://github.com/${{ github.repository }}/blob/${{ env.HEAD_SHA }}/${FILE_PATH}#L${LINE})\n"
                    fi
                  fi
                  
                  REPORT="${REPORT}**è§„åˆ™:** $(grep "è§„åˆ™åç§°:" "$detail_file" | sed 's/è§„åˆ™åç§°: //' || echo "N/A")\n"
                  REPORT="${REPORT}**å‡½æ•°:** $(grep "å‡½æ•°åç§°:" "$detail_file" | sed 's/å‡½æ•°åç§°: //' || echo "N/A")\n\n"
                  
                  REPORT="${REPORT}**æè¿°:**\n${DESCRIPTION}\n\n"
                  REPORT="${REPORT}**å»ºè®®è§£å†³æ–¹æ¡ˆ:**\n${SOLUTION}\n\n"
                  REPORT="${REPORT}---\n\n"
                fi
              fi
            done
            
            # æ£€æŸ¥æ˜¯å¦æœ‰é«˜ä¸¥é‡ç¨‹åº¦çš„é£é™©
            if [ "$HIGH_CRITICAL_COUNT" -eq 0 ]; then
              REPORT="${REPORT}âœ… æœªå‘ç°é«˜ä¸¥é‡ç¨‹åº¦çš„å®‰å…¨é£é™©ï¼\n\n"
              REPORT="${REPORT}**è¯´æ˜:** è™½ç„¶æ£€æµ‹åˆ° ${RISK_COUNT} ä¸ªå®‰å…¨é£é™©ï¼Œä½†ä¸¥é‡ç¨‹åº¦å‡ä½äº high/critical çº§åˆ«ã€‚\n\n"
              REPORT="${REPORT}**å»ºè®®:** å¯ä»¥åœ¨åç»­ç‰ˆæœ¬ä¸­é€æ­¥ä¿®å¤è¿™äº›ä½ä¸¥é‡ç¨‹åº¦çš„é£é™©ã€‚"
            fi
          else
            REPORT="${REPORT}âœ… æœªå‘ç°å®‰å…¨é£é™©ï¼Œä»£ç å®‰å…¨æ£€æŸ¥é€šè¿‡ï¼"
          fi
          
          REPORT="${REPORT}\n---\n*æ­¤æŠ¥å‘Šç”±ä»£ç å®‰å…¨æ‰«æå·¥å…·è‡ªåŠ¨ç”Ÿæˆ*"
          
          echo "report_content<<EOF" >> $GITHUB_OUTPUT
          echo -e "$REPORT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # å°†æŠ¥å‘Šå†…å®¹ä¿å­˜åˆ°æ–‡ä»¶ï¼Œä¾› JavaScript è¯»å–
          echo -e "$REPORT" > report_content.txt
      
      - name: Comment PR with security findings
        if: steps.scan.outputs.scan_result == 'failure' && steps.test_token.outputs.has_permissions == 'true' && env.PR_NUMBER != '' && env.PR_NUMBER != '0'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            
            try {
              // ä»æ–‡ä»¶è¯»å–æŠ¥å‘Šå†…å®¹ï¼Œé¿å… JavaScript å…³é”®å­—å†²çª
              let report = '';
              if (fs.existsSync('report_content.txt')) {
                report = fs.readFileSync('report_content.txt', 'utf8');
              } else {
                report = 'æŠ¥å‘Šæ–‡ä»¶æœªæ‰¾åˆ°';
              }
              
              // å®šä¹‰å®‰å…¨æ‰«æè¯„è®ºçš„æ ‡è¯†ç¬¦
              const commentIdentifier = '<!-- Security Scan Report -->';
              const commentSignature = 'æ­¤æŠ¥å‘Šç”±ä»£ç å®‰å…¨æ‰«æå·¥å…·è‡ªåŠ¨ç”Ÿæˆ';
              
              // æŸ¥è¯¢ç°æœ‰çš„ PR è¯„è®º
              const comments = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: Number(process.env.PR_NUMBER)
              });
              
              // æŸ¥æ‰¾ç°æœ‰çš„å®‰å…¨æ‰«æè¯„è®º
              let existingComment = null;
              for (const comment of comments.data) {
                if (comment.body.includes(commentIdentifier) && comment.body.includes(commentSignature)) {
                  existingComment = comment;
                  break;
                }
              }
              
              // åœ¨æŠ¥å‘Šå†…å®¹ä¸­æ·»åŠ æ ‡è¯†ç¬¦
              const reportWithIdentifier = commentIdentifier + '\n\n' + report;
              
              if (existingComment) {
                // æ›´æ–°ç°æœ‰è¯„è®º
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: existingComment.id,
                  body: reportWithIdentifier
                });
                console.log('Security report comment updated successfully');
              } else {
                // åˆ›å»ºæ–°è¯„è®º
                await github.rest.issues.createComment({
                  issue_number: Number(process.env.PR_NUMBER),
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: reportWithIdentifier
                });
                console.log('Security report comment posted successfully to PR comments');
              }
              
              // ç„¶åå°è¯•åœ¨å…·ä½“çš„ä»£ç è¡Œä¸Šæ·»åŠ è¯„è®º
              // è¯»å– results ç›®å½•ä¸­çš„é£é™©è¯¦æƒ…æ–‡ä»¶
              const path = require('path');
              
              try {
                const resultsDir = path.join(process.cwd(), 'results');
                if (fs.existsSync(resultsDir)) {
                  const files = fs.readdirSync(resultsDir);
                  const detailFiles = files.filter(file => file.startsWith('risk_details_') && file.endsWith('.txt'));
                  
                  for (const detailFile of detailFiles) {
                    const detailPath = path.join(resultsDir, detailFile);
                    const content = fs.readFileSync(detailPath, 'utf8');
                    
                    // è§£ææ–‡ä»¶å†…å®¹
                    const lines = content.split('\n');
                    let filePath = '';
                    let lineNum = '';
                    let severity = '';
                    let title = '';
                    let description = '';
                    let solution = '';
                    
                    for (const line of lines) {
                      if (line.startsWith('æ–‡ä»¶è·¯å¾„:')) {
                        filePath = line.replace('æ–‡ä»¶è·¯å¾„:', '').trim();
                      } else if (line.startsWith('è¡Œå·:')) {
                        lineNum = line.replace('è¡Œå·:', '').trim();
                      } else if (line.startsWith('ä¸¥é‡ç¨‹åº¦:')) {
                        severity = line.replace('ä¸¥é‡ç¨‹åº¦:', '').trim();
                      } else if (line.startsWith('ä¸­æ–‡æ ‡é¢˜:')) {
                        title = line.replace('ä¸­æ–‡æ ‡é¢˜:', '').trim();
                      } else if (line.startsWith('æ ‡é¢˜:') && !title) {
                        title = line.replace('æ ‡é¢˜:', '').trim();
                      } else if (line.startsWith('æè¿°:')) {
                        description = line.replace('æè¿°:', '').trim();
                      } else if (line.startsWith('è§£å†³æ–¹æ¡ˆ:')) {
                        solution = line.replace('è§£å†³æ–¹æ¡ˆ:', '').trim();
                      }
                    }
                    
                     // å¦‚æœæ‰¾åˆ°äº†æ–‡ä»¶è·¯å¾„å’Œè¡Œå·ï¼Œä¸”ä¸¥é‡ç¨‹åº¦ä¸º high æˆ– criticalï¼Œåˆ›å»ºå¸¦ä»£ç å¼•ç”¨çš„è¯„è®º
                     if (filePath && lineNum && severity && title && (severity === 'high' || severity === 'critical')) {
                       try {
                         // æ„å»ºå¸¦ä»£ç å¼•ç”¨çš„è¯„è®ºå†…å®¹å’Œç²¾å‡†é“¾æ¥
                         const codeReference = `\`${filePath}:${lineNum}\``;
                         const lineCommentIdentifier = `<!-- Security Line Comment: ${filePath}:${lineNum} -->`;
                         const lineCommentSignature = 'æ­¤è¯„è®ºç”±ä»£ç å®‰å…¨æ£€æŸ¥å·¥å…·è‡ªåŠ¨ç”Ÿæˆ';
                         
                         // ç”Ÿæˆç²¾å‡†çš„ GitHub ä»£ç é“¾æ¥
                         const lineLink = `https://github.com/${context.repo.owner}/${context.repo.repo}/blob/${context.sha}/${filePath}#L${lineNum}`;
                         
                         const lineComment = `${lineCommentIdentifier}\n\n## âš ï¸ å®‰å…¨é£é™©æ£€æµ‹\n\n**é—®é¢˜:** ${title}\n**ä¸¥é‡ç¨‹åº¦:** ${severity}\n**æ–‡ä»¶ä½ç½®:** ${codeReference}\n**ä»£ç é“¾æ¥:** [æŸ¥çœ‹ä»£ç ](${lineLink})\n\n**æè¿°:**\n${description}\n\n**å»ºè®®è§£å†³æ–¹æ¡ˆ:**\n${solution}\n\n---\n*${lineCommentSignature}*`;
                         
                         // æŸ¥æ‰¾ç°æœ‰çš„è¡Œçº§è¯„è®º
                         let existingLineComment = null;
                         for (const comment of comments.data) {
                           if (comment.body.includes(lineCommentIdentifier) && comment.body.includes(lineCommentSignature)) {
                             existingLineComment = comment;
                             break;
                           }
                         }
                         
                         if (existingLineComment) {
                           // æ›´æ–°ç°æœ‰çš„è¡Œçº§è¯„è®º
                           await github.rest.issues.updateComment({
                             owner: context.repo.owner,
                             repo: context.repo.repo,
                             comment_id: existingLineComment.id,
                             body: lineComment
                           });
                           console.log(`Line-specific comment updated for ${filePath}:${lineNum} (severity: ${severity})`);
                         } else {
                           // åˆ›å»ºæ–°çš„è¡Œçº§è¯„è®º
                           await github.rest.issues.createComment({
                             issue_number: Number(process.env.PR_NUMBER),
                             owner: context.repo.owner,
                             repo: context.repo.repo,
                             body: lineComment
                           });
                           console.log(`Line-specific comment posted for ${filePath}:${lineNum} (severity: ${severity})`);
                         }
                       } catch (lineError) {
                         console.warn(`Failed to post line-specific comment for ${filePath}:${lineNum}:`, lineError.message);
                         // ç»§ç»­å¤„ç†å…¶ä»–æ–‡ä»¶ï¼Œä¸ä¸­æ–­æ•´ä¸ªæµç¨‹
                       }
                     } else if (severity && severity !== 'high' && severity !== 'critical') {
                       console.log(`Skipping line-specific comment for ${filePath}:${lineNum} (severity: ${severity} - not high/critical)`);
                     }
                  }
                }
              } catch (resultsError) {
                console.warn('Failed to process results directory for line comments:', resultsError.message);
                // ä¸ä¸­æ–­ä¸»æµç¨‹
              }
              
              // æ¸…ç†ä¸å†ç›¸å…³çš„æ—§è¯„è®º
              // æ”¶é›†å½“å‰æ´»è·ƒçš„é£é™©æ–‡ä»¶è·¯å¾„å’Œè¡Œå·
              const activeRisks = new Set();
              try {
                const resultsDir = path.join(process.cwd(), 'results');
                if (fs.existsSync(resultsDir)) {
                  const files = fs.readdirSync(resultsDir);
                  const detailFiles = files.filter(file => file.startsWith('risk_details_') && file.endsWith('.txt'));
                  
                  for (const detailFile of detailFiles) {
                    const detailPath = path.join(resultsDir, detailFile);
                    const content = fs.readFileSync(detailPath, 'utf8');
                    
                    const lines = content.split('\n');
                    let filePath = '';
                    let lineNum = '';
                    let severity = '';
                    
                    for (const line of lines) {
                      if (line.startsWith('æ–‡ä»¶è·¯å¾„:')) {
                        filePath = line.replace('æ–‡ä»¶è·¯å¾„:', '').trim();
                      } else if (line.startsWith('è¡Œå·:')) {
                        lineNum = line.replace('è¡Œå·:', '').trim();
                      } else if (line.startsWith('ä¸¥é‡ç¨‹åº¦:')) {
                        severity = line.replace('ä¸¥é‡ç¨‹åº¦:', '').trim();
                      }
                    }
                    
                    // åªä¿ç•™ high å’Œ critical çš„é£é™©
                    if (filePath && lineNum && severity && (severity === 'high' || severity === 'critical')) {
                      activeRisks.add(`${filePath}:${lineNum}`);
                    }
                  }
                }
                
                // æŸ¥æ‰¾å¹¶åˆ é™¤ä¸å†æ´»è·ƒçš„è¯„è®º
                for (const comment of comments.data) {
                  if (comment.body.includes('<!-- Security Line Comment:') && comment.body.includes('æ­¤è¯„è®ºç”±ä»£ç å®‰å…¨æ£€æŸ¥å·¥å…·è‡ªåŠ¨ç”Ÿæˆ')) {
                    // æå–è¯„è®ºä¸­çš„æ–‡ä»¶è·¯å¾„å’Œè¡Œå·
                    const match = comment.body.match(/<!-- Security Line Comment: ([^:]+:\d+) -->/);
                    if (match) {
                      const commentKey = match[1];
                      if (!activeRisks.has(commentKey)) {
                        // è¿™ä¸ªè¯„è®ºå¯¹åº”çš„é£é™©å·²ç»ä¸å­˜åœ¨ï¼Œåˆ é™¤è¯¥è¯„è®º
                        await github.rest.issues.deleteComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
                          comment_id: comment.id
                        });
                        console.log(`Deleted outdated comment for ${commentKey}`);
                      }
                    }
                  }
                }
              } catch (cleanupError) {
                console.warn('Failed to cleanup outdated comments:', cleanupError.message);
                // ä¸ä¸­æ–­ä¸»æµç¨‹
              }
              
              console.log('Security comments posted successfully, but workflow will fail to trigger failure handling steps');
              // æ•…æ„æŠ›å‡ºé”™è¯¯ï¼Œè®©å·¥ä½œæµå¤±è´¥ï¼Œä»¥ä¾¿æ‰§è¡Œåç»­çš„å¤±è´¥å¤„ç†æ­¥éª¤
              throw new Error('Security scan found issues - workflow intentionally failing to trigger failure handling');
              
            } catch (error) {
              console.error('Failed to post security comments:', error);
              throw error;
            }

      - name: Upload risk log
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: risk.json
          path: risk.json

      - name: Workflows fail info
        if: failure()
        run: |
          ./yak ssa-risk --input ./risk.json --with-code --severity high

      - name: Workflows fail info - full
        if: failure()
        run: |
          ./yak ssa-risk --input ./risk.json --with-code 
        # cat risk.json | jq -r '
        #   "=== Scan Report Summary ===",
        #   "Scan Time: \(.report_time)",
        #   "Program: \(.program_name)",
        #   "Language: \(.program_lang)",
        #   "Files Scanned: \(.file_count)",
        #   "Lines of Code: \(.code_line_count)",
        #   "Risks Found: \(.RiskNums)",
        #   "",
        #   "=== Risk Details ===",
        #   (.Risks[] | 
        #     "Risk ID: \(.hash)",
        #     "Title: \(.title_verbose)",
        #     "Severity: \(.severity)",
        #     "Location: \(.code_source_url):\(.line)",
        #     "Description: \(.description | split("\n")[0])",
        #     "Solution: \(.solution | split("\n")[0])",
        #     "Affected Code:",
        #     (.code_fragment | split("\n")[] | "  \(.)"),
        #     ""
        #   ),
        #   "=== Affected Files ===",
        #   (.File[] | 
        #     "File: \(.path)",
        #     "Lines: \(.line_count)",
        #     "Risk IDs: \(.risks | join(", "))",
        #     ""
        #   )'
        # exit 1