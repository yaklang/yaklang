name: Essential Tests

on:
  workflow_dispatch:
    inputs:
      target:
        description: "PR number, branch (e.g. owner:branch for fork), or commit SHA. Examples: 123, MisakaMikato:feature/branch, 4e7c85623d3bb7caa0b24ac6cabb5a3872e4a7bc"
        required: false
        default: ""
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, labeled, unlabeled]
    paths:
      - "common/**"
      - ".github/workflows/essential-tests.yml"
      - "go.mod"

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  check-wip:
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'pull_request'
    runs-on: ubuntu-22.04
    outputs:
      should_run_tests: ${{ steps.finalize.outputs.should_run_tests }}
      target_ref: ${{ steps.target.outputs.ref }}
      fork_repo: ${{ steps.target.outputs.fork_repo }}
    steps:
      - name: Determine target revision
        id: target
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            INPUT="${{ inputs.target }}"
            
            if [ -z "$INPUT" ] || [ "$INPUT" = "" ]; then
              REF="${{ github.ref_name }}"
              echo "No input provided, using current branch: $REF"
            elif [[ "$INPUT" =~ ^[0-9]+$ ]]; then
              PR_NUM="$INPUT"
              echo "Detected PR number: #$PR_NUM"
              echo "Fetching PR #$PR_NUM information..."
              
              PR_RESPONSE=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                -H "Accept: application/vnd.github.v3+json" \
                "https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUM")
              
              PR_HEAD_SHA=$(echo "$PR_RESPONSE" | jq -r '.head.sha // empty')
              PR_STATE=$(echo "$PR_RESPONSE" | jq -r '.state // empty')
              PR_TITLE=$(echo "$PR_RESPONSE" | jq -r '.title // empty')
              PR_HEAD_REF=$(echo "$PR_RESPONSE" | jq -r '.head.ref // empty')
              PR_HEAD_REPO=$(echo "$PR_RESPONSE" | jq -r '.head.repo.full_name // empty')
              
              if [ -z "$PR_HEAD_SHA" ] || [ "$PR_HEAD_SHA" = "null" ]; then
                echo "Failed to get PR #$PR_NUM. Please check if the PR exists and is accessible."
                exit 1
              fi
              
              echo "PR #$PR_NUM: $PR_TITLE"
              echo "PR state: $PR_STATE"
              echo "PR head branch: $PR_HEAD_REPO:$PR_HEAD_REF"
              echo "PR head commit (latest): $PR_HEAD_SHA"
              
              COMMITS_RESPONSE=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                -H "Accept: application/vnd.github.v3+json" \
                "https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUM/commits")
              
              COMMIT_COUNT=$(echo "$COMMITS_RESPONSE" | jq '. | length')
              echo "Total commits in PR: $COMMIT_COUNT"
              
              if [ "$COMMIT_COUNT" -gt 0 ]; then
                echo "Commits in this PR:"
                echo "$COMMITS_RESPONSE" | jq -r '.[] | "  - \(.sha[0:7]) \(.commit.message | split("\n")[0])"'
              fi
              
              REF="$PR_HEAD_SHA"
              echo "Using PR head commit (latest): $REF"
            elif [[ "$INPUT" =~ ^[a-f0-9]{40}$ ]] || [[ "$INPUT" =~ ^[a-f0-9]{7,}$ ]]; then
              REF="$INPUT"
              echo "Detected commit SHA: $REF"
            elif [[ "$INPUT" == *":"* ]]; then
              FORK_OWNER=$(echo "$INPUT" | cut -d':' -f1)
              FORK_BRANCH=$(echo "$INPUT" | cut -d':' -f2-)
              REPO_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)
              FORK_REPO="$FORK_OWNER/$REPO_NAME"
              
              echo "Detected fork branch format: $INPUT"
              echo "Fork owner: $FORK_OWNER"
              echo "Branch: $FORK_BRANCH"
              echo "Fork repository: $FORK_REPO"
              
              REF="$FORK_BRANCH"
              FORK_REPO_FULL="$FORK_REPO"
              echo "fork_repo=$FORK_REPO_FULL" >> $GITHUB_OUTPUT
              echo "Using fork branch: $FORK_REPO_FULL:$FORK_BRANCH"
            else
              REF="$INPUT"
              echo "Detected branch/tag: $REF"
            fi
          else
            REF="${{ github.event.pull_request.head.sha }}"
          fi
          echo "ref=$REF" >> $GITHUB_OUTPUT
          echo "Final target ref: $REF"

      - name: Initialize run flag
        run: echo "SHOULD_RUN=false" >> $GITHUB_ENV

      - name: Allow manual dispatch
        if: github.event_name == 'workflow_dispatch'
        run: echo "SHOULD_RUN=true" >> $GITHUB_ENV

      - name: 'Check Out'
        if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository
        uses: actions/checkout@v3
        with:
          ref: ${{ steps.target.outputs.ref }}

      - name: Run Pre-Check
        if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository
        id: pre_check
        uses: ./.github/actions/pre-check
        with:
          failed-labels: 'do-not-merge,work in progress,wip,rfc'
          cache-key-prefix: 'essential-tests'

      - name: Accept Pre-Check result
        if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository
        run: echo "SHOULD_RUN=${{ steps.pre_check.outputs.should_run_tests }}" >> $GITHUB_ENV

      - name: Finalize outputs
        id: finalize
        run: |
          echo "should_run_tests=$SHOULD_RUN" >> $GITHUB_OUTPUT
        env:
          SHOULD_RUN: ${{ env.SHOULD_RUN }}

  setup:
    needs: check-wip
    if: needs.check-wip.outputs.should_run_tests == 'true'
    runs-on: ubuntu-22.04
    steps:
      - name: Set Cache Key
        id: cache_key
        run: |
          CACHE_SHA="${{ needs.check-wip.outputs.target_ref }}"
          if [ -z "$CACHE_SHA" ]; then
            CACHE_SHA="${{ github.sha }}"
          fi
          echo "sha=$CACHE_SHA" >> $GITHUB_OUTPUT
          echo "Cache key will be: go-$CACHE_SHA"

      - name: Cache YakLang Project
        uses: actions/cache@v3
        id: cache-project
        with:
          path: |
            ~/yakit-projects
            ${{ github.workspace }}
          key: go-${{ steps.cache_key.outputs.sha }}

      - name: Check out code into the Go module directory
        if: steps.cache-project.outputs.cache-hit != 'true'
        uses: actions/checkout@v3
        with:
          repository: ${{ needs.check-wip.outputs.fork_repo || github.repository }}
          ref: ${{ needs.check-wip.outputs.target_ref || github.sha }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Go 1.x
        uses: actions/setup-go@v5
        with:
          go-version-file: "./go.mod"
          cache-dependency-path: go.sum
        id: go

      - name: Restore Go Build Cache
        uses: actions/cache@v3
        id: cache-go-build
        with:
          path: ~/.cache/go-build
          key: go-build-${{ steps.cache_key.outputs.sha }}-${{ runner.os }}-${{ hashFiles('go.sum') }}
          restore-keys: |
            go-build-${{ steps.cache_key.outputs.sha }}-
            go-build-

      - name: Init Module
        run: |
          go mod tidy 
          echo "Modifying permissions to read-write for pcap-bpf.h"

      - name: Warm up Go Build Cache
        if: steps.cache-go-build.outputs.cache-hit != 'true'
        run: |
          echo "Warming up Go build cache by building core dependencies..."
          # 编译核心依赖包，填充 build cache
          go build ./common/utils/... || true
          go build ./common/mutate/... || true
          go build ./common/yak/ssaapi/... || true
          echo "Build cache warmed up"

      - name: Save Go Build Cache
        uses: actions/cache/save@v3
        if: steps.cache-go-build.outputs.cache-hit != 'true'
        with:
          path: ~/.cache/go-build
          key: go-build-${{ steps.cache_key.outputs.sha }}-${{ runner.os }}-${{ hashFiles('go.sum') }}

      - name: Generate Document Data
        if: steps.cache-project.outputs.cache-hit != 'true'
        run: |
          chmod +x ./scripts/gen-auto-completion.sh
          ./scripts/gen-auto-completion.sh

      - name: Init Project
        if: steps.cache-project.outputs.cache-hit != 'true'
        run: |
          go build -x common/yak/cmd/yak.go 
          ./yak --help

  warm-build-cache:
    needs: [check-wip, setup]
    if: needs.check-wip.outputs.should_run_tests == 'true'
    runs-on: ubuntu-22.04
    steps:
      - name: "Checkout"
        uses: actions/checkout@v3
        with:
          repository: ${{ needs.check-wip.outputs.fork_repo || github.repository }}
          ref: ${{ needs.check-wip.outputs.target_ref || github.sha }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set Cache Key
        id: cache_key
        run: |
          CACHE_SHA="${{ needs.check-wip.outputs.target_ref }}"
          if [ -z "$CACHE_SHA" ]; then
            CACHE_SHA="${{ github.sha }}"
          fi
          echo "sha=$CACHE_SHA" >> $GITHUB_OUTPUT

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: "./go.mod"
          cache-dependency-path: go.sum

      - name: Restore Go Build Cache
        uses: actions/cache@v3
        id: cache-go-build
        with:
          path: ~/.cache/go-build
          key: go-build-${{ steps.cache_key.outputs.sha }}-${{ runner.os }}-${{ hashFiles('go.sum') }}
          restore-keys: |
            go-build-${{ steps.cache_key.outputs.sha }}-
            go-build-

      - name: Build All Common Packages
        if: steps.cache-go-build.outputs.cache-hit != 'true'
        run: |
          echo "Building all common packages to populate build cache..."
          echo "This may take 5-10 minutes on first run..."
          # 编译所有测试会用到的包，填充 build cache
          # 使用 -o /dev/null 只编译不生成二进制
          go list -f '{{.ImportPath}}' ./common/... 2>/dev/null | \
            while read -r pkg; do
              echo "Building $pkg..."
              go build -o /dev/null "$pkg" 2>/dev/null || true
            done
          echo "Build cache populated"

      - name: Save Go Build Cache
        uses: actions/cache/save@v3
        if: steps.cache-go-build.outputs.cache-hit != 'true'
        with:
          path: ~/.cache/go-build
          key: go-build-${{ steps.cache_key.outputs.sha }}-${{ runner.os }}-${{ hashFiles('go.sum') }}

  test:
    name: ${{ matrix.name }}
    needs: [check-wip, setup, warm-build-cache]
    if: needs.check-wip.outputs.should_run_tests == 'true'
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        include:
          - name: "Test Utils/Misc in 2min USE gRPC"
            test_configs: |
              [
                {"package": "./common/yak/cmd/yakcmds/...", "timeout": "20s"},
                {"package": "./common/chunkmaker/...", "timeout": "20s"},
                {"package": "./common/jsonextractor", "timeout": "20s"},
                {"package": "./common/markdownextractor", "timeout": "20s"},
                {"package": "./common/yak/yaklib/codec", "timeout": "20s"},
                {"package": "./common/yak/cartesian", "timeout": "20s"},
                {"package": "./common/jsonpath", "timeout": "20s"},
                {"package": "./common/domainextractor", "timeout": "20s"},
                {"package": "./common/utils/omap/...", "timeout": "30s", "race": true},
                {"package": "./common/utils", "timeout": "1m"},
                {"package": "./common/utils/imageutils/...", "timeout": "20s"},
                {"package": "./common/utils/xml2", "timeout": "10s"},
                {"package": "./common/utils/tlsutils/...", "timeout": "20s"},
                {"package": "./common/utils/linktable/...", "timeout": "10s"},
                {"package": "./common/cve", "timeout": "20s", "run": "TestQueryCVEWithFixName"},
                {"package": "./common/sca/...", "timeout": "20s"},
                {"package": "./common/yak/yaklib", "timeout": "20s", "run": "TestMUSTPASS_YakitLog"},
                {"package": "./common/yak/yaklib", "timeout": "20s", "run": "TestMUSTPASS_Common"},
                {"package": "./common/yak/yaklib/tools", "timeout": "1m", "run": "TestMUSTPASS_Fp"},
                {"package": "./common/openapi/...", "timeout": "30s"},
                {"package": "./common/utils/dot/...", "timeout": "10s"},
                {"package": "./common/utils/filesys/...", "timeout": "10s"},
                {"package": "./common/utils/bruteutils/.", "timeout": "15s"},
                {"package": "./common/utils/memedit/.", "timeout": "15s"},
                {"package": "./common/pcapx/pcaputil/...", "timeout": "15s"},
                {"package": "./common/yak/yakurl/...", "timeout": "15s"},
                {"package": "./common/utils/ziputil/...", "timeout": "20s"},
                {"package": "./common/yso/...", "timeout": "20s"},
                {"package": "./common/yserx", "timeout": "20s"},
                {"package": "./common/twofa/...", "timeout": "20s"},
                {"package": "./common/cybertunnel/..."},
                {"package": "./common/utils/yakgit/..."},
                {"package": "./common/utils/suspect"},
                {"package": "./common/javaclassparser/jarwar/..."},
                {"package": "./common/bin-parser/...", "timeout": "1m"},
                {"package": "./common/yak/antlr4nasl/tests/...", "timeout": "1m"},
                {"package": "./common/fp/...", "timeout": "60s"},
                {"package": "./common/utils/gzip_embed/test/...", "timeout": "30s"},
                {"package": "./common/yak/cmd/...", "timeout": "30s"},
                {"package": "./common/javaclassparser/tests/...", "timeout": "30s"},
                {"package": "./common/suricata/...", "timeout": "20s", "run": "TestMUSTPASS*"},
                {"package": "./common/chaosmaker", "timeout": "20s", "run": "TestMUSTPASS*"},
                {"package": "./common/pcapx", "timeout": "20s", "run": "TestSmoking_*"},
                {"package": "./common/netx/mustpass", "timeout": "20s"},
                {"package": "./common/utils/pingutil", "timeout": "20s", "run": "TestPingAutoConfig"},
                {"package": "./common/mutate_tests", "timeout": "20s"},
                {"package": "./common/fuzztag", "timeout": "20s"},
                {"package": "./common/fuzztagx", "timeout": "20s"},
                {"package": "./common/mutate", "timeout": "30s"},
                {"package": "./common/fuzzx", "timeout": "30s"},
                {"package": "./common/utils/bizhelper/...", "timeout": "20s"},
                {"package": "./common/utils/cli", "timeout": "1m"},
                {"package": "./common/mcp/yakcliconvert", "timeout": "1m"},
                {"package": "./common/yak/yakdoc/...", "timeout": "3m"},
                {"package": "./common/authhack/...", "timeout": "1m"},
                {"package": "./common/vulinboxagentclient", "timeout": "1m", "run": "TestMUSTPASS"},
                {"package": "./common/utils/yakgit/yakdiff/...", "timeout": "20s"}
              ]
          # 2. AI相关 - 需要串行执行避免数据库锁定
          - name: "Test AI Infra / RAG / Knowledge"
            test_configs: |
              [
                {"package": "./common/ai/aid/...", "timeout": "12m", "parallel": 1},
                {"package": "./common/ai/tests/...", "timeout": "60s", "parallel": 1},
                {"package": "./common/ai/rag/pq/...", "timeout": "60s", "parallel": 1},
                {"package": "./common/ai/rag/hnsw/...", "timeout": "60s", "parallel": 1},
                {"package": "./common/ai/aispec/...", "timeout": "60s", "parallel": 1},
                {"package": "./common/aireducer/...", "timeout": "60s", "parallel": 1},
                {"package": "./common/aiforge/aibp", "timeout": "40s", "parallel": 1, "run": "^(TestBuildForgeFromYak|TestNewForgeExecutor)"},
                {"package": "./common/aiforge", "timeout": "3m", "parallel": 1},
                {"package": "./common/ai/rag/entityrepos/...", "timeout": "60s", "parallel": 1},
                {"package": "./common/ai/rag/vectorstore/...", "timeout": "1m", "run": "TestMUSTPASS", "parallel": 1},
                {"package": "./common/ai/rag", "timeout": "1m", "run": "TestMUSTPASS", "parallel": 1},
                {"package": "./common/ai/rag/plugins_rag/...", "timeout": "1m", "run": "TestMUSTPASS", "parallel": 1}
              ]          

          - name: "Test gRPC StaticAnalyze / BuildIn SyntaxFlow Rule / SSA / SSA-API / SF Scan"
            test_configs: |
              [
                {"package": "./common/yak/static_analyzer/test/...", "timeout": "20s"},
                {"package": "./common/coreplugin", "timeout": "1m", "run": "TestAnalyzeMustPASS*"},
                {"package": "./common/syntaxflow/sfbuildin/...", "timeout": "5m"},
                {"package": "./common/yak/ssaapi/test/syntaxflow", "timeout": "1m"},
                {"package": "./common/syntaxflow/sfanalyzer/...", "timeout": "20s"},
                {"package": "./common/yak/ssa/...", "timeout": "20s"},
                {"package": "./common/yak/ssaapi", "timeout": "1m"},
                {"package": "./common/yak/ssaapi/ssareducer", "timeout": "1m"},
                {"package": "./common/yak/ssaapi/test/ssatest", "timeout": "1m"},
                {"package": "./common/yak/syntaxflow_scan/...", "timeout": "1m"}
              ]          

          - name: "Test gRPC SSA Frontend Yak  / JS(TS|ES) | PHP | Golang | C | Java"
            test_configs: |
              [
                {"package": "./common/yak/yak2ssa/test/...", "timeout": "20s"},
                {"package": "./common/yak/ssaapi/test/yak", "timeout": "1m"},
                {"package": "./common/yak/ssaapi/test/yak", "timeout": "1m"},
                {"package": "./common/yak/antlr4yak/lsp/...", "timeout": "20s"},
                {"package": "./common/yak/java/...", "timeout": "5m"},
                {"package": "./common/yak/ssaapi/test/java", "timeout": "3m"},
                {"package": "./common/yak/typescript/frontend/tests/...", "timeout": "1m"},
                {"package": "./common/yak/typescript/ts2ssa/tests/...", "timeout": "2m"},
                {"package": "./common/yak/php/...", "timeout": "2m"},
                {"package": "./common/yak/ssaapi/test/php", "timeout": "2m"},
                {"package": "./common/yak/go2ssa/...", "timeout": "30s"},
                {"package": "./common/yak/antlr4go/...", "timeout": "30s"},
                {"package": "./common/yak/ssaapi/test/golang", "timeout": "2m"},
                {"package": "./common/yak/c2ssa/...", "timeout": "30s"},
                {"package": "./common/yak/antlr4c/...", "timeout": "30s"},
                {"package": "./common/yak/ssaapi/test/c", "timeout": "2m"}
              ]          

          - name: "Test lowhttp / DNSX"
            test_configs: |
              [
                {"package": "./common/utils/lowhttp", "timeout": "3m", "skip": "TestComputeDigestResponseFromRequest|TestComputeDigestResponseFromRequestEx|TestLowhttpResponse2", "retry": 2, "retry_delay": 5},
                {"package": "./common/facades/...", "timeout": "30s"}
              ]          

          - name: "Test HttpTpl(YakTemplate)"
            test_configs: |
              [
                {"package": "./common/yak/httptpl", "timeout": "1m"}
              ]      

          - name: "Test MustPass - full yak scripts"
            test_configs: |
              [
                {"package": "./common/yak/yaktest/mustpass", "timeout": "5m"}
              ]     

          - name: "Test gRPC MUSTPASS MITM"
            test_configs: |
              [
              {"package": "./common/yakgrpc/yakit", "timeout": "1m", "run": "TestMUSTPASS"},
              {"package": "./common/yakgrpc/...", "timeout": "5m", "run": "TestGRPCMUSTPASS_MITM_*"},
              {"package": "./common/yakgrpc/...", "timeout": "5m", "run": "TestGRPCMUSTPASS_MITMV2_*"}
              ]

          - name: "Test gRPC MUSTPASS Fuzzer"
            test_configs: |
              [
                {"package": "./common/yakgrpc/...", "timeout": "5m", "run": "TestGRPCMUSTPASS_HTTPFuzzer"},
                {"package": "./common/yakgrpc/...", "timeout": "5m", "run": "TestGRPCMUSTPASS_HTTP_"},
                {"package": "./common/yakgrpc/...", "timeout": "5m", "run": "TestGRPCMUSTPASS_PluginTrace"}
              ]

          - name: "Test gRPC MUSTPASS Language"
            test_configs: |
              [
                {"package": "./common/yakgrpc/...", "timeout": "5m", "run": "TestGRPCMUSTPASS_LANGUAGE*"}
              ]

          - name: "Test gRPC MUSTPASS SyntaxFlow | SSA"
            sync_rule: "1"
            test_configs: |
              [
              {"package": "./common/yakgrpc/...", "timeout": "5m", "run": "TestGRPCMUSTPASS_SyntaxFlow*"},
              {"package": "./common/yakgrpc/...", "timeout": "5m", "run": "TestGRPCMUSTPASS_SSA*"},
              {"package": "./common/sfweb/...", "timeout": "4m"}
              ]

          - name: "Test gRPC In 2m"
            test_configs: |
              [
                {"package": "./common/yakgrpc/...", "timeout": "2m", "run": "TestGRPCMUSTPASS_AnalyzeHTTPFlow*"},
                {"package": "./common/yakgrpc/...", "timeout": "2m", "run": "TestGRPCMUSTPASS_Fingerprint*"},
                {"package": "./common/yakgrpc/...", "timeout": "2m", "run": "TestGRPCMUSTPASS_HybridScan*"},
                {"package": "./common/yakgrpc/...", "timeout": "2m", "run": "TestLARGEGRPCMUSTPASS*"},
                {"package": "./common/yakgrpc/...", "timeout": "5m", "run": "TestGRPCMUSTPASS_COMMON*"},
                {"package": "./common/yakgrpc/...", "timeout": "1m", "run": "TestAITaskWith", "parallel": 1}
              ]

          - name: "Test gRPC Other"
            test_configs: |
              [
                {"package": "./common/yakgrpc/...", "timeout": "10m", "skip": "^(TestGRPCMUSTPASS_PluginTrace*|TestGRPCMUSTPASS_AnalyzeHTTPFlow*|TestGRPCMUSTPASS_Fingerprint*|TestGRPC_Ai_List_Model|TestGRPCMUSTPASS_HTTP_*|TestAITaskWith*|TestGRPCMUSTPASS_MITM_*|TestGRPCMUSTPASS_HTTPFuzzer*|TestGRPCMUSTPASS_LANGUAGE*|TestGRPCMUSTPASS_COMMON*|TestLARGEGRPCMUSTPASS*|TestGRPCMUSTPASS_SyntaxFlow*|TestGRPCMUSTPASS_SSA*)"}
              ]

          - name: "Test Integration MITM / SyntaxFlow"
            test_configs: |
              [
                {"package": "./common/coreplugin", "timeout": "2m", "run": "TestGRPCMUSTPASS_MITM"},
                {"package": "./common/syntaxflow/tests", "timeout": "20s"},
                {"package": "./common/syntaxflow/sfdb/...", "timeout": "20s"},
                {"package": "./common/syntaxflow/sfvm/...", "timeout": "20s"}
              ]          

          - name: "Test Vulinbox Coreplugin Fastjson"
            test_configs: |
              [
                {"package": "./common/coreplugin", "timeout": "3m", "run": "TestGRPCMUSTPASS_Fastjson"}
              ]

          - name: "Test Vulinbox Coreplugin SQL Injection"
            test_configs: |
              [
                {"package": "./common/coreplugin", "timeout": "5m", "run": "TestGRPCMUSTPASS_SQL"}
              ]

          - name: "Test Vulinbox Coreplugin (XSS/Shiro/SSRF/SSTI/SMUGGLE/CSRF/OPEN_REDIRECT)"
            test_configs: |
              [
                {"package": "./common/coreplugin", "timeout": "6m", "run": "^(TestGRPCMUSTPASS_XSS|TestGRPCMUSTPASS_Shiro|TestGRPCMUSTPASS_SSRF|TestGRPCMUSTPASS_SSTI|TestGRPCMUSTPASS_Smuggle|TestGRPCMUSTPASS_CSRF|TestGRPCMUSTPASS_OPEN_REDIRECT)$"}
              ]

          - name: "Test Crawler / Crawlerx (chromium based crawler)"
            test_configs: |
              [
                {"package": "./common/crawlerx/...", "timeout": "5m"},
                {"package": "./common/crawler", "timeout": "20s", "run": "TestMUSTPASS"}
              ]
    steps:
      - name: "Checkout"
        uses: actions/checkout@v3
        with:
          repository: ${{ needs.check-wip.outputs.fork_repo || github.repository }}
          ref: ${{ needs.check-wip.outputs.target_ref || github.sha }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set Cache Key
        id: cache_key
        run: |
          CACHE_SHA="${{ needs.check-wip.outputs.target_ref }}"
          if [ -z "$CACHE_SHA" ]; then
            CACHE_SHA="${{ github.sha }}"
          fi
          echo "sha=$CACHE_SHA" >> $GITHUB_OUTPUT
          echo "Cache key will be: go-$CACHE_SHA"

      - name: Cache YakLang Project
        uses: actions/cache/restore@v3
        id: cache-project
        with:
          path: |
            ~/yakit-projects
            ${{ github.workspace }}
          key: go-${{ steps.cache_key.outputs.sha }}

      - name: Set up Go 1.x
        uses: actions/setup-go@v5
        with:
          go-version-file: "./go.mod"
          cache-dependency-path: go.sum
        id: go

      - name: Restore Go Build Cache
        uses: actions/cache@v3
        id: cache-go-build
        with:
          path: ~/.cache/go-build
          key: go-build-${{ steps.cache_key.outputs.sha }}-${{ runner.os }}-${{ hashFiles('go.sum') }}
          restore-keys: |
            go-build-${{ steps.cache_key.outputs.sha }}-
            go-build-

      - name: Set GOCACHE environment
        run: |
          echo "GOCACHE=$HOME/.cache/go-build" >> $GITHUB_ENV
          echo "GOMODCACHE=$(go env GOMODCACHE)" >> $GITHUB_ENV
          if [ -d "$HOME/.cache/go-build" ]; then
            CACHE_SIZE=$(du -sh "$HOME/.cache/go-build" 2>/dev/null | cut -f1 || echo "0B")
            echo "Build cache restored: $CACHE_SIZE"
          else
            echo "Build cache directory not found"
          fi

      - name: Generate Test Config
        run: |
          # 根据 matrix 配置生成测试配置文件
          TEST_CONFIG_FILE="/tmp/test_config.json"
          
          # 将 test_configs 写入文件
          cat > "$TEST_CONFIG_FILE" <<'CONFIGEOF'
          ${{ matrix.test_configs }}
          CONFIGEOF
          
          # 检查是否为空（只包含空白字符）
          if grep -q '[^[:space:]]' "$TEST_CONFIG_FILE"; then
            echo "Generated test config file:"
            cat "$TEST_CONFIG_FILE"
          else
            echo "No package-level config specified"
            echo "[]" > "$TEST_CONFIG_FILE"
          fi

      - name: Compile Test Binaries
        env:
          GOCACHE: ${{ env.GOCACHE }}
        run: |
          chmod +x ./scripts/ci/compile-tests.sh
          export TEST_BIN_DIR=/tmp/test_binaries
          export TEST_CONFIG="/tmp/test_config.json"
          echo "Compiling test binaries with build cache..."
          ./scripts/ci/compile-tests.sh
          if [ -d "$HOME/.cache/go-build" ]; then
            echo "Build cache after compilation: $(du -sh $HOME/.cache/go-build 2>/dev/null | cut -f1 || echo '0B')"
          fi

      - name: Start GRPC Server
        env: 
          SKIP_SYNC_EMBED_RULE_IN_GITHUB: "true"
        run: |
          echo "Starting GRPC server for test: ${{ matrix.name }}"
          nohup ./yak grpc > /tmp/grpc.log 2>&1 < /dev/null &
          echo "Waiting for GRPC server to start on port 8087..."
          for i in {1..60}; do
            if nc -z localhost 8087; then
              echo "GRPC server is ready on port 8087"
              break
            fi
            echo "Waiting... ($i/60)"
            sleep 1
          done
          if ! nc -z localhost 8087; then
            echo "GRPC server failed to start within 60 seconds"
            cat /tmp/grpc.log
            exit 1
          fi

      - name: Sync SyntaxFlow Rules
        if: matrix.sync_rule == '1'
        run: |
          echo "Syncing SyntaxFlow rules for test: ${{ matrix.name }}"
          ./yak sync-rule

      - name: ${{ matrix.name }}
        run: |
          chmod +x ./scripts/ci/run-tests.sh
          export TEST_BIN_DIR=/tmp/test_binaries
          export TEST_TIMEOUT="2m"
          export TEST_VERBOSE="1"
          export TEST_CONFIG="/tmp/test_config.json"
          ./scripts/ci/run-tests.sh

      - name: Generate safe artifact name
        if: failure()
        id: artifact_name
        run: |
          # 将matrix.name中的特殊字符替换为下划线
          SAFE_NAME=$(echo "${{ matrix.name }}" | sed 's/[^a-zA-Z0-9_-]/_/g')
          echo "name=test_logs_${SAFE_NAME}_${{ github.run_id }}" >> $GITHUB_OUTPUT
          
      - name: Upload failure logs (GRPC + test logs)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.artifact_name.outputs.name }}
          path: /tmp/*.log
          if-no-files-found: warn

  post-check:
    name: Save Test Results to Cache
    needs: test
    if: success()
    runs-on: ubuntu-22.04
    steps:
      - name: 'Check Out'
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Run Post-Check (Save Test Results)
        uses: ./.github/actions/post-check
        with:
          cache-key-prefix: 'essential-tests'
