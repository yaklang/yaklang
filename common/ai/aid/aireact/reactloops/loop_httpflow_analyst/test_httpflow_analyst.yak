// Test script for httpflow_analyst focus mode
// Usage: go run common/yak/cmd/yak.go common/ai/aid/aireact/reactloops/loop_httpflow_analyst/test_httpflow_analyst.yak
//
// This script tests the httpflow_analyst focus mode for HTTP traffic analysis

println("=" * 60)
println("=== httpflow_analyst Focus Mode Test Suite ===")
println("=" * 60)

// Define output directory for test artifacts
outputDir := "/tmp/httpflow_analysis_reports"

// Create output directory
err := file.MkdirAll(outputDir)
if err != nil {
    println(sprintf("[WARN] Failed to create output directory: %v", err))
}
println(sprintf("\n[CONFIG] Artifact output directory: %s", outputDir))

// Test query - analyze HTTP traffic overview
query := "分析数据库中的 HTTP 流量概况，包括状态码分布、请求方法分布、主要访问的域名等，生成一份简要的流量分析报告。"

println("\n" + "-" * 60)
println("[TEST] HTTPFlow Traffic Analysis")
println("-" * 60)
println(sprintf("[QUERY] %s", query))
println("")

// Track events
streamCount := 0
eventCount := 0
artifactPath := ""
testPassed := false
errorMsg := ""
finalAnswer := ""
testStartTime := time.Now()

// Run the analysis (synchronous version)
println("[INFO] Starting HTTPFlow analysis...")

err = aim.InvokeReAct(
    query,
    aim.focus("httpflow_analyst"),
    aim.yoloMode(),
    aim.maxIteration(15),
    aim.onStream((react, event, nodeId, data) => {
        streamCount++
        dataStr := string(data)
        // Collect conclusion stream
        if nodeId == "analysis-conclusion" {
            finalAnswer = finalAnswer + dataStr
        }
        // Print key streams for debugging
        if len(dataStr) > 0 {
            if nodeId == "httpflow-query-reason" || nodeId == "evidence-reasoning" || nodeId == "report-section-content" {
                if len(dataStr) > 100 {
                    dataStr = dataStr[:97] + "..."
                }
                println(sprintf("  [STREAM:%s] %s", nodeId, dataStr))
            }
        }
    }),
    aim.onEvent((react, event) => {
        eventCount++
    }),
    aim.onFinished((react) => {
        println("\n  [FINISHED] HTTPFlow analysis loop completed")
        testPassed = true
    }),
)

testDuration := time.Now().Sub(testStartTime)

if err != nil {
    errorMsg = sprintf("%v", err)
    println(sprintf("[ERROR] Test failed: %s", errorMsg))
} else {
    if !testPassed {
        testPassed = true  // If no error, consider it passed
    }
    println(sprintf("[SUCCESS] Test completed"))
    println(sprintf("[STATS] Streams: %d, Events: %d", streamCount, eventCount))
}
println(sprintf("[DURATION] %v", testDuration))

// Check for generated artifacts
println("\n" + "-" * 60)
println("=== Generated Artifacts ===")
println("-" * 60)
println(sprintf("[INFO] Checking directory: %s", outputDir))

files := file.Ls(outputDir)
foundArtifacts := []

if files != nil && len(files) > 0 {
    for _, f := range files {
        fileName := f.Name
        filePath := outputDir + "/" + fileName
        println(sprintf("[ARTIFACT] %s", filePath))
        foundArtifacts = append(foundArtifacts, filePath)
        
        // Show markdown content preview
        if str.HasSuffix(fileName, ".md") {
            artifactPath = filePath
            content, readErr := file.ReadFile(filePath)
            if readErr == nil && content != nil {
                contentStr := string(content)
                println("\n--- Content Preview ---")
                if len(contentStr) > 1500 {
                    println(contentStr[:1500])
                    println(sprintf("\n... (truncated, total %d chars)", len(contentStr)))
                } else {
                    println(contentStr)
                }
                println("--- End Preview ---\n")
            }
        }
    }
} else {
    println("[INFO] No artifacts generated")
}

// Generate test report
println("\n" + "=" * 60)
println("=== Generating Test Report ===")
println("=" * 60)

statusStr := "FAILED"
if testPassed {
    statusStr = "PASSED"
}

conclusionStr := "The test did not complete successfully. This may be expected if the AI service is not configured or the database is empty."
if testPassed {
    conclusionStr = "The httpflow_analyst focus mode is working correctly."
}

reportContent := sprintf(`# HTTPFlow Analyst Test Report

**Test Date**: %s
**Test Status**: %s
**Duration**: %v

## Test Configuration
- Focus Mode: httpflow_analyst
- Output Directory: %s
- Max Iterations: 15

## Test Query
%s

## Results
- **Passed**: %v
- **Stream Events**: %d
- **Total Events**: %d

## Generated Artifacts
- **Report Path**: %s
- **Total Artifacts**: %d

## Conclusion
%s

---
*This report was automatically generated by the httpflow_analyst test script.*
`, 
    time.Now().Format("2006-01-02 15:04:05"),
    statusStr,
    testDuration,
    outputDir,
    query,
    testPassed,
    streamCount,
    eventCount,
    artifactPath,
    len(foundArtifacts),
    conclusionStr
)

// Save test report to loop directory
loopDir := "/Users/v1ll4n/Projects/yaklang/common/ai/aid/aireact/reactloops/loop_httpflow_analyst"
reportPath := loopDir + "/REPORT.md"
err = file.Save(reportPath, reportContent)
if err != nil {
    println(sprintf("[ERROR] Failed to save report: %v", err))
} else {
    println(sprintf("[SUCCESS] Test report saved to: %s", reportPath))
}

// Also save to /tmp for easy access
tmpReportPath := "/tmp/httpflow_analyst_test_report.md"
file.Save(tmpReportPath, reportContent)
println(sprintf("[INFO] Report also saved to: %s", tmpReportPath))

// Print the report content
println("\n" + "-" * 60)
println("=== Test Report Content ===")
println("-" * 60)
println(reportContent)

println("\n" + "=" * 60)
println("=== Test Complete ===")
println("=" * 60)

// Return overall success status
if testPassed {
    println("\n✓ Test passed!")
} else {
    println("\n✗ Test failed")
}
