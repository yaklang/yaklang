/**
 * 测试基本知识搜索功能
 * 
 * 测试场景：使用单条语义搜索查询知识库
 * 验证点：
 * 1. 搜索成功执行
 * 2. 结果被压缩并保存到 artifact
 * 3. AI 根据 next_movements 决定下一步
 * 4. 最终调用 finish_knowledge_search 生成报告
 */

log.info("========================================")
log.info("TEST: Basic Knowledge Search")
log.info("========================================")

// 测试提示词
testPrompt = "请帮我查找关于密码重置漏洞的相关知识"

// 用于捕获事件数据
artifactFilename = ""
artifactContent = ""
finalDocFilename = ""
finalDocContent = ""
searchResultsCaptured = false
executionError = nil
finishCalled = false

// 执行 knowledge_enhance 循环
log.info("Starting knowledge_enhance loop...")

aim.InvokeReAct(
    testPrompt,
    aim.focus("knowledge_enhance"),
    aim.timeout(180),  // 3分钟超时
    aim.maxIteration(8),
    aim.attachedKnowledgeBase("yaklang-yakscript-plugins"),
    aim.onEvent(func(eventType, eventData) {
        log.debug(f"Event: ${eventType}")
        
        // 捕获 artifact 文件名
        if eventType == "filesystem_pin_filename" {
            filename = string(eventData)
            log.info(f"Artifact pinned: ${filename}")
            
            // 区分知识搜索 artifact 和最终报告
            if str.Contains(filename, "knowledge_round_") {
                artifactFilename = filename
            }
            if str.Contains(filename, "knowledge_enhance_final_") {
                finalDocFilename = filename
                finishCalled = true
            }
        }
        
        // 捕获压缩结果流
        if eventType == "stream" {
            streamData = string(eventData)
            if str.Contains(streamData, "knowledge-compress") || str.Contains(streamData, "Score:") {
                searchResultsCaptured = true
                log.info("Compressed search results captured")
            }
        }
    }),
    aim.onFinished(func(result) {
        log.info("Knowledge enhance loop finished")
        
        // 读取 artifact 内容
        if artifactFilename != "" && file.IsExisted(artifactFilename) {
            content, err = file.ReadAll(artifactFilename)
            if err == nil {
                artifactContent = string(content)
            }
        }
        
        // 读取最终报告内容
        if finalDocFilename != "" && file.IsExisted(finalDocFilename) {
            content, err = file.ReadAll(finalDocFilename)
            if err == nil {
                finalDocContent = string(content)
            }
        }
    }),
    aim.onError(func(err) {
        log.error(f"Execution error: ${err}")
        executionError = err
    }),
)

// 等待完成
sleep(2)

log.info("========================================")
log.info("RUNNING ASSERTIONS")
log.info("========================================")

// 断言1：执行没有错误
assert executionError == nil, sprintf("Execution should not have errors, got: %v", executionError)

// 断言2：至少有一个 artifact 被创建
assert artifactFilename != "", "Artifact filename should not be empty"

// 断言3：artifact 文件存在
assert file.IsExisted(artifactFilename), sprintf("Artifact file should exist: %s", artifactFilename)

// 断言4：artifact 内容不为空
assert len(artifactContent) > 50, sprintf("Artifact content too short. Expected > 50 bytes, got %d bytes", len(artifactContent))

// 断言5：内容包含关键信息
assert str.Contains(artifactContent, "知识查询结果") || str.Contains(artifactContent, "查询语句"), "Artifact should contain query info"

log.info("========================================")
log.info("ALL ASSERTIONS PASSED!")
log.info("========================================")
log.info(f"Artifact Filename: ${artifactFilename}")
log.info(f"Content Length: ${len(artifactContent)} bytes")
log.info(f"Final Doc Filename: ${finalDocFilename}")
log.info(f"Finish Action Called: ${finishCalled}")
if len(artifactContent) > 500 {
    log.info(f"Content Preview: ${artifactContent[:500]}")
} else {
    log.info(f"Content Preview: ${artifactContent}")
}
