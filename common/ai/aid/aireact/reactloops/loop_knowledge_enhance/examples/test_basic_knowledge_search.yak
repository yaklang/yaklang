// test_basic_knowledge_search.yak
// 测试 loop_knowledge_enhance 的基本知识库搜索功能
// 使用 actions: search_knowledge_semantic, search_knowledge_keyword
// 
// 测试场景：基于"逻辑漏洞"知识库查询密码重置相关漏洞
//
// 测试断言：
// 1. 执行不应该失败
// 2. 必须获取到知识查询结果文件
// 3. 搜索结果应包含密码重置相关内容

var artifactFilename = ""
var artifactContent = ""
var executionError = nil
var searchResultsCaptured = false

// 测试任务：从逻辑漏洞知识库搜索密码重置漏洞
testPrompt = `请帮我从附加的知识库中查找关于"密码重置流程漏洞"的相关知识。

具体需求：
1. 搜索密码重置相关的安全漏洞类型
2. 了解密码重置流程中常见的安全问题
3. 提取关键的漏洞特征和风险描述

请使用语义搜索来查找相关信息。`

log.Info("========================================")
log.Info("Testing loop_knowledge_enhance - Basic Knowledge Search")
log.Info("========================================")

err = aim.InvokeReAct(
    testPrompt,
    aim.focus("knowledge_enhance"),
    aim.timeout(300),
    aim.maxIteration(5),
    // 附加知识库资源
    aim.attachedKnowledgeBase("逻辑漏洞"),
    aim.onEvent(func(react, event) {
        eventType = string(event.Type)
        
        // 捕获 filesystem_pin_filename 事件
        if eventType == "filesystem_pin_filename" {
            contentStr = string(event.Content)
            if len(contentStr) > 0 {
                try {
                    jsonData = json.loads(contentStr)
                    if jsonData != nil && jsonData["path"] != nil {
                        path = jsonData["path"]
                        // 捕获 knowledge_round 或 knowledge_enhance_final 文件
                        if str.Contains(path, "knowledge") {
                            artifactFilename = path
                        }
                    }
                } catch e {
                    // ignore
                }
            }
        }
        
        // 捕获搜索结果流
        if eventType == "stream" {
            contentStr = string(event.Content)
            if str.Contains(contentStr, "Score:") || str.Contains(contentStr, "片段") {
                searchResultsCaptured = true
            }
        }
    }),
    aim.onFinished(func(react) {
        if artifactFilename != "" {
            content, readErr = file.ReadFile(artifactFilename)
            if readErr == nil {
                artifactContent = string(content)
            }
        }
    }),
)

if err != nil {
    executionError = err
}

// ========================================
// 断言测试
// ========================================

log.Info("========================================")
log.Info("RUNNING ASSERTIONS")
log.Info("========================================")

// 断言1：执行不应该失败
assert executionError == nil, sprintf("ReAct execution failed: %v", executionError)

// 断言2：必须获取到知识文件路径
assert artifactFilename != "", "Failed to capture knowledge artifact filename from events"

// 断言3：知识文件必须存在
fileExists = file.IsExisted(artifactFilename)
assert fileExists, sprintf("Knowledge artifact file does not exist: %s", artifactFilename)

// 断言4：文件内容长度必须大于 50 字节
contentLen = len(artifactContent)
assert contentLen > 50, sprintf("Artifact content too short. Expected > 50 bytes, got %d bytes", contentLen)

// 断言5：内容应包含密码重置相关关键词
hasPasswordContent = str.Contains(artifactContent, "密码") || str.Contains(artifactContent, "password") || str.Contains(artifactContent, "重置") || str.Contains(artifactContent, "reset")
assert hasPasswordContent, sprintf("Artifact should contain password-related content. Content preview: %s", artifactContent[:min(len(artifactContent), 300)])

log.Info("========================================")
log.Info("ALL ASSERTIONS PASSED!")
log.Info("========================================")
log.Info("Artifact Filename: %s", artifactFilename)
log.Info("Content Length: %d bytes", contentLen)
log.Info("Search Results Captured: %v", searchResultsCaptured)
log.Info("Content Preview: %s", artifactContent[:min(len(artifactContent), 500)])

