// test_security_vulnerability_query.yak
// 测试 loop_knowledge_enhance 查询安全漏洞知识
// 
// 测试场景：查询未授权访问相关的安全漏洞
//
// 测试断言：
// 1. 执行不应该失败
// 2. 搜索结果应包含安全漏洞相关内容
// 3. 应生成最终整合文档

var artifactFilename = ""
var artifactContent = ""
var finalDocFilename = ""
var executionError = nil
var compressEventCount = 0

// 测试任务：查询未授权访问漏洞
testPrompt = `请帮我从附加的知识库中查找关于"未授权访问"和"权限绕过"相关的安全漏洞知识。

具体需求：
1. 搜索未授权密码修改漏洞
2. 搜索权限验证绕过相关问题
3. 了解这类漏洞的常见场景和危害

请尽可能全面地收集相关信息。`

log.Info("========================================")
log.Info("Testing loop_knowledge_enhance - Security Vulnerability Query")
log.Info("========================================")

err = aim.InvokeReAct(
    testPrompt,
    aim.focus("knowledge_enhance"),
    aim.timeout(360),
    aim.maxIteration(5),
    // 附加知识库资源
    aim.attachedKnowledgeBase("逻辑漏洞"),
    aim.onEvent(func(react, event) {
        eventType = string(event.Type)
        
        if eventType == "filesystem_pin_filename" {
            contentStr = string(event.Content)
            try {
                jsonData = json.loads(contentStr)
                if jsonData != nil && jsonData["path"] != nil {
                    path = jsonData["path"]
                    // 捕获最终文档
                    if str.Contains(path, "knowledge_enhance_final") {
                        finalDocFilename = path
                    } else if str.Contains(path, "knowledge") {
                        artifactFilename = path
                    }
                }
            } catch e {
                // ignore
            }
        }
        
        // 统计压缩事件
        if eventType == "stream" {
            contentStr = string(event.Content)
            if str.Contains(contentStr, "Score:") {
                compressEventCount++
            }
        }
    }),
    aim.onFinished(func(react) {
        // 优先读取最终文档
        targetFile = finalDocFilename
        if targetFile == "" {
            targetFile = artifactFilename
        }
        if targetFile != "" {
            content, readErr = file.ReadFile(targetFile)
            if readErr == nil {
                artifactContent = string(content)
            }
        }
    }),
)

if err != nil {
    executionError = err
}

// ========================================
// 断言测试
// ========================================

log.Info("========================================")
log.Info("RUNNING ASSERTIONS")
log.Info("========================================")

// 断言1：执行不应该失败
assert executionError == nil, sprintf("ReAct execution failed: %v", executionError)

// 断言2：必须获取到知识文件
hasArtifact = artifactFilename != "" || finalDocFilename != ""
assert hasArtifact, "Failed to capture any knowledge artifact filename"

// 断言3：文件内容长度必须大于 100 字节
contentLen = len(artifactContent)
assert contentLen > 100, sprintf("Artifact content too short. Expected > 100 bytes, got %d bytes", contentLen)

// 断言4：内容应包含安全/漏洞相关关键词
hasSecurityContent = str.Contains(artifactContent, "安全") || str.Contains(artifactContent, "漏洞") || str.Contains(artifactContent, "vulnerability") || str.Contains(artifactContent, "未授权") || str.Contains(artifactContent, "权限")
assert hasSecurityContent, sprintf("Artifact should contain security vulnerability content. Content: %s", artifactContent[:min(len(artifactContent), 300)])

log.Info("========================================")
log.Info("ALL ASSERTIONS PASSED!")
log.Info("========================================")
log.Info("Artifact Filename: %s", artifactFilename)
log.Info("Final Doc Filename: %s", finalDocFilename)
log.Info("Content Length: %d bytes", contentLen)
log.Info("Compress Events Count: %d", compressEventCount)
log.Info("Content Preview: %s", artifactContent[:min(len(artifactContent), 600)])

