// test_multi_query_compression.yak
// 测试 loop_knowledge_enhance 多查询压缩功能
// 
// 测试场景：多角度查询并验证压缩和评分机制
//
// 测试断言：
// 1. 执行不应该失败
// 2. 应产生多个知识 artifact 文件
// 3. 应有压缩评分输出（Score: 0.x）

var artifactFilenames = []
var artifactContent = ""
var executionError = nil
var scoreOutputCount = 0

// 测试任务：多角度查询逻辑漏洞知识
testPrompt = `请帮我从附加的知识库中全面收集"逻辑漏洞"相关的安全知识。

请从以下多个角度进行搜索：
1. 密码重置流程漏洞（password reset workflow vulnerability）
2. 验证码相关漏洞（verification code vulnerability）
3. 未授权操作漏洞（unauthorized operation）

要求：
- 使用多条查询语句进行搜索
- 尽可能覆盖不同类型的逻辑漏洞
- 提取关键的漏洞描述和安全事件`

log.Info("========================================")
log.Info("Testing loop_knowledge_enhance - Multi Query Compression")
log.Info("========================================")

err = aim.InvokeReAct(
    testPrompt,
    aim.focus("knowledge_enhance"),
    aim.timeout(420),
    aim.maxIteration(6),
    // 附加知识库资源
    aim.attachedKnowledgeBase("逻辑漏洞"),
    aim.onEvent(func(react, event) {
        eventType = string(event.Type)
        
        if eventType == "filesystem_pin_filename" {
            contentStr = string(event.Content)
            try {
                jsonData = json.loads(contentStr)
                if jsonData != nil && jsonData["path"] != nil {
                    path = jsonData["path"]
                    if str.Contains(path, "knowledge") {
                        artifactFilenames = append(artifactFilenames, path)
                    }
                }
            } catch e {
                // ignore
            }
        }
        
        // 统计 Score 输出
        if eventType == "stream" {
            contentStr = string(event.Content)
            if str.Contains(contentStr, "Score:") || str.Contains(contentStr, "score") {
                scoreOutputCount++
            }
        }
    }),
    aim.onFinished(func(react) {
        // 读取最后一个 artifact
        if len(artifactFilenames) > 0 {
            lastFile = artifactFilenames[len(artifactFilenames)-1]
            content, readErr = file.ReadFile(lastFile)
            if readErr == nil {
                artifactContent = string(content)
            }
        }
    }),
)

if err != nil {
    executionError = err
}

// ========================================
// 断言测试
// ========================================

log.Info("========================================")
log.Info("RUNNING ASSERTIONS")
log.Info("========================================")

// 断言1：执行不应该失败
assert executionError == nil, sprintf("ReAct execution failed: %v", executionError)

// 断言2：应产生至少 1 个 artifact 文件
artifactCount = len(artifactFilenames)
assert artifactCount >= 1, sprintf("Expected at least 1 artifact file, got %d", artifactCount)

// 断言3：Artifact 内容不应为空
contentLen = len(artifactContent)
assert contentLen > 0, "Artifact content is empty"

// 断言4：内容应包含漏洞相关关键词
hasVulnContent = str.Contains(artifactContent, "漏洞") || str.Contains(artifactContent, "vulnerability") || str.Contains(artifactContent, "安全") || str.Contains(artifactContent, "SECURITY")
assert hasVulnContent, sprintf("Artifact should contain vulnerability content. Content: %s", artifactContent[:min(len(artifactContent), 300)])

log.Info("========================================")
log.Info("ALL ASSERTIONS PASSED!")
log.Info("========================================")
log.Info("Total Artifact Files: %d", artifactCount)
log.Info("Score Output Count: %d", scoreOutputCount)
log.Info("Content Length: %d bytes", contentLen)

// 列出所有 artifact 文件
for i, fname in artifactFilenames {
    log.Info("  Artifact %d: %s", i+1, fname)
}

log.Info("Content Preview: %s", artifactContent[:min(len(artifactContent), 500)])

