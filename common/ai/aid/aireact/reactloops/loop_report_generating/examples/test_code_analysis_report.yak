// test_code_analysis_report.yak
// 测试 loop_report_generating 对代码进行分析并生成报告
// 使用 actions: grep_reference, read_reference_file, write_report

var reportFilename = ""
var reportContent = ""
var testPassed = false

// 测试任务：分析特定代码模块并生成技术报告
testPrompt = `请帮我分析 Yaklang 项目的嵌入资源模块。

任务：
1. 使用 read_reference_file 阅读 /Users/v1ll4n/Projects/yaklang/embed/embed.go 了解嵌入模块的实现
2. 使用 grep_reference 在该文件中搜索 "embed" 相关的关键代码
3. 基于分析结果生成一份技术分析报告

报告要求：
- 标题：Yaklang 嵌入资源模块技术分析
- 概述：模块的作用和设计目的
- 实现分析：关键代码结构说明
- 使用场景：该模块的典型应用

报告长度：150-250 字`

log.Info("========================================")
log.Info("Testing loop_report_generating - Code Analysis Report")
log.Info("========================================")
log.Info("Test prompt: %s", testPrompt)

err = aim.InvokeReAct(
    testPrompt,
    aim.focus("report_generating"),
    aim.timeout(300),
    aim.maxIteration(15),
    aim.onEvent(func(react, event) {
        eventType = string(event.Type)
        if eventType != "stream" && eventType != "consumption" && eventType != "pressure" {
            log.Info("[EVENT] Type: %s, NodeId: %s", eventType, event.NodeId)
        }
        if eventType == "filesystem_pin_filename" {
            contentStr = string(event.Content)
            log.Info("[EVENT] Pin filename! Content: %s", contentStr)
            try {
                jsonData = json.loads(contentStr)
                if jsonData != nil && jsonData["path"] != nil {
                    reportFilename = jsonData["path"]
                    log.Info("[EVENT] Extracted filename: %s", reportFilename)
                }
            } catch e {
                log.Warn("[EVENT] JSON parse failed: %v", e)
            }
        }
    }),
    aim.onData(func(react, event, nodeId, data) {
        dataStr = string(data)
        if event.Type == "stream" && nodeId != "fast-memory-fetch" {
            print(dataStr)
        }
    }),
    aim.onFinished(func(react) {
        log.Info("[FINISHED] ReAct execution completed")
        if reportFilename != "" {
            content, readErr = file.ReadFile(reportFilename)
            if readErr == nil {
                reportContent = string(content)
                // 验证报告包含关键内容
                hasEmbed = str.Contains(reportContent, "embed") || str.Contains(reportContent, "嵌入")
                if len(reportContent) > 50 && hasEmbed {
                    testPassed = true
                    log.Info("Test PASSED!")
                }
            }
        }
    }),
)

if err != nil {
    log.Error("ReAct execution failed: %v", err)
}

log.Info("========================================")
log.Info("TEST RESULTS: Test Passed: %v", testPassed)
log.Info("========================================")
if reportContent != "" {
    log.Info("Report Preview:\n%s", reportContent[:min(len(reportContent), 400)])
}

