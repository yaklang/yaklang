// test_basic_report.yak
// 测试 loop_report_generating 的基本报告生成功能
// 使用 action: write_report

// 存储最终报告文件路径
var reportFilename = ""
var reportContent = ""
var testPassed = false

// 测试任务：基于 README 生成简要报告
testPrompt = `请帮我基于 /Users/v1ll4n/Projects/yaklang/README.md 文件生成一份简要的 Yaklang 项目介绍报告。

报告要求：
1. 简要介绍项目的用途和定位
2. 列出主要功能特点
3. 总结项目的技术架构

报告长度控制在 200 字左右即可，这只是一个测试。`

log.Info("========================================")
log.Info("Testing loop_report_generating - Basic Report")
log.Info("========================================")
log.Info("Test prompt: %s", testPrompt)

err = aim.InvokeReAct(
    testPrompt,
    aim.focus("report_generating"),
    aim.timeout(300),
    aim.maxIteration(15),
    aim.onEvent(func(react, event) {
        eventType = string(event.Type)
        if eventType != "stream" && eventType != "consumption" && eventType != "pressure" {
            log.Info("[EVENT] Type: %s, NodeId: %s", eventType, event.NodeId)
        }
        
        // 捕获 filesystem_pin_filename 事件
        if eventType == "filesystem_pin_filename" {
            // event.Content 是 []byte 类型，需要转换为字符串
            contentStr = string(event.Content)
            log.Info("[EVENT] Pin filename! Content: %s", contentStr)
            if len(contentStr) > 0 {
                try {
                    jsonData = json.loads(contentStr)
                    if jsonData != nil && jsonData["path"] != nil {
                        reportFilename = jsonData["path"]
                        log.Info("[EVENT] Extracted filename: %s", reportFilename)
                    }
                } catch e {
                    log.Warn("[EVENT] JSON parse failed: %v", e)
                }
            }
        }
    }),
    aim.onData(func(react, event, nodeId, data) {
        dataStr = string(data)
        if event.Type == "stream" && nodeId != "fast-memory-fetch" {
            print(dataStr)
        }
        
        // 捕获 filesystem_pin_filename 数据
        if event.Type == "filesystem_pin_filename" && len(data) > 0 {
            try {
                jsonData = json.loads(string(data))
                if jsonData != nil && jsonData["path"] != nil && reportFilename == "" {
                    reportFilename = jsonData["path"]
                    log.Info("[DATA] Extracted filename: %s", reportFilename)
                }
            } catch e {
                dataPath = string(data)
                if str.HasSuffix(dataPath, ".md") && reportFilename == "" {
                    reportFilename = dataPath
                    log.Info("[DATA] Using data as filename: %s", reportFilename)
                }
            }
        }
    }),
    aim.onFinished(func(react) {
        log.Info("[FINISHED] ReAct execution completed, filename: %s", reportFilename)
        if reportFilename != "" {
            content, readErr = file.ReadFile(reportFilename)
            if readErr == nil {
                reportContent = string(content)
                log.Info("Report content length: %d bytes", len(reportContent))
                if len(reportContent) > 50 {
                    testPassed = true
                    log.Info("Test PASSED!")
                }
            } else {
                log.Error("Failed to read report: %v", readErr)
            }
        } else {
            log.Warn("No filename captured")
        }
    }),
)

if err != nil {
    log.Error("ReAct execution failed: %v", err)
}

log.Info("========================================")
log.Info("TEST RESULTS: Test Passed: %v", testPassed)
log.Info("========================================")

