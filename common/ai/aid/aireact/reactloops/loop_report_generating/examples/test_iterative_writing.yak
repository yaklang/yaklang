// test_iterative_writing.yak
// 测试 loop_report_generating 的迭代写作功能
// 使用 actions: read_reference_file, write_report, insert_section, modify_section
//
// 测试断言：
// 1. 必须成功获取报告文件路径
// 2. 报告内容长度必须大于 100 字节
// 3. 报告应包含多个章节结构

var reportFilename = ""
var reportContent = ""
var executionError = nil

// 测试任务：分步骤生成并完善报告
testPrompt = `请帮我撰写一份 Yaklang 项目的技术白皮书（简化版）。

任务分步骤执行：

第一步：阅读 /Users/v1ll4n/Projects/yaklang/README.md 获取基础信息

第二步：使用 write_report 创建初始报告，包含以下结构：
- 标题：Yaklang 技术白皮书（简化版）
- 第一章：项目背景（占位符内容）
- 第二章：核心技术（占位符内容）

第三步：使用 insert_section 在第二章后添加"第三章：应用场景"

第四步：使用 modify_section 将第一章的占位符替换为真实内容

注意：这是一个测试分步写作流程的任务，报告总长度控制在 300 字左右。`

log.Info("========================================")
log.Info("Testing loop_report_generating - Iterative Writing")
log.Info("========================================")

err = aim.InvokeReAct(
    testPrompt,
    aim.focus("report_generating"),
    aim.timeout(420),
    aim.maxIteration(25),
    aim.onEvent(func(react, event) {
        eventType = string(event.Type)
        if eventType == "filesystem_pin_filename" {
            contentStr = string(event.Content)
            try {
                jsonData = json.loads(contentStr)
                if jsonData != nil && jsonData["path"] != nil {
                    reportFilename = jsonData["path"]
                }
            } catch e {
                // ignore
            }
        }
    }),
    aim.onFinished(func(react) {
        if reportFilename != "" {
            content, readErr = file.ReadFile(reportFilename)
            if readErr == nil {
                reportContent = string(content)
            }
        }
    }),
)

if err != nil {
    executionError = err
}

// ========================================
// 断言测试
// ========================================

log.Info("========================================")
log.Info("RUNNING ASSERTIONS")
log.Info("========================================")

// 断言1：执行不应该失败
assert executionError == nil, sprintf("ReAct execution failed: %v", executionError)

// 断言2：必须获取到报告文件路径
assert reportFilename != "", "Failed to capture report filename from events"

// 断言3：报告文件必须存在
assert file.IsExisted(reportFilename), sprintf("Report file does not exist: %s", reportFilename)

// 断言4：报告内容长度必须大于 100 字节
contentLen = len(reportContent)
assert contentLen > 100, sprintf("Report content too short. Expected > 100 bytes, got %d bytes", contentLen)

// 断言5：报告应包含章节结构
hasChapter = str.Contains(reportContent, "第一章") || str.Contains(reportContent, "项目背景") || str.Contains(reportContent, "第二章") || str.Contains(reportContent, "核心技术") || str.Contains(reportContent, "##")
assert hasChapter, sprintf("Report should have chapter structure. Content: %s", reportContent[:min(len(reportContent), 400)])

log.Info("========================================")
log.Info("ALL ASSERTIONS PASSED!")
log.Info("========================================")
log.Info("Report Filename: %s", reportFilename)
log.Info("Report Content Length: %d bytes", contentLen)
log.Info("Full Report:\n%s", reportContent)
