// test_change_view_offset.yak
// 测试 loop_report_generating 的 change_view_offset 分页导航功能
// 使用 actions: write_report, change_view_offset, insert_section
//
// 测试断言：
// 1. 必须成功获取报告文件路径
// 2. 报告内容长度必须大于 500 字节
// 3. 报告行数应该大于 30 行

var reportFilename = ""
var reportContent = ""
var executionError = nil

// 测试任务：生成一个较长的报告
testPrompt = `请帮我生成一份详细的 Yaklang 网络安全工具分析报告。

任务要求：

**第一步：创建初始报告**
请首先使用 write_report 创建一份包含以下章节的详细报告：

1. 引言（介绍 Yaklang 的背景和目标）
2. 核心功能分析
   - 端口扫描能力
   - 漏洞检测能力
   - 协议分析能力
3. SSA 静态分析引擎
   - 技术原理
   - 应用场景
4. 插件系统
   - 架构设计
   - 扩展机制
5. 总结与展望

每个章节都需要包含 5-10 行详细内容，确保报告总长度超过 50 行。

**第二步：测试视图导航**
如果报告足够长（超过 30KB），请使用 change_view_offset 来导航查看不同部分。

**第三步：在中间位置插入内容**
使用 insert_section 在报告中间位置（大约第 25 行后）插入一个新章节"安全最佳实践"，包含 3-5 行内容。

这是一个测试分页导航功能的任务，请务必完成上述所有步骤。`

log.Info("========================================")
log.Info("Testing loop_report_generating - Change View Offset")
log.Info("========================================")

err = aim.InvokeReAct(
    testPrompt,
    aim.focus("report_generating"),
    aim.timeout(600),
    aim.maxIteration(25),
    aim.onEvent(func(react, event) {
        eventType = string(event.Type)
        if eventType == "filesystem_pin_filename" {
            contentStr = string(event.Content)
            try {
                jsonData = json.loads(contentStr)
                if jsonData != nil && jsonData["path"] != nil {
                    reportFilename = jsonData["path"]
                }
            } catch e {
                // ignore
            }
        }
    }),
    aim.onFinished(func(react) {
        if reportFilename != "" {
            content, readErr = file.ReadFile(reportFilename)
            if readErr == nil {
                reportContent = string(content)
            }
        }
    }),
)

if err != nil {
    executionError = err
}

// ========================================
// 断言测试
// ========================================

log.Info("========================================")
log.Info("RUNNING ASSERTIONS")
log.Info("========================================")

// 断言1：执行不应该失败
assert executionError == nil, sprintf("ReAct execution failed: %v", executionError)

// 断言2：必须获取到报告文件路径
assert reportFilename != "", "Failed to capture report filename from events"

// 断言3：报告文件必须存在
assert file.IsExisted(reportFilename), sprintf("Report file does not exist: %s", reportFilename)

// 断言4：报告内容长度必须大于 500 字节
contentLen = len(reportContent)
assert contentLen > 500, sprintf("Report content too short. Expected > 500 bytes, got %d bytes", contentLen)

// 断言5：报告行数应该大于 30 行
lines = str.Split(reportContent, "\n")
lineCount = len(lines)
assert lineCount > 30, sprintf("Report should have more than 30 lines. Got %d lines", lineCount)

// 断言6：报告应该包含章节标题
hasChapters = str.Contains(reportContent, "引言") || str.Contains(reportContent, "核心功能") || str.Contains(reportContent, "SSA") || str.Contains(reportContent, "##")
assert hasChapters, sprintf("Report should have chapter structure. Content preview: %s", reportContent[:min(len(reportContent), 500)])

log.Info("========================================")
log.Info("ALL ASSERTIONS PASSED!")
log.Info("========================================")
log.Info("Report Filename: %s", reportFilename)
log.Info("Report Content Length: %d bytes", contentLen)
log.Info("Report Line Count: %d lines", lineCount)
log.Info("Report Preview (first 500 chars): %s", reportContent[:min(len(reportContent), 500)])
