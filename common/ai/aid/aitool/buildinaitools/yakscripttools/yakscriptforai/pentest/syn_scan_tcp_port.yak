__KEYWORDS__ = "指纹扫描,syn扫描,tcp扫描,连接扫描,网络扫描,安全,扫描,网络安全,端口扫描,快速扫描"
__VERBOSE_NAME__ = "SYN+TCP指纹扫描"
__DESC__ = <<<EOF
使用SYN+TCP连接进行指纹扫描，这种扫描方式快于完全TCP扫描，但是可能会错误，如果出现了问题，请及时使用TCP扫描重试
EOF

__USAGE__ = <<<USAGE_BLOCK
SYN + TCP Fingerprint Scanner - Parameter Description for JSON Tool Calls

Required Parameters:
  hosts           (string)  The target hosts to scan. Supports one or more targets
                            separated by comma ",". Accepts domain names, IPs, and
                            CIDR notation. Example: "www.example.com,192.168.1.1".

Optional Parameters:
  ports           (string)  The ports to scan. Supports individual ports, ranges, and
                            comma-separated combinations.
                            Default: "22,443,445,80,8000-8004,3306,3389,5432,8080-8084,7000-7005".
  synscan-concurrent (int)  Number of concurrent SYN scan threads. SYN scanning is
                            the first phase (fast port discovery). Default: 2000.
  tcpscan-concurrent (int)  Number of concurrent TCP scan threads. TCP scanning is
                            the second phase (service fingerprinting). Default: 50.
  web             (bool)    Enable web service scanning. Set to true if you suspect
                            the target is running a web service. Default: false.
  not-http        (bool)    Set to true if you are certain the target is NOT an HTTP
                            service. This improves scanning efficiency. Default: false.
  active          (bool)    Enable active probing mode. When true, the scanner will
                            actively send packets to detect service fingerprints.
                            Default: false.
USAGE_BLOCK

yakit.AutoInitYakit()
target := cli.String("hosts", cli.setHelp("the targets u want to scan, input one or more target, use comma ',' as split, like 'www.example.com,192.168.1.1'"), cli.setRequired(true))
// target = "www.example.com"
ports := cli.String("ports", cli.setHelp("the ports you want to scan"), cli.setRequired(false), cli.setDefault("22,443,445,80,8000-8004,3306,3389,5432,8080-8084,7000-7005"))
synConcurrent := cli.Int("synscan-concurrent", cli.setHelp("the current syn scan"), cli.setDefault(2000))
tcpConcurrent := cli.Int("tcpscan-concurrent", cli.setHelp("the current tcp scan"), cli.setDefault(50))
webservice := cli.Bool("web", cli.setHelp("enable web servicescan, if you think it's a website"))
notHttpService := cli.Bool("not-http", cli.setHelp("if u are sure it' not a http service, use this flag to improve"))
active := cli.Bool("active", cli.setHelp("打开这个选项后会主动发包探测指纹"))
cli.check()

opts = []
opts.Push(servicescan.concurrent(tcpConcurrent))
if webservice {
    opts.Push(servicescan.web())
}
if notHttpService {
    opts.Push(servicescan.service())
}

opts.Push(servicescan.onOpen(i => {
    yakit.Info("%v is open", i.String())
}))

opts.Push(servicescan.probeTimeout(5))
if active {
    opts.Push(servicescan.active(true))
}


start := time.Now()
defer func{
    yakit.Info("cost: %v", time.Now().Sub(start).String())
}

synChan, err := synscan.Scan(target /*type: string*/, ports /*type: string*/, synscan.callback(result => {
    yakit.Info("synscan: %v", result.String())
}))
if err != nil {
    yakit.Error("Fatal: SYNSCAN 无法使用，请你使用tcp端口扫描：%v", err)
    return
}

results, err := servicescan.ScanFromSynResult(synChan, opts...)
if err != nil {
    yakit.Error("failed: %v", err)
    return
}
closed := []
tcpPortScanOpen=0
for result in results {
    if !result.IsOpen() {
        closed.Push(str.HostPort(result.Target, result.Port))
        continue
    }
    tcpPortScanOpen++
    glance := result.String()
    banner := result.GetBanner()
    yakit.Info("find: %v banner: %v", glance, banner)
}
if closed.Len() > 0 {
    yakit.Info("closed addr: %v", closed)
}
yakit.Info("exit successfully, tcp open port:%v, total: %v", tcpPortScanOpen, tcpPortScanOpen + closed.Len())