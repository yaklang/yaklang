__DESC__ = "一个基于TCP连接的服务指纹扫描工具，用于探测目标主机指定端口的服务类型和信息，支持并发扫描、网页服务识别和主动探测。"
__VERBOSE_NAME__ = "TCP服务指纹扫描工具"
__KEYWORDS__ = "服务扫描,指纹识别,tcp扫描,端口扫描,网络探测,主机发现,服务识别,端口开放,网络安全"

__USAGE__ = <<<USAGE_BLOCK
TCP Service Fingerprint Scanner - Parameter Description for JSON Tool Calls

Required Parameters:
  hosts           (string)  The target hosts to scan. Supports one or more targets
                            separated by comma ",". Accepts domain names, IPs, and
                            CIDR notation. Example: "www.example.com,192.168.1.1".

Optional Parameters:
  ports           (string)  The ports to scan. Supports individual ports, ranges, and
                            comma-separated combinations.
                            Default: "22,443,445,80,8000-8004,3306,3389,5432,8080-8084,7000-7005".
  concurrent      (int)     Number of concurrent scanning threads. Default: 100.
  web             (bool)    Enable web service scanning. Set to true if you suspect
                            the target is running a web service. Default: false.
  not-http        (bool)    Set to true if you are certain the target is NOT an HTTP
                            service. This improves scanning efficiency. Default: false.
  active          (bool)    Enable active probing mode. When true, the scanner will
                            actively send packets to detect service fingerprints.
                            Default: false.
USAGE_BLOCK

yakit.AutoInitYakit()
target := cli.String("hosts", cli.setHelp("the targets u want to scan, input one or more target, use comma ',' as split, like 'www.example.com,192.168.1.1'"), cli.setRequired(true))
// target = "www.example.com"
ports := cli.String("ports", cli.setHelp("the ports you want to scan"), cli.setRequired(false), cli.setDefault("22,443,445,80,8000-8004,3306,3389,5432,8080-8084,7000-7005"))
concurrent := cli.Int("concurrent", cli.setHelp("the current scan service"), cli.setDefault(100))
webservice := cli.Bool("web", cli.setHelp("enable web servicescan, if you think it's a website"))
notHttpService := cli.Bool("not-http", cli.setHelp("if u are sure it' not a http service, use this flag to improve"))
active := cli.Bool("active", cli.setHelp("打开这个选项后会主动发包探测指纹"))
cli.check()

opts = []
opts.Push(servicescan.concurrent(concurrent))
if webservice {
    opts.Push(servicescan.web())
}
if notHttpService {
    opts.Push(servicescan.service())
}

opts.Push(servicescan.onOpen(i => {
    yakit.Info("%v is open", i.String())
}))

opts.Push(servicescan.probeTimeout(5))
if active {
    opts.Push(servicescan.active(true))
}


start := time.Now()
defer func{
    yakit.Info("cost: %v", time.Now().Sub(start).String())
}
results, err := servicescan.Scan(target, ports, opts...)
if err != nil {
    yakit.Error("failed: %v", err)
    return
}
closed := []
for result in results {
    if !result.IsOpen() {
        closed.Push(str.HostPort(result.Target, result.Port))
        continue
    }
    glance := result.String()
    banner := result.GetBanner()
    yakit.Info("find: %v banner: %v", glance, banner)
}
if closed.Len() > 0 {
    yakit.Info("closed addr: %v", closed)
}