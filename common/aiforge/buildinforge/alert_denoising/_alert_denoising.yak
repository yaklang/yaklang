log_file = cli.String("log-file", cli.setRequired(true), cli.setHelp("å‘Šè­¦æ—¥å¿—æ–‡ä»¶è·¯å¾„"))
cli.check()

// safeVar å®‰å…¨è·å–åµŒå¥—å¯¹è±¡çš„å€¼
safeVar = (val, member) => {
    try {
        if val == nil || val == "" {
            return ""
        }
        members = str.Split(member, ".")
        finallyVal = val
        for i in members {
            finallyVal = finallyVal.$i
        }
        return finallyVal
    } catch e {
        return ""
    }
}

// generateSeverityStatsTable ç”Ÿæˆä¸¥é‡ç¨‹åº¦ç»Ÿè®¡è¡¨æ ¼
func generateSeverityStatsTable(bySeverity) {
    lines = []
    lines = append(lines, "| ä¸¥é‡ç¨‹åº¦ | æ•°é‡ | å æ¯” |")
    lines = append(lines, "|----------|------|------|")
    
    severityLevels = ["critical", "high", "medium", "low", "info"]
    severityNames = {
        "critical": "ğŸ”´ ä¸¥é‡",
        "high": "ğŸŸ  é«˜å±",
        "medium": "ğŸŸ¡ ä¸­ç­‰",
        "low": "ğŸŸ¢ ä½å±",
        "info": "ğŸ”µ ä¿¡æ¯"
    }
    
    for _, level := range severityLevels {
        levelData = bySeverity[level]
        if levelData != nil {
            count = safeVar(levelData, "count")
            percentage = safeVar(levelData, "percentage")
            name = severityNames[level]
            lines = append(lines, sprintf("| %s | %v | %.1f%% |", name, count, percentage))
        }
    }
    
    return str.Join(lines, "\n")
}

// generateTypeStatsTable ç”Ÿæˆå‘Šè­¦ç±»å‹ç»Ÿè®¡è¡¨æ ¼ï¼ˆTop 10ï¼‰
func generateTypeStatsTable(byType) {
    if len(byType) == 0 {
        return "æš‚æ— æ•°æ®"
    }
    
    lines = []
    lines = append(lines, "| å‘Šè­¦ç±»å‹ | æ•°é‡ | å æ¯” | æ˜¯å¦å™ªå£° |")
    lines = append(lines, "|----------|------|------|----------|")
    
    for _, typeData := range byType {
        typeName = safeVar(typeData, "type")
        count = safeVar(typeData, "count")
        percentage = safeVar(typeData, "percentage")
        isNoise = safeVar(typeData, "is_noise")
        
        noiseLabel = isNoise ? "âœ… å™ªå£°" : "âš ï¸ å¨èƒ"
        lines = append(lines, sprintf("| %v | %v | %.1f%% | %s |", typeName, count, percentage, noiseLabel))
    }
    
    return str.Join(lines, "\n")
}

// generateSourceStatsTable ç”Ÿæˆæ¥æºç»Ÿè®¡è¡¨æ ¼ï¼ˆTop 10ï¼‰
func generateSourceStatsTable(bySource) {
    if len(bySource) == 0 {
        return "æš‚æ— æ•°æ®"
    }
    
    lines = []
    lines = append(lines, "| æ¥æºåœ°å€ | æ€»æ•° | å¨èƒæ•° | å™ªå£°æ•° |")
    lines = append(lines, "|----------|------|--------|--------|")
    
    for _, sourceData := range bySource {
        source = safeVar(sourceData, "source")
        count = safeVar(sourceData, "count")
        threatCount = safeVar(sourceData, "threat_count")
        noiseCount = safeVar(sourceData, "noise_count")
        
        lines = append(lines, sprintf("| %v | %v | %v | %v |", source, count, threatCount, noiseCount))
    }
    
    return str.Join(lines, "\n")
}

// generateNoiseCategoriesText ç”Ÿæˆå™ªå£°ç±»åˆ«åˆ†ææ–‡æœ¬
func generateNoiseCategoriesText(noiseCategories) {
    if len(noiseCategories) == 0 {
        return "âœ… æœªè¯†åˆ«åˆ°å™ªå£°ç±»åˆ«"
    }
    
    lines = []
    for _, category := range noiseCategories {
        categoryName = safeVar(category, "category")
        count = safeVar(category, "count")
        percentage = safeVar(category, "percentage")
        examples = category["examples"]
        
        lines = append(lines, sprintf("### %s", categoryName))
        lines = append(lines, sprintf("- **æ•°é‡**: %v", count))
        lines = append(lines, sprintf("- **å æ¯”**: %.1f%%", percentage))
        
        if examples != nil && len(examples) > 0 {
            lines = append(lines, "- **å…¸å‹ç¤ºä¾‹**:")
            for _, example := range examples {
                lines = append(lines, sprintf("  - %v", example))
            }
        }
        lines = append(lines, "")
    }
    
    return str.Join(lines, "\n")
}

// generateNoisePatternsList ç”Ÿæˆå™ªå£°æ¨¡å¼åˆ—è¡¨
func generateNoisePatternsList(topNoisePatterns) {
    if len(topNoisePatterns) == 0 {
        return "âœ… æœªå‘ç°é‡å¤å™ªå£°æ¨¡å¼"
    }
    
    lines = []
    for idx, pattern := range topNoisePatterns {
        patternText = safeVar(pattern, "pattern")
        count = safeVar(pattern, "count")
        patternType = safeVar(pattern, "type")
        recommendation = safeVar(pattern, "recommendation")
        
        lines = append(lines, sprintf("#### %d. %s", idx+1, patternText))
        lines = append(lines, sprintf("- **å‡ºç°æ¬¡æ•°**: %v", count))
        lines = append(lines, sprintf("- **ç±»å‹**: %v", patternType))
        lines = append(lines, sprintf("- **å»ºè®®**: %v", recommendation))
        lines = append(lines, "")
    }
    
    return str.Join(lines, "\n")
}

// generateThreatsList ç”Ÿæˆå¨èƒåˆ—è¡¨
func generateThreatsList(threats, level) {
    if len(threats) == 0 {
        return sprintf("âœ… æœªå‘ç°%så¨èƒ", level)
    }
    
    lines = []
    for _, threat := range threats {
        threatId = safeVar(threat, "id")
        threatType = safeVar(threat, "type")
        source = safeVar(threat, "source")
        target = safeVar(threat, "target")
        timestamp = safeVar(threat, "timestamp")
        description = safeVar(threat, "description")
        impact = safeVar(threat, "impact")
        riskScore = safeVar(threat, "risk_score")
        
        lines = append(lines, sprintf("#### ğŸš¨ %s", threatType))
        lines = append(lines, sprintf("- **ID**: %v", threatId))
        lines = append(lines, sprintf("- **æ¥æº**: %v", source))
        if target != "" {
            lines = append(lines, sprintf("- **ç›®æ ‡**: %v", target))
        }
        lines = append(lines, sprintf("- **æ—¶é—´**: %v", timestamp))
        lines = append(lines, sprintf("- **æè¿°**: %v", description))
        if impact != "" {
            lines = append(lines, sprintf("- **å½±å“**: %v", impact))
        }
        lines = append(lines, sprintf("- **é£é™©è¯„åˆ†**: %.1f", riskScore))
        lines = append(lines, "")
        lines = append(lines, "---")
        lines = append(lines, "")
    }
    
    return str.Join(lines, "\n")
}

// generateAttackChainsList ç”Ÿæˆæ”»å‡»é“¾åˆ—è¡¨
func generateAttackChainsList(attackChains) {
    if len(attackChains) == 0 {
        return "âœ… æœªå‘ç°å…³è”æ”»å‡»é“¾"
    }
    
    lines = []
    for _, chain := range attackChains {
        chainId = safeVar(chain, "chain_id")
        source = safeVar(chain, "source")
        stages = chain["stages"]
        totalAlerts = safeVar(chain, "total_alerts")
        timeSpan = safeVar(chain, "time_span")
        riskLevel = safeVar(chain, "risk_level")
        
        lines = append(lines, sprintf("### æ”»å‡»é“¾ %s", chainId))
        lines = append(lines, sprintf("- **æ¥æº**: %v", source))
        lines = append(lines, sprintf("- **å‘Šè­¦æ•°**: %v", totalAlerts))
        lines = append(lines, sprintf("- **æ—¶é—´è·¨åº¦**: %v", timeSpan))
        lines = append(lines, sprintf("- **é£é™©ç­‰çº§**: %v", riskLevel))
        
        if stages != nil && len(stages) > 0 {
            lines = append(lines, "- **æ”»å‡»é˜¶æ®µ**:")
            for idx, stage := range stages {
                stageName = safeVar(stage, "stage")
                stageTime = safeVar(stage, "timestamp")
                alertType = safeVar(stage, "alert_type")
                lines = append(lines, sprintf("  %d. **%s** (%s) - %s", idx+1, stageName, stageTime, alertType))
            }
        }
        lines = append(lines, "")
        lines = append(lines, "---")
        lines = append(lines, "")
    }
    
    return str.Join(lines, "\n")
}

// generatePriorityAlertsList ç”Ÿæˆä¼˜å…ˆçº§å‘Šè­¦åˆ—è¡¨
func generatePriorityAlertsList(alerts, priority) {
    if len(alerts) == 0 {
        return sprintf("âœ… æ— %sä¼˜å…ˆçº§å‘Šè­¦", priority)
    }
    
    lines = []
    for idx, alert := range alerts {
        alertId = safeVar(alert, "alert_id")
        alertType = safeVar(alert, "type")
        source = safeVar(alert, "source")
        target = safeVar(alert, "target")
        description = safeVar(alert, "description")
        actionRequired = safeVar(alert, "action_required")
        
        lines = append(lines, sprintf("#### %d. %s", idx+1, alertType))
        lines = append(lines, sprintf("- **ID**: %v", alertId))
        lines = append(lines, sprintf("- **æ¥æº**: %v", source))
        if target != "" {
            lines = append(lines, sprintf("- **ç›®æ ‡**: %v", target))
        }
        lines = append(lines, sprintf("- **æè¿°**: %v", description))
        lines = append(lines, sprintf("- **å¤„ç½®æªæ–½**: %v", actionRequired))
        lines = append(lines, "")
    }
    
    return str.Join(lines, "\n")
}

// generateRecommendationsList ç”Ÿæˆå»ºè®®åˆ—è¡¨
func generateRecommendationsList(recommendations, recType) {
    if len(recommendations) == 0 {
        return sprintf("âœ… æš‚æ— %så»ºè®®", recType)
    }
    
    lines = []
    for idx, rec := range recommendations {
        action = safeVar(rec, "action")
        reason = safeVar(rec, "reason")
        expectedImpact = safeVar(rec, "expected_impact")
        
        // å¤„ç†ä¸åŒç±»å‹çš„å»ºè®®å­—æ®µ
        if action == "" {
            action = safeVar(rec, "rule_type")
        }
        if action == "" {
            action = safeVar(rec, "aggregation_type")
        }
        if action == "" {
            action = safeVar(rec, "automation_type")
        }
        if action == "" {
            action = safeVar(rec, "improvement_area")
        }
        
        currentIssue = safeVar(rec, "current_issue")
        optimization = safeVar(rec, "optimization")
        targetAlerts = safeVar(rec, "target_alerts")
        method = safeVar(rec, "method")
        benefit = safeVar(rec, "benefit")
        targetScenario = safeVar(rec, "target_scenario")
        implementation = safeVar(rec, "implementation")
        efficiencyGain = safeVar(rec, "efficiency_gain")
        currentGap = safeVar(rec, "current_gap")
        recommendation = safeVar(rec, "recommendation")
        
        lines = append(lines, sprintf("#### %d. %s", idx+1, action))
        
        if reason != "" {
            lines = append(lines, sprintf("- **åŸå› **: %v", reason))
        }
        if currentIssue != "" {
            lines = append(lines, sprintf("- **å½“å‰é—®é¢˜**: %v", currentIssue))
        }
        if currentGap != "" {
            lines = append(lines, sprintf("- **å½“å‰ä¸è¶³**: %v", currentGap))
        }
        if optimization != "" {
            lines = append(lines, sprintf("- **ä¼˜åŒ–æ–¹æ¡ˆ**: %v", optimization))
        }
        if targetAlerts != "" {
            lines = append(lines, sprintf("- **ç›®æ ‡å‘Šè­¦**: %v", targetAlerts))
        }
        if method != "" {
            lines = append(lines, sprintf("- **æ–¹æ³•**: %v", method))
        }
        if targetScenario != "" {
            lines = append(lines, sprintf("- **é€‚ç”¨åœºæ™¯**: %v", targetScenario))
        }
        if implementation != "" {
            lines = append(lines, sprintf("- **å®æ–½æ–¹æ¡ˆ**: %v", implementation))
        }
        if recommendation != "" {
            lines = append(lines, sprintf("- **å»ºè®®**: %v", recommendation))
        }
        if expectedImpact != "" {
            lines = append(lines, sprintf("- **é¢„æœŸæ•ˆæœ**: %v", expectedImpact))
        }
        if benefit != "" {
            lines = append(lines, sprintf("- **æ”¶ç›Š**: %v", benefit))
        }
        if efficiencyGain != "" {
            lines = append(lines, sprintf("- **æ•ˆç‡æå‡**: %v", efficiencyGain))
        }
        
        lines = append(lines, "")
    }
    
    return str.Join(lines, "\n")
}

// generateSummaryMessage ç”Ÿæˆæ€»ç»“ä¿¡æ¯
func generateSummaryMessage(executiveSummary) {
    messages = []
    
    criticalThreats = safeVar(executiveSummary, "critical_threats")
    threatCount = safeVar(executiveSummary, "threat_count")
    noiseRatio = safeVar(executiveSummary, "noise_ratio")
    
    if criticalThreats > 0 {
        messages = append(messages, sprintf("ğŸš¨ **ç´§æ€¥å…³æ³¨**: å‘ç° %v ä¸ªä¸¥é‡å¨èƒï¼Œéœ€è¦ç«‹å³å¤„ç†", criticalThreats))
    }
    
    if threatCount > 0 {
        messages = append(messages, sprintf("âš ï¸ **å¨èƒæ€»æ•°**: å…±è¯†åˆ«å‡º %v ä¸ªçœŸå®å¨èƒ", threatCount))
    }
    
    if noiseRatio >= 50 {
        messages = append(messages, sprintf("ğŸ“Š **é™å™ªæ•ˆæœ**: å™ªå£°æ¯”ä¾‹ä¸º %.1f%%ï¼Œå»ºè®®ä¼˜åŒ–å‘Šè­¦è§„åˆ™ä»¥å‡å°‘è¯¯æŠ¥", noiseRatio))
    } else {
        messages = append(messages, sprintf("âœ… **å‘Šè­¦è´¨é‡**: å™ªå£°æ¯”ä¾‹ä¸º %.1f%%ï¼Œå‘Šè­¦è´¨é‡è¾ƒå¥½", noiseRatio))
    }
    
    return str.Join(messages, "\n\n")
}

forgeHandle = func(params, opts...) {
    result, err = __DEFAULT_FORGE_HANDLE__(params, opts...)
    if err != nil {
        return nil
    }
    
    // è·å–å„ä¸ªéƒ¨åˆ†çš„æ•°æ®
    executiveSummary = result.Action.GetInvokeParams("executive_summary")
    statistics = result.Action.GetInvokeParams("statistics")
    noiseAnalysis = result.Action.GetInvokeParams("noise_analysis")
    threatAnalysis = result.Action.GetInvokeParams("threat_analysis")
    priorityAlerts = result.Action.GetInvokeParams("priority_alerts")
    recommendations = result.Action.GetInvokeParams("recommendations")
    conclusion = result.Action.GetInvokeParams("conclusion")
    
    // ç”Ÿæˆå„ä¸ªéƒ¨åˆ†çš„æ–‡æœ¬
    severityStatsTable = generateSeverityStatsTable(statistics["by_severity"])
    typeStatsTable = generateTypeStatsTable(statistics["by_type"])
    sourceStatsTable = generateSourceStatsTable(statistics["by_source"])
    
    noiseCategoriesText = generateNoiseCategoriesText(noiseAnalysis["noise_categories"])
    noisePatternsText = generateNoisePatternsList(noiseAnalysis["top_noise_patterns"])
    
    criticalThreatsText = generateThreatsList(threatAnalysis["critical_threats"], "ä¸¥é‡")
    highThreatsText = generateThreatsList(threatAnalysis["high_threats"], "é«˜å±")
    attackChainsText = generateAttackChainsList(threatAnalysis["attack_chains"])
    
    p0AlertsText = generatePriorityAlertsList(priorityAlerts["p0_immediate"], "P0")
    p1AlertsText = generatePriorityAlertsList(priorityAlerts["p1_high"], "P1")
    p2AlertsText = generatePriorityAlertsList(priorityAlerts["p2_medium"], "P2")
    
    immediateActionsText = generateRecommendationsList(recommendations["immediate_actions"], "ç«‹å³æªæ–½")
    ruleOptimizationText = generateRecommendationsList(recommendations["rule_optimization"], "è§„åˆ™ä¼˜åŒ–")
    alertAggregationText = generateRecommendationsList(recommendations["alert_aggregation"], "å‘Šè­¦èšåˆ")
    automationText = generateRecommendationsList(recommendations["automation_suggestions"], "è‡ªåŠ¨åŒ–")
    monitoringText = generateRecommendationsList(recommendations["monitoring_improvements"], "ç›‘æ§æ”¹è¿›")
    
    summaryMessage = generateSummaryMessage(executiveSummary)
    
    // è·å–å…³é”®å‘ç°
    keyFindings = executiveSummary["key_findings"]
    keyFindingsText = ""
    if keyFindings != nil && len(keyFindings) > 0 {
        keyFindingsLines = []
        for _, finding := range keyFindings {
            keyFindingsLines = append(keyFindingsLines, sprintf("- %v", finding))
        }
        keyFindingsText = str.Join(keyFindingsLines, "\n")
    }
    
    // è·å–ç»“è®ºéƒ¨åˆ†
    keyTakeaways = conclusion["key_takeaways"]
    keyTakeawaysText = ""
    if keyTakeaways != nil && len(keyTakeaways) > 0 {
        keyTakeawaysLines = []
        for _, takeaway := range keyTakeaways {
            keyTakeawaysLines = append(keyTakeawaysLines, sprintf("- %v", takeaway))
        }
        keyTakeawaysText = str.Join(keyTakeawaysLines, "\n")
    }
    
    nextSteps = conclusion["next_steps"]
    nextStepsText = ""
    if nextSteps != nil && len(nextSteps) > 0 {
        nextStepsLines = []
        for idx, step := range nextSteps {
            nextStepsLines = append(nextStepsLines, sprintf("%d. %v", idx+1, step))
        }
        nextStepsText = str.Join(nextStepsLines, "\n")
    }
    
    // ç”ŸæˆæŠ¥å‘Šæ¨¡æ¿
    reportTemplate = f`# ğŸ” å®‰å…¨å‘Šè­¦é™å™ªåˆ†ææŠ¥å‘Š

## ğŸ“Š æ‰§è¡Œæ‘˜è¦

| é¡¹ç›® | å€¼ |
|------|-----|
| **åˆ†ææ—¶é—´** | ${safeVar(executiveSummary, "analysis_time")} |
| **æ—¥å¿—æ–‡ä»¶** | ${safeVar(executiveSummary, "log_file")} |
| **æ—¶é—´èŒƒå›´** | ${safeVar(executiveSummary, "time_range.start")} è‡³ ${safeVar(executiveSummary, "time_range.end")} |
| **æ—¶é—´è·¨åº¦** | ${safeVar(executiveSummary, "time_range.duration")} |
| **å‘Šè­¦æ€»æ•°** | ${safeVar(executiveSummary, "total_alerts")} |
| **å™ªå£°å‘Šè­¦** | ${safeVar(executiveSummary, "noise_count")} |
| **å™ªå£°æ¯”ä¾‹** | ${safeVar(executiveSummary, "noise_ratio")}% |
| **çœŸå®å¨èƒ** | ${safeVar(executiveSummary, "threat_count")} |
| **ä¸¥é‡å¨èƒ** | ${safeVar(executiveSummary, "critical_threats")} |

### ğŸ¯ å…³é”®å‘ç°

${keyFindingsText}

## ğŸ“ˆ ç»Ÿè®¡åˆ†æ

### æŒ‰ä¸¥é‡ç¨‹åº¦ç»Ÿè®¡

${severityStatsTable}

### æŒ‰å‘Šè­¦ç±»å‹ç»Ÿè®¡ï¼ˆTop 10ï¼‰

${typeStatsTable}

### æŒ‰æ¥æºç»Ÿè®¡ï¼ˆTop 10ï¼‰

${sourceStatsTable}

## ğŸ”‡ å™ªå£°åˆ†æ

### å™ªå£°ç±»åˆ«åˆ†å¸ƒ

${noiseCategoriesText}

### Top å™ªå£°æ¨¡å¼

${noisePatternsText}

## ğŸš¨ å¨èƒåˆ†æ

### å¨èƒæ¦‚è§ˆ

- **å¨èƒæ€»æ•°**: ${safeVar(threatAnalysis, "threat_summary.total_threats")}
- **ç‹¬ç«‹æ¥æº**: ${safeVar(threatAnalysis, "threat_summary.unique_sources")}
- **å—å½±å“ç›®æ ‡**: ${safeVar(threatAnalysis, "threat_summary.unique_targets")}

### ğŸ”´ ä¸¥é‡å¨èƒè¯¦æƒ…

${criticalThreatsText}

### ğŸŸ  é«˜å±å¨èƒè¯¦æƒ…

${highThreatsText}

### ğŸ”— æ”»å‡»é“¾åˆ†æ

${attackChainsText}

## âš¡ ä¼˜å…ˆçº§å‘Šè­¦

### ğŸ”´ P0 - ç´§æ€¥ï¼ˆç«‹å³å¤„ç†ï¼‰

${p0AlertsText}

### ğŸŸ  P1 - é«˜ä¼˜å…ˆçº§ï¼ˆ24å°æ—¶å†…ï¼‰

${p1AlertsText}

### ğŸŸ¡ P2 - ä¸­ä¼˜å…ˆçº§ï¼ˆæœ¬å‘¨å†…ï¼‰

${p2AlertsText}

## ğŸ’¡ ä¼˜åŒ–å»ºè®®

### ğŸš€ ç«‹å³æ‰§è¡Œæªæ–½

${immediateActionsText}

### ğŸ“‹ è§„åˆ™ä¼˜åŒ–å»ºè®®

${ruleOptimizationText}

### ğŸ”„ å‘Šè­¦èšåˆå»ºè®®

${alertAggregationText}

### ğŸ¤– è‡ªåŠ¨åŒ–å¤„ç†å»ºè®®

${automationText}

### ğŸ“Š ç›‘æ§æ”¹è¿›å»ºè®®

${monitoringText}

## ğŸ“ ç»“è®º

### æ•´ä½“è¯„ä¼°

${safeVar(conclusion, "overall_assessment")}

### å…³é”®è¦ç‚¹

${keyTakeawaysText}

### åç»­æ­¥éª¤

${nextStepsText}

---

## ğŸ“‹ æ€»ç»“

${summaryMessage}

---

*æŠ¥å‘Šç”Ÿæˆæ—¶é—´: ${safeVar(executiveSummary, "analysis_time")}*
*åˆ†ææ–‡ä»¶: ${safeVar(executiveSummary, "log_file")}*
`
    
    // åˆ›å»ºæŠ¥å‘Šå®ä¾‹
    reportIns = report.New()
    reportIns.From("å‘Šè­¦é™å™ª AIAgent")
    reportIns.Title("å®‰å…¨å‘Šè­¦é™å™ªåˆ†ææŠ¥å‘Š %v", time.Now().Format("2006-01-02 15:04:05"))
    reportIns.Markdown(reportTemplate)
    
    // ä¿å­˜æŠ¥å‘Š
    reportIns.Save()
    
    return result
}

