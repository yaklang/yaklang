query = cli.String("query", cli.setRequired(true), cli.setHelp("query"))
cli.check()

safeVar = (val,member) => {
    try{
        if val == nil || val == "" {
            return ""
        }
        members = str.Split(member,".")
        finallyVal = val
        for i in members{
            finallyVal = finallyVal.$i
        }
        return finallyVal
    } catch e{
        return ""
    }
}
// generateCPULoadAverageText ç”ŸæˆCPUè´Ÿè½½å¹³å‡å€¼æ–‡æœ¬
func generateCPULoadAverageText(resourceStatus) {
    loadAverage = safeVar(resourceStatus, "cpu.load_average")
	if loadAverage != "" {
        loads = []
        for _, load := range loadAverage {
            loads = append(loads, sprintf("%.2f", load))
        }
        return str.Join(loads, ", ")
    }
	return "æ— æ•°æ®"
}

// generateNetworkInterfacesText ç”Ÿæˆç½‘ç»œæ¥å£æ–‡æœ¬
func generateNetworkInterfacesText(resourceStatus)  {
    interfaces = safeVar(resourceStatus, "network.interfaces")
	if interfaces != "" {
        if len(interfaces) == 0 {
            return "æ— ç½‘ç»œæ¥å£ä¿¡æ¯"
        }

        lines = []
        for _, ifaceMap := range interfaces {
            name := safeVar(ifaceMap, "name")
            ip := safeVar(ifaceMap, "ip")
            status := safeVar(ifaceMap, "status")
            lines = append(lines, sprintf("- **%s**: %s (%s)", name, ip, status))
        }
        return str.Join(lines, "\n")
    }
	return "æ— ç½‘ç»œæ¥å£ä¿¡æ¯"
}

// generateOpenPortsTable ç”Ÿæˆå¼€æ”¾ç«¯å£è¡¨æ ¼
func generateOpenPortsTable(openPorts) {
	if len(openPorts) == 0 {
		return "âœ… æœªå‘ç°å¼€æ”¾ç«¯å£"
	}

	lines = []
	lines = append(lines, "| ç«¯å£ | åè®® | æœåŠ¡ | ç‰ˆæœ¬ | çŠ¶æ€ |")
	lines = append(lines, "|------|------|------|------|------|")

	for _, port := range openPorts {
		portNum := safeVar(port, "port")
		protocol := safeVar(port, "protocol")
		service := safeVar(port, "service")
		version := safeVar(port, "version")
		status := safeVar(port, "status")

		if version == "" {
			version = "-"
		}

		lines = append(lines, sprintf("| %v | %v | %v | %v | %v |", portNum, protocol, service, version, status))
	}

	return str.Join(lines, "\n")
}

// generateProcessesTable ç”Ÿæˆè¿›ç¨‹è¡¨æ ¼
func generateProcessesTable(processes) {
	if len(processes) == 0 {
		return "âœ… æœªå‘ç°å…³é”®è¿›ç¨‹ä¿¡æ¯"
	}

	lines = []
	lines = append(lines, "| è¿›ç¨‹å | PID | CPUä½¿ç”¨ç‡ | å†…å­˜ä½¿ç”¨ | çŠ¶æ€ |")
	lines = append(lines, "|--------|-----|-----------|----------|------|")

	for _, process := range processes {
		name := safeVar(process, "name")
		pid := safeVar(process, "pid")
		cpuPercent := safeVar(process, "cpu_percent")
		memoryUsage := safeVar(process, "memory_usage")
		status := safeVar(process, "status")

		lines = append(lines, sprintf("| %v | %v | %v%% | %v | %v |", name, pid, cpuPercent, memoryUsage, status))
	}

	return str.Join(lines, "\n")
}

// generateSecurityIssuesText ç”Ÿæˆå®‰å…¨é—®é¢˜æ–‡æœ¬
func generateSecurityIssuesText(issues, level) {
	if len(issues) == 0 {
		return sprintf("âœ… æœªå‘ç°%så®‰å…¨é—®é¢˜", level)
	}

	lines = []
	for _, issue := range issues {
		title := safeVar(issue, "title")
		description := safeVar(issue, "description")
		impact := safeVar(issue, "impact")
		recommendation := safeVar(issue, "recommendation")

		lines = append(lines, sprintf("#### %s", title))
		lines = append(lines, sprintf("- **æè¿°**: %s", description))
		lines = append(lines, sprintf("- **å½±å“**: %s", impact))
		lines = append(lines, sprintf("- **å»ºè®®**: %s", recommendation))
		lines = append(lines, "")
		lines = append(lines, "---")
		lines = append(lines, "")
	}

	return str.Join(lines, "\n")
}

// generateRecommendationsText ç”Ÿæˆä¿®å¤å»ºè®®æ–‡æœ¬
func generateRecommendationsText(recommendations, level) {
	if len(recommendations) == 0 {
		return sprintf("âœ… æš‚æ— %sä¼˜åŒ–å»ºè®®", level)
	}

	lines = []
	for _, rec := range recommendations {
		issue := safeVar(rec, "issue")
		solution := safeVar(rec, "solution")
		expectedResult := safeVar(rec, "expected_result")

		lines = append(lines, sprintf("#### %s", issue))
		lines = append(lines, sprintf("- **è§£å†³æ–¹æ¡ˆ**: %s", solution))
		lines = append(lines, sprintf("- **é¢„æœŸæ•ˆæœ**: %s", expectedResult))
		lines = append(lines, "")
		lines = append(lines, "---")
		lines = append(lines, "")
	}

	return str.Join(lines, "\n")
}

// generateSummaryMessage ç”Ÿæˆæ€»ç»“ä¿¡æ¯
func generateSummaryMessage(security_issues) {
	messages = []

	criticalCount := len(security_issues["critical"])
	highCount := len(security_issues["high"])

	if criticalCount > 0 {
		messages = append(messages, sprintf("âš ï¸ **é‡ç‚¹å…³æ³¨**: å‘ç° %d ä¸ªä¸¥é‡é—®é¢˜ï¼Œå»ºè®®ç«‹å³å¤„ç†", criticalCount))
	}

	if highCount > 0 {
		messages = append(messages, sprintf("âš ï¸ **éœ€è¦å…³æ³¨**: å‘ç° %d ä¸ªé«˜å±é—®é¢˜ï¼Œå»ºè®®å°½å¿«å¤„ç†", highCount))
	}

	if criticalCount == 0 && highCount == 0 {
		messages = append(messages, "âœ… **å®‰å…¨çŠ¶å†µè‰¯å¥½**: æœªå‘ç°ä¸¥é‡æˆ–é«˜å±å®‰å…¨é—®é¢˜")
	}

	return str.Join(messages, "\n")
}


forgeHandle = func(params,opts...) {
    result,err = __DEFAULT_FORGE_HANDLE__(params,opts...)
    if err != nil {
		return nil
	}
    scan_summary := result.Action.GetInvokeParams("scan_summary")
	system_info := result.Action.GetInvokeParams("system_info")
	resource_status := result.Action.GetInvokeParams("resource_status")
	security_issues := result.Action.GetInvokeParams("security_issues")
	recommendations := result.Action.GetInvokeParams("recommendations")
    open_ports = result.Action.GetInvokeParamsArray("open_ports")
    processes = result.Action.GetInvokeParamsArray("processes")
    safeVar = (val,member) => {
        try{
            if val == nil || val == "" {
                return ""
            }
            members = str.Split(member,".")
            finallyVal = val
            for i in members{
                finallyVal = finallyVal.$i
            }
            return finallyVal
        } catch e{
            return ""
        }
    }
    cpu_load_average_text = generateCPULoadAverageText(resource_status)
	network_interfaces_text = generateNetworkInterfacesText(resource_status)
	open_ports_table = generateOpenPortsTable(open_ports)
	processes_table = generateProcessesTable(processes)
	critical_issues_text = generateSecurityIssuesText(security_issues["critical"], "ä¸¥é‡")
	high_issues_text = generateSecurityIssuesText(security_issues["high"], "é«˜å±")
	medium_issues_text = generateSecurityIssuesText(security_issues["medium"], "ä¸­ç­‰")
	low_issues_text = generateSecurityIssuesText(security_issues["low"], "è½»å¾®")

	// ç”Ÿæˆä¿®å¤å»ºè®®æ–‡æœ¬
	immediate_recommendations_text = generateRecommendationsText(recommendations["immediate"], "ç«‹å³")
	short_term_recommendations_text = generateRecommendationsText(recommendations["short_term"], "çŸ­æœŸ")
	long_term_recommendations_text = generateRecommendationsText(recommendations["long_term"], "é•¿æœŸ")

	// ç”Ÿæˆæ€»ç»“ä¿¡æ¯
	summary_message = generateSummaryMessage(security_issues)
    reportTemplate = f`# ä¸»æœºä½“æ£€æŠ¥å‘Š

## ğŸ“Š æ‰«ææ‘˜è¦

| é¡¹ç›® | å€¼ |
|------|-----|
| **ä½“æ£€ç›®æ ‡** | ${safeVar(scan_summary,"target")} |
| **ä½“æ£€æ—¶é—´** | ${safeVar(scan_summary,"scan_time")} |
| **ä½“æ£€è€—æ—¶** | ${safeVar(scan_summary,"scan_duration")} |
| **æ•´ä½“å¥åº·åº¦** | ${safeVar(scan_summary,"overall_health")} |
| **é—®é¢˜æ€»æ•°** | ${safeVar(scan_summary,"total_issues")} |

## ğŸ’» ç³»ç»Ÿä¿¡æ¯

| é¡¹ç›® | å€¼ |
|------|-----|
| **æ“ä½œç³»ç»Ÿ** | ${safeVar(system_info,"os")} |
| **ç³»ç»Ÿç‰ˆæœ¬** | ${safeVar(system_info,"version")} |
| **ç³»ç»Ÿæ¶æ„** | ${safeVar(system_info,"architecture")} |
| **ä¸»æœºå** | ${safeVar(system_info,"hostname")} |
| **è¿è¡Œæ—¶é—´** | ${safeVar(system_info,"uptime")} |

## ğŸ“ˆ èµ„æºçŠ¶æ€

### CPUä½¿ç”¨æƒ…å†µ
- **ä½¿ç”¨ç‡**: ${safeVar(resource_status,"cpu.usage_percent")}%
- **æ ¸å¿ƒæ•°**: ${safeVar(resource_status,"cpu.cores")}
- **è´Ÿè½½å¹³å‡å€¼**: ${cpu_load_average_text}

### å†…å­˜ä½¿ç”¨æƒ…å†µ
- **æ€»å†…å­˜**: ${safeVar(resource_status,"memory.total")}
- **å·²ç”¨å†…å­˜**: ${safeVar(resource_status,"memory.used")}
- **å¯ç”¨å†…å­˜**: ${safeVar(resource_status,"memory.available")}
- **ä½¿ç”¨ç‡**: ${safeVar(resource_status,"memory.usage_percent")}%

### ç£ç›˜ä½¿ç”¨æƒ…å†µ
- **æ€»ç©ºé—´**: ${safeVar(resource_status,"disk.total")}
- **å·²ç”¨ç©ºé—´**: ${safeVar(resource_status,"disk.used")}
- **å¯ç”¨ç©ºé—´**: ${safeVar(resource_status,"disk.available")}
- **ä½¿ç”¨ç‡**: ${safeVar(resource_status,"disk.usage_percent")}%

### ç½‘ç»œçŠ¶æ€
- **æ´»è·ƒè¿æ¥æ•°**: ${safeVar(resource_status,"network.active_connections")}

#### ç½‘ç»œæ¥å£
${network_interfaces_text}

## ğŸ”Œ å¼€æ”¾ç«¯å£

${open_ports_table}

## ğŸ”„ å…³é”®è¿›ç¨‹

${processes_table}

## ğŸš¨ å®‰å…¨é—®é¢˜

### ğŸ”´ ä¸¥é‡é—®é¢˜
${critical_issues_text}

### ğŸŸ  é«˜å±é—®é¢˜
${high_issues_text}

### ğŸŸ¡ ä¸­ç­‰é—®é¢˜
${medium_issues_text}

### ğŸŸ¢ è½»å¾®é—®é¢˜
${low_issues_text}

## ğŸ’¡ ä¿®å¤å»ºè®®

### ğŸ”´ éœ€è¦ç«‹å³æ‰§è¡Œçš„ä¿®å¤æªæ–½
${immediate_recommendations_text}

### ğŸŸ  çŸ­æœŸä¼˜åŒ–å»ºè®®
${short_term_recommendations_text}

### ğŸ”µ é•¿æœŸæ”¹è¿›å»ºè®®
${long_term_recommendations_text}

## ğŸ“‹ æ€»ç»“

æœ¬æ¬¡ä½“æ£€å…±å‘ç° **${safeVar(scan_summary,"total_issues")}** ä¸ªé—®é¢˜ï¼Œç³»ç»Ÿæ•´ä½“å¥åº·åº¦ä¸º **${safeVar(scan_summary,"overall_health")}**ã€‚

${summary_message}

---
*æŠ¥å‘Šç”Ÿæˆæ—¶é—´: ${safeVar(scan_summary,"scan_time")}* `
    reportIns = report.New()
    reportIns.From("ä¸»æœºä½“æ£€ AIAgent")
    reportIns.Title("ä¸»æœºä½“æ£€æŠ¥å‘Š %v",time.Now().Format("2006-01-02 15:04:05"))
    reportIns.Markdown(reportTemplate)

    reportIns.Save()

    return result
}