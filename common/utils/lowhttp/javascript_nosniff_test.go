package lowhttp

import (
	"fmt"
	"github.com/saintfish/chardet"
	"github.com/stretchr/testify/assert"
	"github.com/yaklang/yaklang/common/yak/yaklib/codec"
	"testing"
)

func TestResponseJavaScriptNoSniff(t *testing.T) {
	rsp, body, err := FixHTTPResponse([]byte("HTTP/1.1 200 OK\r\n" +
		"Content-Type: application/javascript\r\n" +
		"X-Content-Type-Options: nosniff\r\n" +
		"\r\n" +
		"// 你好我是 JS"))
	if err != nil {
		t.Fatal(err)
	}

	test := assert.New(t)
	fmt.Println(string(body))
	test.Contains(string(body), "你好我是 JS")
	fmt.Println("-------------------------------------")
	fmt.Println(string(rsp))
	test.Contains(string(rsp), "你好我是 JS")

	rspBase64 := `SFRUUC8xLjEgMjAwIE9LDQpTZXJ2ZXI6IG5naW54LzEuMjEuNCAoVWJ1bnR1KQ0KRGF0ZTogU2F0LCAwMSBKdW4gMjAyNCAwMzoyNzowOCBHTVQNCkNvbnRlbnQtVHlwZTogYXBwbGljYXRpb24vamF2YXNjcmlwdA0KQ29udGVudC1MZW5ndGg6IDg0NTANCkNvbm5lY3Rpb246IGtlZXAtYWxpdmUNCkxhc3QtTW9kaWZpZWQ6IEZyaSwgMTcgTm92IDIwMjMgMTA6MDQ6NDYgR01UDQpFVGFnOiAiNjU1NzNhYmUtMjEwMiINClgtQ29udGVudC1UeXBlLU9wdGlvbnM6IG5vc25pZmYNClgtWFNTLVByb3RlY3Rpb246IDE7IG1vZGU9YmxvY2sNCkFjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbjogKg0KQWNjZXB0LVJhbmdlczogYnl0ZXMNCg0KLyoqCiAqIGF4aW9zwLm92Mb3CiAqIEBzZWUg0sDAtWF4aW9zLmpzCiAqIEBzZWUgx+vH88C5vdg6uPm+3UpBVkG78k5FVNfUtq/J6NbDt/u6z7f+zvHG97nm1PK1xLLOyv0KICogQGF1dGhvciDVxcC6t8kKICogQGRhdGUgMjAyMS0wMy0xMQogKi8KKGZ1bmN0aW9uICgpIHsKICAvLyAvLyBheGlvc9L9yOsKICAvLyBpbXBvcnRKcygiL2pzL2F4aW9zL2F4aW9zLmpzIik7CiAgLy8gLy8gamF2YVVybNL9yOsKICAvLyBpbXBvcnRKcygiL2pzL2phdmFVcmwuanMiKTsKCiAgY29uc3QgTU9ERSA9IHdpbmRvdy5NT0RFIHx8ICJqYXZhIjsKICBjb25zdCBERUJVRyA9IHdpbmRvdy5ERUJVRzsKCiAgLy8gx+vH88C5vdjG9wogIGF4aW9zLmludGVyY2VwdG9ycy5yZXF1ZXN0LnVzZSgKICAgIChjb25maWcpID0+IHsKICAgICAgY29uc3QgbmFtZSA9IGNvbmZpZy5uYW1lOwogICAgICAvLyC198rUCiAgICAgIERFQlVHICYmIGRlYnVnKHsgY29uZmlnLCBpc1JlcXVlc3Q6IHRydWUsIG5hbWUgfSk7CiAgICAgIC8vILLOyv3XqruvCiAgICAgIHBhcmFtc0NvbnZlcnNpb24oY29uZmlnKTsKICAgICAgcmV0dXJuIGNvbmZpZzsKICAgIH0sCiAgICAoZXJyKSA9PiB7CiAgICAgIHRocm93IGVycjsKICAgIH0KICApOwoKICAvLyDP7NOmwLm92Mb3CiAgYXhpb3MuaW50ZXJjZXB0b3JzLnJlc3BvbnNlLnVzZSgKICAgIChyZXNwb25zZSkgPT4gewogICAgICBpZiAocmVzcG9uc2Uuc3RhdHVzID09ICIyMDAiKSB7CiAgICAgICAgY29uc3QgY29udGVudFR5cGUgPSByZXNwb25zZS5oZWFkZXJzWyJjb250ZW50LXR5cGUiXTsKICAgICAgICBjb25zdCBuYW1lID0gcmVzcG9uc2UuY29uZmlnLm5hbWU7CiAgICAgICAgLy8geG1syv2+3dequ7sKICAgICAgICBpZiAoaXNYbWwocmVzcG9uc2UpKSB7CiAgICAgICAgICBsZXQgeG1sID0gc3RyaW5nVG9YbWwocmVzcG9uc2UuZGF0YSk7CiAgICAgICAgICAvLyDH68fztObU2sSjsOXQxc+itKvI6zogvfjQ0Mr9vt3Xqru7CiAgICAgICAgICBjb25zdCB7IHRhZywgdmFsdWUsIHRlbXBsYXRlcywgaXNGb3JtYXQsIG5hbWUgfSA9IHJlc3BvbnNlLmNvbmZpZzsKICAgICAgICAgIGlmIChpc0Zvcm1hdCAhPT0gZmFsc2UpIHsKICAgICAgICAgICAgY29uc3QgZXJyID0gcmVzcG9uc2VFcnJvckhhbmQoJCh4bWwpLCByZXNwb25zZSk7CiAgICAgICAgICAgIGlmICghZXJyIHx8IGVyci5pc0VtcHR5KSB7CiAgICAgICAgICAgICAgY29uc3QgbGlzdCA9IHJlc3BvbnNlRm9ybWF0KHsgZGF0YTogeG1sLCB0YWcsIHZhbHVlLCB0ZW1wbGF0ZXMgfSk7CiAgICAgICAgICAgICAgaWYgKGxpc3QpIHsKICAgICAgICAgICAgICAgIHJlc3VsdCA9IGxpc3Q7CiAgICAgICAgICAgICAgICBERUJVRyAmJiBkZWJ1Zyh7IGRhdGE6IHJlc3VsdCwgbmFtZSB9KTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgREVCVUcgJiYgZGVidWcoeyB4bWwsIG5hbWUgfSk7CiAgICAgICAgICAgICAgICBjb25zdCBlcnIgPSByZXNwb25zZUVycm9ySGFuZCgkKHhtbCksIHJlc3BvbnNlKTsKICAgICAgICAgICAgICAgIGlmIChlcnIpIHsKICAgICAgICAgICAgICAgICAgaWYgKGVyci5pc0VtcHR5KSB7CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0geyBkYXRhTGlzdDogW10sIHBhZ2U6IHsgY3VycmVudDogMSwgdG90YWw6IDEgfSB9OwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRocm93IGVycjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0aHJvdyBlcnI7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIC8vILK70OjSqrjxyr27rwogICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIHJlc3VsdCA9ICQoeG1sKTsKICAgICAgICAgICAgREVCVUcgJiYgZGVidWcoeyBkYXRhOiByZXN1bHQsIHhtbCwgbmFtZSB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgLy8ganNvbsr9vt3Xqru7CiAgICAgICAgZWxzZSBpZiAoY29udGVudFR5cGUuaW5jbHVkZXMoImpzb24iKSkgewogICAgICAgICAgREVCVUcgJiYgZGVidWcoeyBkYXRhOiByZXN1bHQsIG5hbWUgfSk7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICByZXN1bHQgPSBKU09OLnBhcnNlKHJlc3BvbnNlLmRhdGEpOwogICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICAgICAgY29uc29sZS53YXJuKCK3tbvYyv2+3Wpzb27Xqru7tO3O8yEiLCBlcnJvcik7CiAgICAgICAgICAgIHJlc3VsdCA9IHJlc3BvbnNlLmRhdGE7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIC8vIMbky/vK/b7dt7W72NSt1rUKICAgICAgICBlbHNlIHsKICAgICAgICAgIERFQlVHICYmIGNvbnNvbGUubG9nKCK3tbvYwcvG5Mv7zsS8/sDg0M0iKTsKICAgICAgICAgIHJlc3VsdCA9IHJlc3BvbnNlLmRhdGE7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH0KICAgIH0sCiAgICAoZXJyKSA9PiB7CiAgICAgIHJldHVybiBlcnJIYW5kKGVycik7CiAgICB9CiAgKTsKCiAgLyoqCiAgICogtffK1Mrks/YKICAgKiBAcGFyYW0ge29iamVjdH0gY29uZmlnIHJlcXVlc3TF5NbDCiAgICogQHBhcmFtIHtib29sZWFufSBpc1JlcXVlc3Qgyse38crHx+vH87X3ytQKICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YSBqc29uyv2+3bbUz/MKICAgKiBAcGFyYW0ge3htbH0geG1sIHhtbLbUz/MKICAgKi8KICBmdW5jdGlvbiBkZWJ1Zyh7IGNvbmZpZywgaXNSZXF1ZXN0LCBkYXRhLCB4bWwsIG5hbWUgfSkgewogICAgbmFtZSA9IG5hbWUgPyBgWyR7bmFtZX1dYCA6ICIiOwogICAgaWYgKGlzUmVxdWVzdCkgewogICAgICBjb25zb2xlLmxvZygKICAgICAgICBgofyh/KH8ofyh/KH8ofyh/MnP0NAke25hbWV9ofyh/KH8ofyh/KH8ofyh/FxuYCwKICAgICAgICB3aW5kb3cubG9jYXRpb24ub3JpZ2luICsgdXJsTWVyZ2UoY29uZmlnLCB0cnVlKQogICAgICApOwogICAgfSBlbHNlIHsKICAgICAgY29uc29sZS5sb2coYKH9of2h/aH9of2h/aH9of3PwtDQJHtuYW1lfaH9of2h/aH9of2h/aH9of1cbmApOwogICAgICB4bWwgJiYgY29uc29sZS5kaXJ4bWwoeG1sKTsKICAgICAgZGF0YSAmJiBjb25zb2xlLmxvZyhkYXRhKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGVyckhhbmQoZXJyKSB7CiAgICBpZiAoYXhpb3MuaXNDYW5jZWwoZXJyKSkgewogICAgICAvLyDFxbP9yKHP+8frx/OxqLTtCiAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICAgICAgcmVqZWN0KHsgaXNDYW5jZWw6IHRydWUsIG1lc3NhZ2U6ICLH68fzyKHP+yIgfSk7CiAgICAgIH0pOwogICAgfQogICAgaWYgKGVyciAmJiBlcnIucmVzcG9uc2UpIHsKICAgICAgc3dpdGNoIChlcnIucmVzcG9uc2Uuc3RhdHVzKSB7CiAgICAgICAgY2FzZSA0MDA6CiAgICAgICAgICBlcnIubWVzc2FnZSA9ICLH68fztO3O8yI7CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlIDQwMToKICAgICAgICAgIGVyci5tZXNzYWdlID0gIs60ytrIqKOsx+u1x8K8IjsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgNDEzOgogICAgICAgICAgZXJyLm1lc3NhZ2UgPSAiyc+0q87EvP6zrLP21+6088/e1sYiOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSA0MDM6CiAgICAgICAgICBlcnIubWVzc2FnZSA9ICK+3L74t8POyiI7CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlIDQwNDoKICAgICAgICAgIGVyci5tZXNzYWdlID0gYMfrx/O12Na3s/a07Sg0MDQpOiAke2Vyci5yZXNwb25zZS5jb25maWcudXJsfWA7CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlIDQwODoKICAgICAgICAgIGVyci5tZXNzYWdlID0gIsfrx/OzrMqxIjsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgNTAwOgogICAgICAgICAgZXJyLm1lc3NhZ2UgPSAit/7O8cb3xNqyv7TtzvMiOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSA1MDE6CiAgICAgICAgICBlcnIubWVzc2FnZSA9ICK3/s7xzrTKtc/WIjsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgNTAyOgogICAgICAgICAgZXJyLm1lc3NhZ2UgPSAizfi52LTtzvMiOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSA1MDM6CiAgICAgICAgICBlcnIubWVzc2FnZSA9ICK3/s7xsru/ydPDIjsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgNTA0OgogICAgICAgICAgZXJyLm1lc3NhZ2UgPSAizfi52LOsyrEiOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSA1MDU6CiAgICAgICAgICBlcnIubWVzc2FnZSA9ICJIVFRQsOaxvrK7ytzWp7PWIjsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICBicmVhazsKICAgICAgfQogICAgfQogICAgYnVnRXJyb3IoZXJyKTsKICAgIGlmIChlcnIubWVzc2FnZS5pbmNsdWRlcygidGltZW91dCBvZiIpKSB7CiAgICAgIGVyci5tZXNzYWdlID0gIsfrx/OzrMqxLLzssunN+MLnuvPJ1Lrz1tjK1LDJfiI7CiAgICB9CiAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZXJyKTsKICB9CgogIC8qKgogICAqILSmwO1idWe07c7zCiAgICogQHBhcmFtIHtvYmplY3R9IGVyciC07c7zttTP8wogICAqLwogIGZ1bmN0aW9uIGJ1Z0Vycm9yKGVycikgewogICAgbGV0IGVyclR5cGUgPSBbCiAgICAgIHsgdHlwZTogIlR5cGVFcnJvciIsIGNvZGU6IC0xMDEsIG1lc3NhZ2U6ICLA4NDNtO3O8yIgfSwgLy8gwODQzbTtzvMKICAgICAgeyB0eXBlOiAiU3ludGF4RXJyb3IiLCBjb2RlOiAtMTAyLCBtZXNzYWdlOiAi0++3qLTtzvMiIH0sIC8vINPvt6i07c7zCiAgICAgIHsgdHlwZTogIlJhbmdlRXJyb3IiLCBjb2RlOiAtMTAzLCBtZXNzYWdlOiAi1L295yIgfSwgLy8g1L295wogICAgICB7IHR5cGU6ICJSZWZlcmVuY2VFcnJvciIsIGNvZGU6IC0xMDQsIG1lc3NhZ2U6ICLS/dPDtO3O8yIgfSwgLy8g0v3Tw7TtzvMKICAgIF07CiAgICBlcnJUeXBlLmZvckVhY2goKGUpID0+IHsKICAgICAgaWYgKGVyci5zdGFjay5pbmNsdWRlcyhlLnR5cGUpKSB7CiAgICAgICAgZXJyLm1lc3NhZ2UgPSBgx+vBqs+1udzA7dSxLi4utO3O88LrOiR7ZS5jb2RlfSgke2UubWVzc2FnZX0pYDsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH0pOwogIH0KCiAgLyoqCiAgICogdXJsss7K/brPsqIoss7K/cirsr+3xdTacGF0aNbQzai5/SbBtL3TKQogICAqIEBwYXJhbSB7b2JqZWN0fSBjb25maWcgxeTWw7bUz/MKICAgKiBAcGFyYW0ge2Jvb2xlYW59IGlzTmVlZEhvc3Qgyse38dDo0qq808jraG9zdAogICAqIEByZXR1cm5zIHtzdHJpbmd9IHVybLrPsqIKICAgKi8KICBmdW5jdGlvbiB1cmxNZXJnZShjb25maWcsIGlzTmVlZEhvc3QpIHsKICAgIGNvbnN0IHsgdXJsLCBtZXRob2QsIGRhdGEsIHBhcmFtcyB9ID0gY29uZmlnOwogICAgbGV0IHN1ZmZpeCA9IG1ldGhvZC50b0xvd2VyQ2FzZSgpID09ICJnZXQiID8gcGFyYW1zIDogZGF0YTsKICAgIC8vIMXQts91cmzW0MrHt/G6rNPQss7K/QogICAgbGV0IHN0YXJ0UGFyYW0gPSB1cmwuc3BsaXQoIj8iKTsKICAgIGNvbnN0IGhvc3QgPSBzdGFydFBhcmFtWzBdOwogICAgaWYgKHN0YXJ0UGFyYW0ubGVuZ3RoID4gMSkgewogICAgICBzdGFydFBhcmFtID0gc3RhcnRQYXJhbVsxXS5zcGxpdCgiJiIpOwogICAgfSBlbHNlIHsKICAgICAgc3RhcnRQYXJhbSA9IFtdOwogICAgfQogICAgY29uc3QgbGlzdCA9IHN0YXJ0UGFyYW07CiAgICBpZiAoc3VmZml4KSB7CiAgICAgIC8vILj5vt2yzsr9ttTP87340NDX6brPCiAgICAgIG9iamVjdEVhY2goc3VmZml4LCAodmFsdWUsIGtleSkgPT4gewogICAgICAgIGlmICh2YWx1ZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICBsaXN0LnB1c2goYCR7a2V5fT0ke3ZhbHVlfWApOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgICBzdWZmaXggPSBsaXN0LmpvaW4oIiYiKTsKICAgIGlmIChpc05lZWRIb3N0KSB7CiAgICAgIHJldHVybiBgJHtob3N0fT8ke3N1ZmZpeH1gOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHN1ZmZpeDsKICAgIH0KICB9CgogIC8qKgogICAqIMfrx/Oyzsr916q7rwogICAqIEBzZWUguPm+3WphdmF8bmV0vfjQ0LK7zay1xLLOyv3XqruvCiAgICogQHBhcmFtIHtvYmplY3R9IGNvbmZpZyDH68fzss7K/QogICAqLwogIGZ1bmN0aW9uIHBhcmFtc0NvbnZlcnNpb24oY29uZmlnKSB7CiAgICBjb25zdCB7IHVybCwgbWV0aG9kIH0gPSBjb25maWc7CiAgICBpZiAoTU9ERSA9PSAiamF2YSIpIHsKICAgICAgLy8gxdC2zzrUrcn6bmV0vdO/2gogICAgICBpZiAoCiAgICAgICAgWyIvd3giLCAiL0xvZ2luVmVydGlmeSIsICIveG1sU2VydmljZSIsICIvWG1sU2VydmljZSJdLnNvbWUoKHN0cikgPT4KICAgICAgICAgIHVybC5pbmNsdWRlcyhzdHIpCiAgICAgICAgKQogICAgICApIHsKICAgICAgICAvLyBHRVQKICAgICAgICBpZiAobWV0aG9kLnRvTG93ZXJDYXNlKCkgPT0gImdldCIpIHsKICAgICAgICAgIGlmICh1cmwuaW5jbHVkZXMoIi93eC9zc3BfaGRjXyIpKSB7CiAgICAgICAgICAgIGNvbmZpZy51cmwgPSB1cmwKICAgICAgICAgICAgICAucmVwbGFjZSgiL3d4L3NzcF9oZGNfIiwgIi9qc29uL3NzcF9oZGNfIikKICAgICAgICAgICAgICAucmVwbGFjZSgiLmFzcHgiLCAiIik7CiAgICAgICAgICAgIGNvbmZpZy51cmwgPSBqYXZhVXJsX25ldygKICAgICAgICAgICAgICBjb25maWcudXJsLnNwbGl0KCI/IilbMF0sCiAgICAgICAgICAgICAgdXJsTWVyZ2UoY29uZmlnKQogICAgICAgICAgICApOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY29uZmlnLnVybCA9IGphdmFVcmwodXJsTWVyZ2UoY29uZmlnLCB0cnVlKSk7CiAgICAgICAgICB9CiAgICAgICAgICBjb25maWcucGFyYW1zID0ge307CiAgICAgICAgfQogICAgICAgIC8vIFBPU1QKICAgICAgICBlbHNlIHsKICAgICAgICAgIGNvbmZpZy5oZWFkZXJzID0gewogICAgICAgICAgICAiQ29udGVudC1UeXBlIjogImFwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCIsCiAgICAgICAgICB9OwogICAgICAgICAgbGV0IHVybDIsIGNtZDsKICAgICAgICAgIGlmICh1cmwuaW5jbHVkZXMoIi93eC9zc3BfaGRjXyIpKSB7CiAgICAgICAgICAgIHVybDIgPSB1cmwKICAgICAgICAgICAgICAucmVwbGFjZSgiL3d4L3NzcF9oZGNfIiwgIi9qc29uL3NzcF9oZGNfIikKICAgICAgICAgICAgICAucmVwbGFjZSgiLmFzcHgiLCAiIik7CiAgICAgICAgICB9IGVsc2UgaWYgKHVybC5pbmNsdWRlcygiL3d4IikpIHsKICAgICAgICAgICAgY29uc3QgdGVtcCA9IGphdmFVcmwoY29uZmlnLnVybCk7CiAgICAgICAgICAgIHVybDIgPSB0ZW1wLnNwbGl0KCI/IilbMF07CiAgICAgICAgICAgIGNtZCA9IHRlbXAubWF0Y2goL2NtZCUyNTNEKFxkKykvKVsxXTsKICAgICAgICAgICAgY29uZmlnLmRhdGEuY21kID0gY21kOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdXJsMiA9IHVybDsKICAgICAgICAgIH0KICAgICAgICAgIGNvbmZpZy51cmwgPSB1cmwyOwogICAgICAgICAgY29uZmlnLmRhdGEgPSBqYXZhVXJsX2VzY2FwZUJvZHkodXJsTWVyZ2UoY29uZmlnKSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIC8vIMXQts9qYXZhzajTw73Tv9oKICAgICAgZWxzZSB7CiAgICAgICAgLy8gR0VUCiAgICAgICAgaWYgKG1ldGhvZC50b0xvd2VyQ2FzZSgpID09ICJnZXQiKSB7CiAgICAgICAgICBjb25maWcudXJsID0gamF2YVVybF9uZXcodXJsLnNwbGl0KCI/IilbMF0sIHVybE1lcmdlKGNvbmZpZykpOwogICAgICAgICAgY29uZmlnLnBhcmFtcyA9IHt9OwogICAgICAgIH0KICAgICAgICAvLyBQT1NUCiAgICAgICAgZWxzZSB7CiAgICAgICAgICBjb25maWcuaGVhZGVycyA9IHsKICAgICAgICAgICAgIkNvbnRlbnQtVHlwZSI6ICJhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQiLAogICAgICAgICAgfTsKICAgICAgICAgIGNvbmZpZy5kYXRhID0gamF2YVVybF9lc2NhcGVCb2R5KHVybE1lcmdlKGNvbmZpZykpOwogICAgICAgIH0KICAgICAgfQogICAgICBERUJVRyAmJgogICAgICAgIGNvbnNvbGUubG9nKCJqYXZh16q7u7rzdXJsOiIsIHdpbmRvdy5sb2NhdGlvbi5vcmlnaW4gKyBjb25maWcudXJsKTsKICAgIH0KICAgIC8vIG5ldLbLCiAgICBlbHNlIHsKICAgICAgaWYgKG1ldGhvZC50b0xvd2VyQ2FzZSgpID09ICJnZXQiKSB7CiAgICAgICAgaWYgKHVybC5pbmNsdWRlcygiL2pzb24vc3NwX2hkY18iKSkgewogICAgICAgICAgY29uZmlnLnVybCA9IHVybC5yZXBsYWNlKCIvanNvbi9zc3BfaGRjXyIsICIvd3gvc3NwX2hkY18iKTsKICAgICAgICB9CiAgICAgICAgY29uZmlnLnVybCA9IHVybE1lcmdlKGNvbmZpZywgdHJ1ZSk7CiAgICAgICAgY29uZmlnLnBhcmFtcyA9IHt9OwogICAgICB9CiAgICB9CiAgfQp9KSgpOwo=`
	rsp, _ = codec.DecodeBase64(rspBase64)
	det := chardet.NewTextDetector()
	result, err := det.DetectBest(rsp)
	if err != nil {
		t.Fatal(err)
	}
	test.Equal(result.Charset, "GB-18030")

	rsp, _, _ = FixHTTPResponse(rsp)
	fmt.Println(string(rsp))
}
