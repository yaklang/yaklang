package java

import (
	"strings"
	"testing"

	"github.com/stretchr/testify/require"

	"github.com/yaklang/yaklang/common/yak/ssaapi"
	"github.com/yaklang/yaklang/common/yak/ssaapi/test/ssatest"
)

func Test_Command_Injection(t *testing.T) {
	code := `
	package org.example;

public class Main {
    public static void main(String[] args) {
        String ip = request.getParameter("ip");
        if(null==ip){
            //handle error
        }
        Boolean ret = Pattern.matches("((?:(?:25[0-5]|2[0-4]\\d|[01]?\\d?\\d)\\.){3}(?:25[0-5]|2[0-4]\\d|[01]?\\d?\\d))", ip);
        if(!ret){
            //handle error
        }
        String[] cmd = new String[]{"ping", "-c", "2", ip};
        Runtime rt = Runtime.getRuntime();
        Process proc = rt.exec(cmd);
    }
}`

	t.Run("forward code analysis", func(t *testing.T) {
		ssatest.Check(t, code,
			ssatest.CheckBottomUserCall_Contain("request.getParameter", []string{"rt.exec"}),
			ssaapi.WithLanguage(ssaapi.JAVA))
	})

	t.Run("reverse code analysis", func(t *testing.T) {
		prog, err := ssaapi.Parse(code, ssaapi.WithLanguage("java"))
		if err != nil {
			t.Fatal("prog parse error", err)
		}
		runtime := prog.Ref("Runtime").Ref("getRuntime")[0].GetCalledBy()
		exec := runtime.Ref("exec")[0]
		args := exec.GetCalledBy()[0].GetCallArgs()
		args.GetTopDefs().ShowWithSource()
		count := strings.Count(args.GetTopDefs().StringEx(0), "Undefined-request.getParameter(valid)")
		require.Equal(t, 1, count)
	})

}

func Test_Command_Injection_With_WhiteList(t *testing.T) {
	code := `
	package org.example;

public class Main {
   public static void main(String[] args) {
			   String dir=request.getParameter("dir");
		if(dir.length < 1 ){
			dir = "tmp";
		}else {
			dir = "tmp" + dir;
		}
		Runtime runtime=Runtime.getRuntime();
		Process process=runtime.exec(dir);
		int result=process.waitFor();

   }
}`
	t.Run("forward code analysis", func(t *testing.T) {
		ssatest.Check(t, code,
			ssatest.CheckBottomUserCall_Contain("request.getParameter", []string{"runtime.exec"}),
			ssaapi.WithLanguage(ssaapi.JAVA))
	})

	t.Run("reverse code analysis", func(t *testing.T) {
		ssatest.CheckSyntaxFlow(t, code,
			`Runtime.getRuntime().exec() #-> * as $target`,
			map[string][]string{
				"target": {
					`Undefined-Runtime`,
					`Undefined-Runtime.getRuntime(valid)`,
					`Undefined-runtime.exec(valid)`,
					`"tmp"`,
					`"tmp"`,
					`Undefined-request`,
					`Undefined-request.getParameter(valid)`,
					`lt(Undefined-dir.length(valid), 1)`,
					`1`,
					`Undefined-dir.length(valid)`,
					`"dir"`,
				},
			},
			ssaapi.WithLanguage(ssaapi.JAVA))
	})
}

func Test_SQL_Injection_Statement(t *testing.T) {
	code := `
package org.example;
public class Main {
    public static void main(String[] args) {
        String userName = request.getParameter("name");
        if(null==userName){
            //handle error
        }
        Connection conn = DriverManager.getConnection("jdbc:mysql://localhost:3306/yak", "yak111", "yak222");;
        String query = "SELECT * FROM Users where user="+userName;
        Statement statement=conn.Statement(query);
        statement.execute();
    }
}`
	t.Run("forward code analysis", func(t *testing.T) {
		ssatest.Check(t, code,
			ssatest.CheckBottomUserCall_Contain("request.getParameter", []string{"conn.Statement"}),
			ssaapi.WithLanguage(ssaapi.JAVA),
		)
	})

	t.Run("reverse code analysis", func(t *testing.T) {
		ssatest.CheckSyntaxFlow(t, code,
			`DriverManager.getConnection().Statement() #-> * as $target`,
			map[string][]string{
				"target": {
					`Undefined-DriverManager`,
					`Undefined-DriverManager.getConnection(valid)`,
					`"jdbc:mysql://localhost:3306/yak"`,
					`"yak111"`,
					`"yak222"`,
					`Undefined-conn.Statement(valid)`,
					`"SELECT * FROM Users where user="`,
					`Undefined-request`,
					`Undefined-request.getParameter(valid)`,
					`"name"`,
				},
			},
			ssaapi.WithLanguage(ssaapi.JAVA))
	})

}

func Test_Code_Injection(t *testing.T) {
	code := `
package org.example;
class Main{
 public static void main(String[] args) {
    Object obj = null;
    try {
        String className = request.getParameter("className");
        if(null==className){
            //handle error
        }
        if (whiteList.containsKey(className)) {                 //白名单
            obj = whiteList.get(className).newInstance();
        }
    } catch (InstantiationException e) {
        //do something
    }
    return obj;
}
	

}`
	t.Run("forward code analysis", func(t *testing.T) {
		ssatest.Check(t, code,
			ssatest.CheckBottomUserCall_Contain("request.getParameter", []string{"whiteList.get"}),
			ssaapi.WithLanguage(ssaapi.JAVA))
	})

	t.Run("reverse code analysis", func(t *testing.T) {
		ssatest.CheckSyntaxFlow(t, code,
			`whiteList.get(* #->  as $target)`,
			map[string][]string{
				"target": {
					`"className"`,
					"Undefined-request",
					"Undefined-request.getParameter(valid)",
				},
			}, ssaapi.WithLanguage(ssaapi.JAVA),
		)
	})
}
