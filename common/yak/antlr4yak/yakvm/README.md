# Yak Virtual Machine

## 字节码定义：Opcode Definition

| 助记符(Opcode Verbose) | Unary            | Op1     | Op2 | 补充描述                                                        |
|:--------|------------------|---------|------|-------------------------------------------------------------|
| type-cast | -                | -       | - | 类型转换：从栈中取出两个值，第一个值为类型，第二个值为具体需要转换的值，进行类型转换，并把结果推入栈中         |
| bang | -        | -       | - | 单目运算符：`!`，从栈中取出一个值，进行计算，把结果再推入栈                             |
| neg | -                | -       | - | 单目运算符：`-`，从栈中取出一个值，进行计算，把结果再推入栈                             |
| plus | -                | -       | - | 单目运算符：`+`，从栈中取出一个值，进行计算，把结果再推入栈                             |
| chan-recv | -                | -       | - | 单目运算符：`<-`，从栈中取出一个 channel，读取 channel 的结果，把结果再推入栈           |
| self-add-one | -                | -       | - | 自增赋值：栈中取出一个值，进行自增，把结果压栈                                     |
| self-minus-one | -                | -       | - | 自增赋值：栈中取出一个值，进行自减，把结果压栈                                     |
| shl | -                | -       | - | 双目位运算符：`<<`，从栈中取出两个值，进行计算，把结果再压入栈                           |
| shr | -                | -       | - | 双目位运算符：`>>`，从栈中取出两个值，进行计算，把结果再压入栈                           |
| and | -                | -       | - | 双目位运算符：`&`，从栈中取出两个值，进行计算，把结果再压入栈                            |
| and-not | -                | -       | - | 双目位运算符：`&^`，从栈中取出两个值，进行计算，把结果再压入栈                           |
| or | -                | -       | - | 双目位运算符：<code>&#124;</code>，从栈中取出两个值，进行计算，把结果再压入栈            |
| xor | -                | -       | - | 双目位运算符：`^`，从栈中取出两个值，进行计算，把结果再压入栈                            |
| add | -                | -       | - | 双目运算符：`+`，从栈中取出两个值，进行相加，把结果再压入栈                             |
| sub | -                | -       | - | 双目运算符：`-`，从栈中取出两个值，进行相减，把结果再压入栈                             |
| mul | -                | -       | - | 双目运算符：`*`，从栈中取出两个值，进行计算（乘），把结果再压入栈                          |
| div | -                | -       | - | 双目运算符：`/`，从栈中取出两个值，进行计算（除），把结果再压入栈                          |
| mod | -                | -       | - | 双目运算符：`%`，从栈中取出两个值，进行计算（取模），把结果再压入栈                         |
| gt | -                | -       | - | 双目逻辑运算符：`>`，从栈中取出两个值，进行计算（大于），把结果再压入栈                       |
| lt | -                | -       | - | 双目逻辑运算符：`<`，从栈中取出两个值，进行计算（大于），把结果再压入栈                       |
| gt-eq | -                | -       | - | 双目逻辑运算符：`>=`，从栈中取出两个值，进行计算（大于等于），把结果再压入栈                    |
| lt-eq | -                | -       | - | 双目逻辑运算符：`<=`，从栈中取出两个值，进行计算（小于等于），把结果再压入栈                    |
| eq | -                | -       | - | 双目逻辑运算符：`==`，从栈中取出两个值，进行计算（是否相等），把结果再压入栈                    |
| neq | -                | -       | - | 双目逻辑运算符：`!=`，从栈中取出两个值，进行计算（是否不等），把结果再压入栈                    |
| self-plus-eq | -                | -       | - | 赋值运算符：`+=`，从栈中取出两个值，进行计算（相加），把结果赋值到第一位值中（左）                 |
| self-minus-eq | -                | -       | - | 赋值运算符：`-=`，从栈中取出两个值，进行计算（相减），把结果赋值到第一位值中（左）                 |
| self-mul-eq | -                | -       | - | 赋值运算符：`*=`，从栈中取出两个值，进行计算（乘），把结果赋值到第一位值中（左）                  |
| self-div-eq | -                | -       | - | 赋值运算符：`/=`，从栈中取出两个值，进行计算（除），把结果赋值到第一位值中（左）                  |
| self-mod-eq | -                | -       | - | 赋值运算符：`%=`，从栈中取出两个值，进行计算（模），把结果赋值到第一位值中（左）                  |
| self-and-eq | -                | -       | - | 赋值运算符：`&=`，从栈中取出两个值，进行计算（位与），把结果赋值到第一位值中（左）                 |
| self-or-eq | -                | -       | - | 赋值运算符：<code>&#124;=</code>，从栈中取出两个值，进行计算（位或），把结果赋值到第一位值中（左） |
| self-xor-eq | -                | -       | - | 赋值运算符：`^=`，从栈中取出两个值，进行计算（位异或），把结果赋值到第一位值中（左）                |
| self-shl-eq | -                | -       | - | 赋值运算符：`<<=`，从栈中取出两个值，进行计算（位左移），把结果赋值到第一位值中（左）               |
| self-shr-eq | -                | -       | - | 赋值运算符：`>>=`，从栈中取出两个值，进行计算（位右移），把结果赋值到第一位值中（左）               |
| self-and-not-eq | -                | -       | - | 赋值运算符：`&^=`，从栈中取出两个值，进行计算（相加），把结果赋值到第一位值中（左）                |
| in | -                | -       | - | 双目运算符：`in` 判断元素是否是包含关系，栈中取两个值，结果压栈                          |
| chan-send | -                | -       | - | 双目运算符，为一个 channel 写入数据                                      |
| type | -                | -       | - | 从栈中取出两个值，必须为类型，为这两个值构建相应的数据类型                               |
| make | 参数数量             | -       | - | 从栈中取出若干个值，创建一个的新的值压入栈，取出 uanry 个参数，根据类型构建新值                 |
| push | -                | 直接压栈的值  | - | 基础压栈操作                                                      |
| pushf | -                | 压栈原值    | - | 把 Op1 的值，进行 fuzztag 运算，并把结果压如栈（Slice）                       |
| range-next | -                | -       | - | 触发 Forange 的下一次循环计数                                         |
| in-next | -                | -       | - | 触发 Forin 的下一次循环计数                                           |
| enter-for-range | 循环次数             | -       | - | 进入 ForEach 循环模式                                             |
| exit-for-range | -                | -       | - | 退出 ForEach 循环模式，判断当前计数栈中值是否大于0，如果不大于零直接退出，否则计数-1            |
| list | 合并值数量            | -       | - | 合并栈中的值的数量                                                   |
| assign | -                | -       | - | 从栈中取两个值，进行赋值操作                                              |
| fast-assign | -                | -       | - | 快速复制，从栈中取一个左值，一个右值，为左值赋值，同时把赋值之后的左值压入栈                      |
| pushr | 符号               | -       | - | 栈中压入一个符号对应的值                                                |
| pushleftr | 符号左值             | -       | - | 栈中压入符号左值                                                    |
| jmp | 跳转位置             | -       | - | 无条件跳转到 Unary                                                |
| jmpt | 跳转位置             | -       | - | 出栈一个值，为 true 时跳转到 uanry                                     |
| jmpf | 跳转位置             | -       | - | 出栈一个值，为 false 时跳转到 uanry                                    |
| jmpt-or-pop | 跳转位置             | -       | - | 查看栈一个值，为 true 时跳转到 uanry，否则出栈                               |
| jmpf-or-pop | 跳转位置             | -       | - | 查看栈一个值，为 false 时跳转到 uanry，否则出栈                              |
| break | 跳转位置             | -       | - | -                                                           |
| continue | 跳转位置             | -       | - | -                                                           |
| call | 参数数量             | -       | - | 出栈 unary，出栈函数，进行调用                                          |
| callvar | 参数数量             | -       | - | 出栈 unary，出栈函数，进行调用（可变参数模式）                                  |
| pushid | -                | 无符号的变量名 | - | 把一个无符号的变量名引入程序中，这个变量名可通过外部注入虚拟机                             |
| pop | -                | -       | - | 普通出栈                                                        |
| newmap | map 大小           | -       | - | 这个指令用于创建一个 map，从栈中取出 unary * 2 个数据，然后俩俩组合，左边为 key 右边为 value |
| newslice | 大小               | -       | - | 用于从栈中创建 Slice，取出 unary 个数据，推断类型，然后组合成 slice                 |
| typedslice | 构建类型限定的 slice 大小 | -       | - | 从栈中创建 Slice，取出 unary 个操作数，再取出 Type，组合成 Slice                |
| iterablecall | -                | -       | - | 调用 Silce 的索引部分                                              | 
| return | -                | -       | - | 函数返回值                                                       |
| defer | -                | -       | - | 设定一组字节码在当前虚拟机结束的时候调用！                                       |
| assert | -                | 错误信息    | - | 出栈，判定栈中值是否为 true，否则 op1 作为错误信息                              |
| membercall | -                | -       | - | 出栈两个参数，第一个为 map 或结构体，获取map或结构体的成员变量或方法                      |
| async-call | -                | -       | - | 异步调用，基本同 call，但是是异步调用的                                      |
| new-scope | 符号表编号            | -       | - | 新建一个定义域                                                     |
| end-scope | -                | -       | - | 结束当前激活的定义域                                                  |
| include | -                | -       | - | 包含一个文件，并执行                                                  |
| panic | -                | -       | - | 主动触发程序崩溃                                                    |
| recover | -                | -       | - | 让程序从崩溃中恢复，把恢复的 panic 推入栈中                                   |
| ellipsis | -                | -       | - | 函数参数是不确定的时候，可以用 ellipsis 拆包                                 |