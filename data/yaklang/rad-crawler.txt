// author: v1ll4n
// json schema 可以用来验证输入
//

params = str.JsonToMap(DATA)
url = str.ParamsGetOr(params, "URL", "")
assert(url != "", "empty url")

urls = str.SplitAndTrim(url, ",")
assert(len(urls) > 0, "empty url")

proxyEntry = f("http://%v", str.HostPort("127.0.0.1", os.GetRandomAvailableTCPPort()))
host, port, err = str.ParseStringToHostPort(proxyEntry)
assertNil(err)

err = mitm.Start(CTX, host, port, fn(isHttps, req, rsp) {
    schema = "http"
    if isHttps {
        schema = "https"
    }

    path = req.URL.Path
    log("crawler view: %s://%v%v", schema, req.Host, path)

    e = db.SaveHTTPRequestAndResponse(isHttps, req, rsp)
    if e != nil {
        log(err.Error())
    }
})
assertNil(err)


for _, url = range urls {
    log("浏览器爬虫开始扫描 %v", url)
    rad, err = GetRadSubProcess(
        CTX,
        "--target", url,
        "--http-proxy", proxyEntry,
    )
    assertNil(err)

    err = rad.Run()
    assertNil(err)

    log("浏览器爬虫完成：%v", url)
    db.GenerateWebsites(CTX, url)
}
