// 威胁情报周汇总

FromSystem = "威胁情报"

dateFmt = "2006-01-02 15"
currentMonday, err = time.GetCurrentMonday()
assertNil(err)

dateEndTime = currentMonday.Add(3600 * Second * 24 * 4 - 3600 * Second * 12)
dateEnd = dateEndTime.Format(dateFmt)
assertNil(err)

dateStartTime = dateEndTime.Add(- 3600 * Second * 24 * 7)
dateStart = dateStartTime.Format(dateFmt)

reportName = f("威胁情报周汇总：%v ~ %v", dateStart, dateEnd)
log(reportName)

report = graph.NewTimelineReport(reportName)

report.AddMarkdownBlock(f(`
# %v

本报告生成最近七天收集网络威胁情报统计数据以及威胁情报快速预览，旨在提供读者对网络安全时间的快速了解以及培养安全意识；

作为安全从业人员，你可以：

1. 了解官方发布/业内媒体/国外国内热点新闻/安全厂商博客更新安全情报
1. 通过本报告，快速预览近期安全事件
1. 运用专业知识快速筛选出有用的情报信息，帮助建设企业安全
1. 学习最新发生的威胁情报中的 EXP/POC，完善自己的安全技能

作为研发人员以及安全爱好者：

1. 了解安全领域实时动态
1. 培养安全意识，扩展视野
1. 一些较新的基本情报信息可以结合自己领域进行自我审查

//
tagsMap = {}
noTags = []
briefings = db.QueryBriefingsByTimestamp(CTX, dateStartTime.Unix(), dateEndTime.Unix())
for b = range briefings {
    if len(b.Tags) <= 0 {
        noTags = append(noTags, b)
        continue
    }

    for _, t = range b.Tags {
        if tagsMap[t] == undefined {
            tagsMap[t] = []
        }

        tagsMap[t] = append(tagsMap[t], b)
    }
}

// 已分类威胁情报汇总
g = graph.NewPieGraph()
for key, vals = range tagsMap {
    if len(vals) <= 1 {
        continue
    }
    g.AddValue(key, len(vals))
}
g.AddValue("未分类", len(noTags))

model, err = graph.CreateGraphModel(
    f("%v: 分类饼图", reportName),
    "", g, TASK_ID,
)
assertNil(err)
err = db.CreateOrUpdateGraph(model)
assertNil(err)

report.AddActiveGraphByName(model.Name)

for tagName, _ = range tagsMap {
    name = f("%v: 分类【%v】", reportName, tagName)
    if str.HasPrefix(tagName, "(") {
        continue
    }
    report.AddAssetRssByTag(name, tagName, dateStartTime.Unix(), dateEndTime.Unix())
}

// 保存 report
err = db.CreateOrUpdateTimelineItem(
    graph.NewTimelinePointItemNow(
        reportName,
        report.ToTimelineItemData(),
    ),
)
assertNil(err)

// 钉钉通知
configName = "threat-intelligence"
ding, err = notify.GetDingRobotByName(configName)
if err != nil {
    log("无法进行dingding同步通知，你可以使用配置：%v 来作为机器人通知配置名称", configName)
    return 0
}

user, pass, err = db.GetOrUpdateThreatIntelligenceInspectorUser()
assertNil(err)
ding.SendMarkdown(f("威胁情报库已更新：%v", reportName), f(`
## 近一周威胁情报周报已更新

点击如下链接进入平台查看¬

[威胁情报Timeline汇总](https://palm-sec.yunshanmeicai.com/timeline-v?outter_user=%v&outter_key=%v)

进行查看所有威胁情报详情
`, user, pass), nil, false)