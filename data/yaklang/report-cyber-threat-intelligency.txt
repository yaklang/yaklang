// 网络威胁情报汇总

FromSystem = "威胁情报"
dateNow = now().Format("2006-01-02")

title = f("网络威胁情报汇总：%v", dateNow)
report = graph.NewTimelineReport(title)

/*

构建威胁情报报告
    1. 最近一周内，新增威胁情报数量，每日的更新
    2. 最近一周内，威胁情报总量
    3. 今日新增威胁情报种类比例（饼图之类的）
    4. 几种关键词的威胁情报内容
    5. (CVE 漏洞库更新时间) 历史 CVE 预警专题（高危 CVE 预警）
*/

report.AddMarkdownBlock(f(`
# %v 网络威胁情报汇总

本报告生成当日最近收集网络威胁情报统计数据以及威胁情报快速预览，旨在提供读者对网络安全时间的快速了解以及培养安全意识；

作为安全从业人员，你可以：

1. 了解官方发布/业内媒体/国外国内热点新闻/安全厂商博客更新安全情报
1. 通过本报告，快速预览近期安全事件
1. 运用专业知识快速筛选出有用的情报信息，帮助建设企业安全
1. 学习最新发生的威胁情报中的 EXP/POC，完善自己的安全技能

作为研发人员以及安全爱好者：

1. 了解安全领域实时动态
1. 培养安全意识，扩展视野
1. 一些较新的基本情报信息可以结合自己领域进行自我审查

|负责人|项目|
|:--:|:--:|
|v1ll4n| OPML 信息源维护，系统研发，信息源筛选，报告维护 |

`, dateNow))


nowDateTime, err = parseTime("2006-01-02", dateNow)
assertNil(err)
lastWeekTs = nowDateTime.Unix() - 24 * 3600 * 7

log("准备生成最近一周内的安全情报威胁动态...")

lineGraph = graph.NewLineGraph()
totalGraph = graph.NewLineGraph()

offsetDay = 1
from = lastWeekTs
oneDayDuration = 24 * 3600
for {
    to = from + oneDayDuration

    for data = range db.QueryBriefingsByTimestamp(CTX, from, to){
        lineGraph.AddPointValue("当日威胁情报数量", from, 1)
    }

    count, err = db.QueryBriefingCountByEndTimestamp(from)
    if count > 0 {
        totalGraph.AddPointValue("当前订阅威胁情报总量", from, count)
    }

    from += oneDayDuration
    if from > NowUnix() {
        count, err = db.QueryBriefingCountByEndTimestamp(from)
        if count > 0 {
            totalGraph.AddPointValue("当前订阅威胁情报总量", from, count)
        }
        break
    }
    offsetDay ++
}

dayNewTiTitle = "最近一周内，每日新增威胁情报动态"
gm, err = graph.CreateGraphModel(dayNewTiTitle, f("最近一周(截止：%v)内，每日新增威胁情报动态", dateNow), lineGraph, TASK_ID)
assertNil(err)
gm.FromSystem = FromSystem

totalTiTitle = "最近一周内，订阅源威胁情报总量动态"
tm, err = graph.CreateGraphModel(totalTiTitle, f("最近一周(截止：%v)内威胁情报总量动态", dateNow), totalGraph, TASK_ID)
assertNil(err)
tm.FromSystem = FromSystem

err = db.CreateOrUpdateGraph(gm)
assertNil(err)
err = db.CreateOrUpdateGraph(tm)
assertNil(err)

report.AddMarkdownBlock(`## 最近一周内，每日新增威胁情报动态`)
report.AddActiveGraphByName(dayNewTiTitle)
report.AddMarkdownBlock(`## 最近一周内，订阅安全威胁情报总量变化动态`)
report.AddActiveGraphByName(totalTiTitle)


log("根据关键词生成分内容展示")
from = nowDateTime.Unix()
to = from + 24 * 3600

// report.AddAssetRssLastOneDay("CVE 披露情况", "title", "search", "title_startswith", true)


// 展示
report.AddMarkdownBlock(`## 威胁情报内容智能数据筛选`)

report.AddAssetRssLastOneDay("工控，内核安全类情报筛选", "", "工控,内核,IoT,iot,IOT,提权,内核漏洞", "", true)
report.AddAssetRssLastOneDay(
    "任意代码执行情报（高危严重漏洞）",
    "",
    "Remote Code Execution,内核安全,"+
    "远程代码执行,任意代码执行,arbitrary code,rbitrary code", "", true,
)
report.AddAssetRssLastOneDay(
    "漏洞/业内/新闻资讯",
    "",
    "漏洞,劫持,研究,罚款,数据安全,逆向,投毒,应急响应"+
    ",蠕虫,攻击,企业安全", "", true,
)
report.AddAssetRssLastOneDay(
    "XSS/SQL注入/CSRF/SSRF等，常见 Web 安全漏洞",
    "",
    "XSS,跨站脚本,SQL注入,SQL 注入,sql injection,SQL Injection,sql注入,sql注入,CSRF,跨站请求伪造,SSRF,Web漏洞," +
    "文件包含,目录遍历,File Includ,file includ,原型污染",
    "", false,
)
report.AddAssetRssLastOneDay(
    "漏洞利用",
    "exploit,Exploit,0day",
    "", "", false,
)

report.AddMarkdownBlock(`## 今日 CVE 披露情报（源：NVD - National Vulnerability Database）等`)
report.AddAssetRssLastOneDay("CVE 披露情况", "", "", "CVE-", false)

// 保存报告信息
item = graph.NewTimelinePointItemNow(title, report.ToTimelineItemData())
item.FromSystem = FromSystem
err = db.CreateOrUpdateTimelineItem(item)
assertNil(err)

// threat-intelligence 通知
configName = "threat-intelligence"
nowTime = now().Format("2006-01-02 15:04")
log("Now: %v", nowTime)

log("本日截止：%v 威胁情报信息已更新", nowTime)
ding, err = notify.GetDingRobotByName(configName)
if err != nil {
    log("无法进行dingding同步通知，你可以使用配置：%v 来作为机器人通知配置名称", configName)
    die(err)
}

user, pass, err = db.GetOrUpdateThreatIntelligenceInspectorUser()
assertNil(err)

nowTs = now().Unix()
sevenDayAgoTs = nowTs - 7 * 24 * 3600
sevenDaysCount, err = db.QueryBriefingCount("", "", "", sevenDayAgoTs, nowTs)
assertNil(err)

todayFrom = nowTs - 3600 * 24
todayCount, err = db.QueryBriefingCount("", "", "", todayFrom, nowTs)
assertNil(err)

todayCveCount, err = db.QueryBriefingCount("", "CVE-", "", todayFrom, nowTs)
assertNil(err)

ding.SendMarkdown(f("威胁情报库已更新：%v", nowTime), f(`
## 近一周（7天）威胁情报总条数: 【%v】

## 本日威胁情报总条数: 【%v】

## 本日CVE更新条目: 【%v】


点击如下链接直接进入平台查看

[威胁情报Timeline汇总](https://palm-sec.yunshanmeicai.com/timeline-v?outter_user=%v&outter_key=%v)

进行查看所有威胁情报日报详情
`, sevenDaysCount, todayCount, todayCveCount, user, pass), nil, false)